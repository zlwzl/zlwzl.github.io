<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">

    <!--[if lt IE 9]>
        <style>body {display: none; background: none !important} </style>
        <meta http-equiv="Refresh" Content="0; url=//outdatedbrowser.com/" />
    <![endif]-->

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="format-detection" content="telephone=no">
<meta name="author" content="Single Dog">


    
    


<meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hexo">

<link rel="apple-touch-icon" href="/apple-touch-icon.png">


    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">



    <link rel="shortcut icon" href="/favicon.png">



    <link href="//cdn.bootcss.com/animate.css/3.5.1/animate.min.css" rel="stylesheet">



    <link href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet">



    <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
    <link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-minimal.css" rel="stylesheet">


<link rel="stylesheet" href="/css/style.css">


    <style> .article { opacity: 0;} </style>


<link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">


<title>Hexo</title>

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>

<script>
    var yiliaConfig = {
        fancybox: true,
        animate: true,
        isHome: true,
        isPost: false,
        isArchive: false,
        isTag: false,
        isCategory: false,
        fancybox_js: "//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js",
        scrollreveal: "//cdn.bootcss.com/scrollReveal.js/3.1.4/scrollreveal.min.js",
        search: 
    }
</script>


    <script>
        yiliaConfig.jquery_ui = [true, "//cdn.bootcss.com/jqueryui/1.10.4/jquery-ui.min.js", "//cdn.bootcss.com/jqueryui/1.10.4/css/jquery-ui.min.css"];
    </script>



    <script> yiliaConfig.rootUrl = "\/";</script>






</head></html>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            <img src="/img/1.jpg" class="animated zoomIn">
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">Single Dog</a></h1>
        </hgroup>

        

        


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">主页</a></li>
                        
                            <li><a href="/archives/">所有文章</a></li>
                        
                            <li><a href="/tags/">标签云</a></li>
                        
                            <li><a href="/about/">关于我</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" href="mailto:123@123.com" title="Email"></a>
                            
                                <a class="fa GitHub" href="#" title="GitHub"></a>
                            
                                <a class="fa RSS" href="/atom.xml" title="RSS"></a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a class="main-nav-link switch-friends-link" href="https://hexo.io">Hexo</a>
                    
                      <a class="main-nav-link switch-friends-link" href="https://pages.github.com/">GitHub</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://moxfive.xyz/">MOxFIVE</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">专注于前端</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">Single Dog</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img src="/img/1.jpg" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">Single Dog</a></h1>
            </hgroup>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">主页</a></li>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/tags/">标签云</a></li>
                
                    <li><a href="/about/">关于我</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" target="_blank" href="mailto:123@123.com" title="Email"></a>
                            
                                <a class="fa GitHub" target="_blank" href="#" title="GitHub"></a>
                            
                                <a class="fa RSS" target="_blank" href="/atom.xml" title="RSS"></a>
                            
                        </ul>
            </nav>
        </header>                
    </div>
    <link class="menu-list" tags="标签" friends="友情链接" about="关于我">
</nav>
      <div class="body-wrap">
  
    <article id="post-my-work0 (10)" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/04/20/my-work0 (10)/" class="article-date">
      <time datetime="2019-04-20T14:58:54.662Z" itemprop="datePublished">2019-04-20</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="第10章-容器管理与容器监控"><a href="#第10章-容器管理与容器监控" class="headerlink" title="第10章-容器管理与容器监控"></a>第10章-容器管理与容器监控</h1><p>学习目标：</p>
<ul>
<li>能够说出Rancher软件的作用，能够在Rancher中部署微服务</li>
<li>能够说出influxDB的作用，能够创建数据库、用户、赋予权限</li>
<li>能够说出cAdvisor 的作用，能够创建容器与influxDB连接</li>
<li>能够说出Grafana 的作用，能够使用Grafana监控容器的内存数据，并配置警告</li>
</ul>
<h1 id="1-容器管理工具Rancher"><a href="#1-容器管理工具Rancher" class="headerlink" title="1 容器管理工具Rancher"></a>1 容器管理工具Rancher</h1><h2 id="1-1-什么是Rancher"><a href="#1-1-什么是Rancher" class="headerlink" title="1.1 什么是Rancher"></a>1.1 什么是Rancher</h2><p>​     Rancher是一个开源的企业级全栈化容器部署及管理平台。Rancher为容器提供一揽子基础架构服务：CNI兼容的网络服务、存储服务、主机管理、负载均衡、防护墙……Rancher让上述服务跨越公有云、私有云、虚拟机、物理机环境运行，真正实现一键式应用部署和管理。</p>
<p>​      <a href="https://www.cnrancher.com/" target="_blank" rel="noopener">https://www.cnrancher.com/</a></p>
<h2 id="1-2-Rancher安装"><a href="#1-2-Rancher安装" class="headerlink" title="1.2 Rancher安装"></a>1.2 Rancher安装</h2><p>（1）下载Rancher 镜像</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull rancher/server</span><br></pre></td></tr></table></figure>
<p>（2）创建Rancher容器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -di --name=rancher --restart=always -p 9090:8080 rancher/server</span><br></pre></td></tr></table></figure>
<p>restart为重启策略</p>
<ul>
<li>no，默认策略，在容器退出时不重启容器</li>
<li>on-failure，在容器非正常退出时（退出状态非0），才会重启容器<ul>
<li>on-failure:3，在容器非正常退出时重启容器，最多重启3次</li>
</ul>
</li>
<li>always，在容器退出时总是重启容器</li>
<li>unless-stopped，在容器退出时总是重启容器，但是不考虑在Docker守护进程启动时就已经停止了的容器</li>
</ul>
<p>（3）在浏览器输入地址： <a href="http://192.168.184.136:9090" target="_blank" rel="noopener">http://192.168.184.136:9090</a>  即可看到高端大气的欢迎页</p>
<p><img src="image/9_31.png" alt></p>
<p>点击Got It  进入主界面</p>
<p><img src="image/9_32.png" alt></p>
<p>（4）切换至中文界面</p>
<p>点击右下角的English 在弹出菜单中选择中文</p>
<p><img src="image/9_33.png" alt></p>
<p>切换后我们就可以看到亲切的中文界面啦~  </p>
<p><img src="image/9_34.png" alt></p>
<h2 id="1-3-Rancher初始化"><a href="#1-3-Rancher初始化" class="headerlink" title="1.3 Rancher初始化"></a>1.3 Rancher初始化</h2><h3 id="1-3-1-添加环境"><a href="#1-3-1-添加环境" class="headerlink" title="1.3.1  添加环境"></a>1.3.1  添加环境</h3><p>Rancher 支持将资源分组归属到多个<strong>环境</strong>。 每个环境具有自己独立的基础架构资源及服务，并由一个或多个用户、团队或组织所管理。</p>
<p>例如，您可以创建独立的“开发”、“测试”及“生产”环境以确保环境之间的安全隔离，将“开发”环境的访问权限赋予全部人员，但限制“生产”环境的访问权限给一个小的团队。</p>
<p>（1）选择“Default –&gt;环境管理” 菜单</p>
<p><img src="image/9_41.png" alt></p>
<p>（2）填写名称，点击“创建”按钮</p>
<p><img src="image/9_42.png" alt></p>
<p>（3）按照上述步骤，添加十次方测试环境和生产环境</p>
<p><img src="image/9_43.png" alt></p>
<p>（4）你可以通过点击logo右侧的菜单在各种环境下切换</p>
<p><img src="image/9_44.png" alt></p>
<h3 id="1-3-2-添加镜像库"><a href="#1-3-2-添加镜像库" class="headerlink" title="1.3.2 添加镜像库"></a>1.3.2 添加镜像库</h3><p>基础架构==&gt;添加镜像库==&gt;Custom==&gt;私有仓库主机地址192.168.184.135</p>
<h3 id="1-3-3-添加主机"><a href="#1-3-3-添加主机" class="headerlink" title="1.3.3 添加主机"></a>1.3.3 添加主机</h3><p>（1）选择基础架构–&gt;主机 菜单，点击添加主机</p>
<p><img src="image/9_46.png" alt></p>
<p>（2）拷贝脚本</p>
<p><img src="image/9_47.png" alt></p>
<p>（3）在服务器（虚拟机）上运行脚本</p>
<p><img src="image/9_48.png" alt></p>
<p>（4）点击关闭按钮后，会看到界面中显示此主机。我们可以很方便地管理主机的每个容器的开启和关闭</p>
<p><img src="image/9_50.png" alt></p>
<h3 id="1-3-4-添加应用"><a href="#1-3-4-添加应用" class="headerlink" title="1.3.4 添加应用"></a>1.3.4 添加应用</h3><p>点击应用–&gt;全部(或用户)  ，点击“添加应用”按钮</p>
<p><img src="image/9_52.png" alt></p>
<p>填写名称和描述</p>
<p><img src="image/9_51.png" alt></p>
<p>点击“创建”按钮，列表中增加了新增的应用</p>
<p><img src="image/9_53.png" alt></p>
<h2 id="1-4-应用部署"><a href="#1-4-应用部署" class="headerlink" title="1.4 应用部署"></a>1.4 应用部署</h2><h3 id="1-4-1-MySQL部署"><a href="#1-4-1-MySQL部署" class="headerlink" title="1.4.1 MySQL部署"></a>1.4.1 MySQL部署</h3><p>镜像：centos/mysql-57-centos7   增加数据库服务</p>
<p><img src="image/10_22.png" alt></p>
<p>注意：添加环境变量  MYSQL_ROOT_PASSWORD=123456 </p>
<p><img src="image/9_63.png" alt></p>
<p>点击创建按钮，完成创建    上述操作相当于以下docker命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -di --name mysql -p 3306:3306 -e MYSQL_ROOT_PASSWORD=123456 centos/mysql-57-centos7</span><br></pre></td></tr></table></figure>
<p><img src="image/10_23.png" alt></p>
<p>完成后服务列表中存在并且状态为激活    使用SQLyog测试链接，执行建表语句</p>
<h3 id="1-4-2-RabbitMQ部署"><a href="#1-4-2-RabbitMQ部署" class="headerlink" title="1.4.2 RabbitMQ部署"></a>1.4.2 RabbitMQ部署</h3><p>镜像：rabbitmq:management     端口映射5671   5672  4369    15671  15672  25672</p>
<p><img src="image/10_24.png" alt></p>
<p>浏览器访问   <a href="http://192.168.184.136:15672/" target="_blank" rel="noopener">http://192.168.184.136:15672/</a></p>
<h3 id="1-4-3-Redis部署-（学员实现）"><a href="#1-4-3-Redis部署-（学员实现）" class="headerlink" title="1.4.3 Redis部署  （学员实现）"></a>1.4.3 Redis部署  （学员实现）</h3><p>进入应用，点击添加服务    名称redis ，镜像redis ，端口映射6379 </p>
<p><img src="image/10_21.png" alt></p>
<p>创建后使用客户端测试链接</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h 192.168.184.136</span><br></pre></td></tr></table></figure>
<p>测试成功</p>
<h3 id="1-4-4-MongoDB部署（学员实现）"><a href="#1-4-4-MongoDB部署（学员实现）" class="headerlink" title="1.4.4 MongoDB部署（学员实现）"></a>1.4.4 MongoDB部署（学员实现）</h3><p>名称mongo  镜像mongo    端口映射27017 </p>
<h3 id="1-4-5-ElasticSearch部署（学员实现）"><a href="#1-4-5-ElasticSearch部署（学员实现）" class="headerlink" title="1.4.5 ElasticSearch部署（学员实现）"></a>1.4.5 ElasticSearch部署（学员实现）</h3><p>名称elasticsearch   镜像elasticsearch:5.6.8  端口映射9300   9200</p>
<p>添加后，浏览器测试： <a href="http://192.168.184.136:9200/" target="_blank" rel="noopener">http://192.168.184.136:9200/</a></p>
<h2 id="1-5-微服务容器部署"><a href="#1-5-微服务容器部署" class="headerlink" title="1.5 微服务容器部署"></a>1.5 微服务容器部署</h2><h3 id="1-5-1-Eureka微服务容器化部署"><a href="#1-5-1-Eureka微服务容器化部署" class="headerlink" title="1.5.1 Eureka微服务容器化部署"></a>1.5.1 Eureka微服务容器化部署</h3><p>（1）在用户应用界面中点击“添加服务”  </p>
<p><img src="image/9_54.png" alt></p>
<p>（2）填写名称、描述、镜像和端口映射，点击创建按钮</p>
<p>名称eureka  镜像  192.168.184.135:5000/tensquare_eureka:1.0-SNAPSHOT </p>
<p><img src="image/9_57.png" alt></p>
<p>（3）服务添加成功</p>
<p><img src="image/9_58.png" alt></p>
<p>（4）我们现在访问以下我们的系统</p>
<p><a href="http://192.168.184.136:6868/" target="_blank" rel="noopener">http://192.168.184.136:6868/</a>  可以正常访问</p>
<h3 id="1-5-2-配置中心微服务部署"><a href="#1-5-2-配置中心微服务部署" class="headerlink" title="1.5.2 配置中心微服务部署"></a>1.5.2 配置中心微服务部署</h3><p>创建容器</p>
<p>添加服务config  镜像  192.168.184.135:5000/tensquare_config:1.0-SNAPSHOT  </p>
<p>映射端口：12000</p>
<p>测试 浏览器输入 <a href="http://192.168.184.135:12000/base-dev.yml" target="_blank" rel="noopener">http://192.168.184.135:12000/base-dev.yml</a>  可以查看到配置文件内容</p>
<h3 id="1-5-3-基础微服务部署"><a href="#1-5-3-基础微服务部署" class="headerlink" title="1.5.3 基础微服务部署"></a>1.5.3 基础微服务部署</h3><p>（1）添加服务base-service   镜像tensquare_base:1.0-SNAPSHOT    端口映射9001</p>
<p><img src="image/9_67.png" alt></p>
<p>（2）测试微服务  浏览器打开网址  <a href="http://192.168.184.136:9001/label" target="_blank" rel="noopener">http://192.168.184.136:9001/label</a>   看是否可以看到标签列表</p>
<h2 id="1-6-扩容与缩容"><a href="#1-6-扩容与缩容" class="headerlink" title="1.6 扩容与缩容"></a>1.6 扩容与缩容</h2><h3 id="1-6-1-扩容"><a href="#1-6-1-扩容" class="headerlink" title="1.6.1 扩容"></a>1.6.1 扩容</h3><p>（1）在Rancher将创建的base-service（基础信息微服务）删除</p>
<p>（2）重新创建base-service ，不设置端口映射</p>
<p><img src="image/10_01.png" alt></p>
<p>（3）在选择菜单API  –&gt;WebHooks  ，点击“添加接收器”按钮</p>
<p><img src="image/9_68.png" alt></p>
<p>（4）填写名称等信息，选择要扩容的服务，点击创建按钮</p>
<p><img src="image/10_05.png" alt></p>
<p>（5）接收器列表中新增了一条记录  ，点击触发地址将地址复制到剪切板</p>
<p><img src="image/10_06.png" alt></p>
<p>（6）使用postman测试：</p>
<p><img src="image/10_07.png" alt></p>
<p>测试后，发现容器由原来的1个变为了3个</p>
<p><img src="image/10_08.png" alt></p>
<p>打开erueka，发现服务也有3个</p>
<p><img src="image/10_09.png" alt></p>
<h3 id="1-6-2-缩容"><a href="#1-6-2-缩容" class="headerlink" title="1.6.2 缩容"></a>1.6.2 缩容</h3><p>刚才我们实现了扩容，那么如何减少容器数量呢？我们来试试如何缩容</p>
<p>（1）添加接收器  ,选择缩容，步长为1表示每次递减1个 ，点击创建按钮</p>
<p><img src="image/10_10.png" alt></p>
<p>（2）创建成功后，复制触发地址</p>
<p><img src="image/10_11.png" alt></p>
<p>（3）使用postman测试</p>
<p><img src="image/10_12.png" alt></p>
<h1 id="2-influxDB"><a href="#2-influxDB" class="headerlink" title="2 influxDB"></a>2 influxDB</h1><h2 id="2-1-什么是influxDB"><a href="#2-1-什么是influxDB" class="headerlink" title="2.1 什么是influxDB"></a>2.1 什么是influxDB</h2><p>​    influxDB是一个分布式时间序列数据库。cAdvisor仅仅显示实时信息，但是不存储监视数据。因此，我们需要提供时序数据库用于存储cAdvisor组件所提供的监控信息，以便显示除实时信息之外的时序数据。</p>
<h2 id="2-2-influxDB安装"><a href="#2-2-influxDB安装" class="headerlink" title="2.2 influxDB安装"></a>2.2 influxDB安装</h2><p>（1）下载镜像</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull tutum/influxdb</span><br></pre></td></tr></table></figure>
<p>（2）创建容器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker run -di \</span><br><span class="line">   -p 8083:8083 \</span><br><span class="line">   -p 8086:8086 \</span><br><span class="line">   --expose 8090 \</span><br><span class="line">   --expose 8099 \</span><br><span class="line">   --name influxsrv \</span><br><span class="line">   tutum/influxdb</span><br></pre></td></tr></table></figure>
<p>端口概述：  8083端口:web访问端口     8086:数据写入端口</p>
<p>打开浏览器   <a href="http://192.168.229.128:8083/" target="_blank" rel="noopener">http://192.168.184.135:8083/</a></p>
<p><img src="image/10_71.png" alt></p>
<h2 id="2-3-influxDB常用操作"><a href="#2-3-influxDB常用操作" class="headerlink" title="2.3 influxDB常用操作"></a>2.3 influxDB常用操作</h2><h3 id="2-3-1-创建数据库"><a href="#2-3-1-创建数据库" class="headerlink" title="2.3.1 创建数据库"></a>2.3.1 创建数据库</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CREATE DATABASE &quot;cadvisor&quot;</span><br></pre></td></tr></table></figure>
<p>回车创建数据库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW DATABASES</span><br></pre></td></tr></table></figure>
<p>查看数据库</p>
<h3 id="2-3-2-创建用户并授权"><a href="#2-3-2-创建用户并授权" class="headerlink" title="2.3.2 创建用户并授权"></a>2.3.2 创建用户并授权</h3><p>创建用户</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CREATE USER &quot;cadvisor&quot; WITH PASSWORD &apos;cadvisor&apos; WITH ALL PRIVILEGES</span><br></pre></td></tr></table></figure>
<p>查看用户</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW USRES</span><br></pre></td></tr></table></figure>
<p>用户授权</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">grant all privileges on cadvisor to cadvisor</span><br><span class="line">grant WRITE on cadvisor to cadvisor</span><br><span class="line">grant READ on cadvisor to cadvisor</span><br></pre></td></tr></table></figure>
<h3 id="2-3-3-查看采集的数据"><a href="#2-3-3-查看采集的数据" class="headerlink" title="2.3.3 查看采集的数据"></a>2.3.3 查看采集的数据</h3><p>切换到cadvisor数据库，使用以下命令查看采集的数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW MEASUREMENTS</span><br></pre></td></tr></table></figure>
<p>现在我们还没有数据，如果想采集系统的数据，我们需要使用<strong>Cadvisor</strong>软件来实现</p>
<h1 id="3-cAdvisor"><a href="#3-cAdvisor" class="headerlink" title="3 cAdvisor"></a>3 cAdvisor</h1><h2 id="3-1-什么是cAdvisor"><a href="#3-1-什么是cAdvisor" class="headerlink" title="3.1 什么是cAdvisor"></a>3.1 什么是cAdvisor</h2><p>​    Google开源的用于监控基础设施应用的工具，它是一个强大的监控工具，不需要任何配置就可以通过运行在Docker主机上的容器来监控Docker容器，而且可以监控Docker主机。更多详细操作和配置选项可以查看Github上的cAdvisor项目文档。</p>
<h2 id="3-2-cAdvisor安装"><a href="#3-2-cAdvisor安装" class="headerlink" title="3.2 cAdvisor安装"></a>3.2 cAdvisor安装</h2><p>（1）下载镜像</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull google/cadvisor</span><br></pre></td></tr></table></figure>
<p>（2）创建容器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --volume=/:/rootfs:ro --volume=/var/run:/var/run:rw --volume=/sys:/sys:ro --volume=/var/lib/docker/:/var/lib/docker:ro --publish=8080:8080 --detach=true --link influxsrv:influxsrv --name=cadvisor google/cadvisor -storage_driver=influxdb -storage_driver_db=cadvisor -storage_driver_host=influxsrv:8086</span><br></pre></td></tr></table></figure>
<p>WEB前端访问地址</p>
<p><a href="http://192.168.184.135:8080/containers/" target="_blank" rel="noopener">http://192.168.184.135:8080/containers/</a></p>
<p>性能指标含义参照如下地址</p>
<p><a href="https://blog.csdn.net/ZHANG_H_A/article/details/53097084" target="_blank" rel="noopener">https://blog.csdn.net/ZHANG_H_A/article/details/53097084</a></p>
<p>再次查看influxDB，发现已经有很多数据被采集进去了。</p>
<h1 id="4-Grafana"><a href="#4-Grafana" class="headerlink" title="4 Grafana"></a>4 Grafana</h1><h2 id="4-1-什么是Grafana"><a href="#4-1-什么是Grafana" class="headerlink" title="4.1 什么是Grafana"></a>4.1 什么是Grafana</h2><p>​    Grafana是一个可视化面板（Dashboard），有着非常漂亮的图表和布局展示，功能齐全的度量仪表盘和图形编辑器。支持Graphite、zabbix、InfluxDB、Prometheus和OpenTSDB作为数据源。<br>Grafana主要特性：灵活丰富的图形化选项；可以混合多种风格；支持白天和夜间模式；多个数据源。</p>
<h2 id="4-2-Grafana安装"><a href="#4-2-Grafana安装" class="headerlink" title="4.2 Grafana安装"></a>4.2 Grafana安装</h2><p>（1）下载镜像</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull grafana/grafana</span><br></pre></td></tr></table></figure>
<p>（2）创建容器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 3001:3000  -e INFLUXDB_HOST=influxsrv -e INFLUXDB_PORT=8086 -e INFLUXDB_NAME=cadvisor -e INFLUXDB_USER=cadvisor -e INFLUXDB_PASS=cadvisor --link influxsrv:influxsrv --name grafana grafana/grafana</span><br></pre></td></tr></table></figure>
<p>（3）访问</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.184.135:3001</span><br></pre></td></tr></table></figure>
<p>用户名密码均为admin</p>
<p><img src="image/10_41.png" alt></p>
<p>（4）登录后提示你修改密码</p>
<p><img src="image/10_42.png" alt></p>
<p>（5）之后进入主页面</p>
<p><img src="image/10_43.png" alt></p>
<h2 id="4-3-Grafana的使用"><a href="#4-3-Grafana的使用" class="headerlink" title="4.3 Grafana的使用"></a>4.3 Grafana的使用</h2><h3 id="4-3-1-添加数据源"><a href="#4-3-1-添加数据源" class="headerlink" title="4.3.1 添加数据源"></a>4.3.1 添加数据源</h3><p>（1）点击设置，DataSource </p>
<p><img src="image/10_44.png" alt></p>
<p>（2）点击添加data source</p>
<p><img src="image/10_45.png" alt></p>
<p>（3）为数据源起个名称，指定类型、地址、以及连接的数据库名、用户名和密码</p>
<p><img src="image/10_46.png" alt></p>
<p>点击保存。数据源建立成功</p>
<p><img src="image/10_47.png" alt></p>
<h3 id="4-3-2-添加仪表盘"><a href="#4-3-2-添加仪表盘" class="headerlink" title="4.3.2 添加仪表盘"></a>4.3.2 添加仪表盘</h3><p>（1）选择Dashboards –Manager  </p>
<p><img src="image/10_48.png" alt></p>
<p>（2）点击“添加”按钮</p>
<p>（3）点击Graph  图标</p>
<p><img src="image/10_49.png" alt></p>
<p>（4）出现下面图表的界面 ，点击Panel Title  选择Edit (编辑)</p>
<p><img src="image/10_51.png" alt></p>
<p>（5）定义标题等基础信息</p>
<p><img src="image/10_52.png" alt></p>
<p>（6）设置查询的信息为内存，指定容器名称</p>
<p><img src="image/10_53.png" alt></p>
<p>（7）指定y轴的单位 为M</p>
<p><img src="image/10_54.png" alt></p>
<p>（8）保存</p>
<p><img src="image/10_55.png" alt></p>
<p>填写名称</p>
<p><img src="image/10_56.png" alt></p>
<h3 id="4-4-3-预警通知设置"><a href="#4-4-3-预警通知设置" class="headerlink" title="4.4.3 预警通知设置"></a>4.4.3 预警通知设置</h3><p>（1）选择菜单  alerting–&gt; Notification channels</p>
<p><img src="image/10_57.png" alt></p>
<p>（2）点击Add channel 按钮</p>
<p><img src="image/10_58.png" alt></p>
<p>（3）填写名称，选择类型为webhook  ,填写钩子地址</p>
<p><img src="image/10_59.png" alt></p>
<p>这个钩子地址是之前对base微服务扩容的地址</p>
<p><img src="image/10_60.png" alt></p>
<p>（4）点击SendTest  测试  观察基础微服务是否增加容器</p>
<p>（5）点击save保存</p>
<p>（6）按照同样的方法添加缩容地址</p>
<h3 id="4-4-4-仪表盘预警设置"><a href="#4-4-4-仪表盘预警设置" class="headerlink" title="4.4.4 仪表盘预警设置"></a>4.4.4 仪表盘预警设置</h3><p>（1）再次打开刚刚编辑的仪表盘</p>
<p><img src="image/10_61.png" alt></p>
<p>（2）点击 Create Alert </p>
<p><img src="image/10_62.png" alt></p>
<p>设置预警线</p>
<p>（3）选择通知</p>
<p><img src="image/10_63.png" alt></p>
<p><img src="image/10_64.png" alt></p>
<p>保存更改</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-my-work0 (9)" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/04/20/my-work0 (9)/" class="article-date">
      <time datetime="2019-04-20T14:58:54.649Z" itemprop="datePublished">2019-04-20</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="第9章-微服务容器部署与持续集成"><a href="#第9章-微服务容器部署与持续集成" class="headerlink" title="第9章-微服务容器部署与持续集成"></a>第9章-微服务容器部署与持续集成</h1><p>学习目标：</p>
<ul>
<li>理解Dockerfile的作用，能编写简单的Dockerfile脚本完成镜像的构建</li>
<li>完成Docker私有仓库的构建，能够运用Maven插件完成镜像的创建与上传</li>
<li>理解持续集成，说出持续集成的作用</li>
<li>能够完成Gogs 的安装与配置，完成代码的提交</li>
<li>能够使用Jenkins完成代码的持续集成</li>
</ul>
<h1 id="1-Dockerfile"><a href="#1-Dockerfile" class="headerlink" title="1 Dockerfile"></a>1 Dockerfile</h1><h2 id="1-1-什么是Dockerfile"><a href="#1-1-什么是Dockerfile" class="headerlink" title="1.1 什么是Dockerfile"></a>1.1 什么是Dockerfile</h2><p>Dockerfile是由一系列命令和参数构成的脚本，这些命令应用于基础镜像并最终创建一个新的镜像。</p>
<p>1、对于开发人员：可以为开发团队提供一个完全一致的开发环境；<br>2、对于测试人员：可以直接拿开发时所构建的镜像或者通过Dockerfile文件构建一个新的镜像开始工作了；<br>3、对于运维人员：在部署时，可以实现应用的无缝移植。</p>
<h2 id="1-2-常用命令"><a href="#1-2-常用命令" class="headerlink" title="1.2 常用命令"></a>1.2 常用命令</h2><table>
<thead>
<tr>
<th>命令</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>FROM image_name:tag</td>
<td>定义了使用哪个基础镜像启动构建流程</td>
</tr>
<tr>
<td>MAINTAINER user_name</td>
<td>声明镜像的创建者</td>
</tr>
<tr>
<td>ENV key value</td>
<td>设置环境变量 (可以写多条)</td>
</tr>
<tr>
<td>RUN command</td>
<td>是Dockerfile的核心部分(可以写多条)</td>
</tr>
<tr>
<td>ADD source_dir/file dest_dir/file</td>
<td>将宿主机的文件复制到容器内，如果是一个压缩文件，将会在复制后自动解压</td>
</tr>
<tr>
<td>COPY source_dir/file dest_dir/file</td>
<td>和ADD相似，但是如果有压缩文件并不能解压</td>
</tr>
<tr>
<td>WORKDIR path_dir</td>
<td>设置工作目录</td>
</tr>
<tr>
<td>EXPOSE port1 prot2</td>
<td>用来指定端口，使容器内的应用可以通过端口和外界交互</td>
</tr>
<tr>
<td>CMD argument</td>
<td>在构建容器时使用，会被docker run 后的argument覆盖</td>
</tr>
<tr>
<td>ENTRYPOINT argument</td>
<td>和CMD相似，但是并不会被docker run指定的参数覆盖</td>
</tr>
<tr>
<td>VOLUME</td>
<td>将本地文件夹或者其他容器的文件挂载到容器中</td>
</tr>
</tbody>
</table>
<h2 id="1-3-使用脚本创建镜像"><a href="#1-3-使用脚本创建镜像" class="headerlink" title="1.3 使用脚本创建镜像"></a>1.3 使用脚本创建镜像</h2><p>步骤：</p>
<p>（1）创建目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir –p /usr/local/java</span><br></pre></td></tr></table></figure>
<p>（2）下载jdk-8u171-linux-x64.tar.gz并上传到服务器（虚拟机）中的/usr/local/java目录</p>
<p>（3）创建文件Dockerfile  <code>vi Dockerfile</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#依赖镜像名称和ID</span><br><span class="line">FROM centos:7</span><br><span class="line">#指定镜像创建者信息</span><br><span class="line">MAINTAINER ITCAST</span><br><span class="line">#切换工作目录</span><br><span class="line">WORKDIR /usr</span><br><span class="line">RUN mkdir  /usr/local/java</span><br><span class="line">#ADD 是相对路径jar,把java添加到容器中</span><br><span class="line">ADD jdk-8u171-linux-x64.tar.gz /usr/local/java/</span><br><span class="line"></span><br><span class="line">#配置java环境变量</span><br><span class="line">ENV JAVA_HOME /usr/local/java/jdk1.8.0_171</span><br><span class="line">ENV JRE_HOME $JAVA_HOME/jre</span><br><span class="line">ENV CLASSPATH $JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar:$JRE_HOME/lib:$CLASSPATH</span><br><span class="line">ENV PATH $JAVA_HOME/bin:$PATH</span><br></pre></td></tr></table></figure>
<p>（4）执行命令构建镜像</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t=&apos;jdk1.8&apos; .</span><br></pre></td></tr></table></figure>
<p>注意后边的空格和点，不要省略</p>
<p><img src="image/9_80.png" alt></p>
<p>（5）查看镜像是否建立完成</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker images</span><br></pre></td></tr></table></figure>
<p>（6）创建容器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --name=myjdk8 jdk1.8 /bin/bash</span><br></pre></td></tr></table></figure>
<p>果然可以创建哟~</p>
<h1 id="2-Docker私有仓库"><a href="#2-Docker私有仓库" class="headerlink" title="2 Docker私有仓库"></a>2 Docker私有仓库</h1><h2 id="2-1-私有仓库搭建与配置"><a href="#2-1-私有仓库搭建与配置" class="headerlink" title="2.1 私有仓库搭建与配置"></a>2.1 私有仓库搭建与配置</h2><p>（1）拉取私有仓库镜像（此步省略）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull registry</span><br></pre></td></tr></table></figure>
<p>（2）启动私有仓库容器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -di --name=registry -p 5000:5000 镜像id</span><br></pre></td></tr></table></figure>
<p>（3）打开浏览器 输入地址<a href="http://192.168.184.135:5000/v2/_catalog看到`{&quot;repositories&quot;:[]}`" target="_blank" rel="noopener">http://192.168.184.135:5000/v2/_catalog看到`{&quot;repositories&quot;:[]}`</a> 表示私有仓库搭建成功并且内容为空</p>
<p>（4）修改daemon.json</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/docker/daemon.json</span><br></pre></td></tr></table></figure>
<p>添加以下内容，保存退出。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"insecure-registries"</span>:[<span class="string">"192.168.184.135:5000"</span>]&#125;</span><br></pre></td></tr></table></figure>
<p>此步用于让 docker信任私有仓库地址</p>
<p>（5）重启docker 服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure>
<h2 id="2-2-镜像上传至私有仓库"><a href="#2-2-镜像上传至私有仓库" class="headerlink" title="2.2 镜像上传至私有仓库"></a>2.2 镜像上传至私有仓库</h2><p>（1）标记此镜像为私有仓库的镜像</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker tag jdk1.8 192.168.184.135:5000/jdk1.8</span><br></pre></td></tr></table></figure>
<p>（2）再次启动私服容器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker start registry</span><br></pre></td></tr></table></figure>
<p>（3）上传标记的镜像</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker push 192.168.184.135:5000/jdk1.8</span><br></pre></td></tr></table></figure>
<h2 id="2-3-DockerMaven插件"><a href="#2-3-DockerMaven插件" class="headerlink" title="2.3 DockerMaven插件"></a>2.3 DockerMaven插件</h2><p>微服务部署有两种方法：</p>
<p>（1）手动部署：首先基于源码打包生成jar包（或war包）,将jar包（或war包）上传至虚拟机并拷贝至JDK容器。</p>
<p>（2）通过Maven插件自动部署。</p>
<p>对于数量众多的微服务，手动部署无疑是非常麻烦的做法，并且容易出错。所以我们这里学习如何自动部署，这也是企业实际开发中经常使用的方法。</p>
<p>Maven插件自动部署步骤：</p>
<p>（1）修改宿主机的docker配置，让其可以远程访问</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /lib/systemd/system/docker.service</span><br></pre></td></tr></table></figure>
<p>其中ExecStart=后添加配置<code>-H tcp://0.0.0.0:2375 -H unix:///var/run/docker.sock</code></p>
<p>修改后如下：</p>
<p><img src="image/9_17.png" alt></p>
<p>（2）刷新配置，重启服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br><span class="line">docker start registry</span><br></pre></td></tr></table></figure>
<p>（3）在tensquare_eureka工程pom.xml 增加配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"> <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>app<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- docker的maven插件，官网：https://github.com/spotify/docker-maven-plugin --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.spotify<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>docker-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.4.13<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">imageName</span>&gt;</span>192.168.184.135:5000/$&#123;project.artifactId&#125;:$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">imageName</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">baseImage</span>&gt;</span>jdk1.8<span class="tag">&lt;/<span class="name">baseImage</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">entryPoint</span>&gt;</span>["java", "-jar", "/$&#123;project.build.finalName&#125;.jar"]<span class="tag">&lt;/<span class="name">entryPoint</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">targetPath</span>&gt;</span>/<span class="tag">&lt;/<span class="name">targetPath</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">directory</span>&gt;</span>$&#123;project.build.directory&#125;<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">include</span>&gt;</span>$&#123;project.build.finalName&#125;.jar<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">dockerHost</span>&gt;</span>http://192.168.184.135:2375<span class="tag">&lt;/<span class="name">dockerHost</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>以上配置会自动生成Dockerfile</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FROM jdk1.8</span><br><span class="line">ADD app.jar /</span><br><span class="line">ENTRYPOINT [&quot;java&quot;,&quot;-jar&quot;,&quot;/app.jar&quot;]</span><br></pre></td></tr></table></figure>
<p>（5）在windows的命令提示符下，进入tensquare_eureka工程所在的目录，输入以下命令，进行打包和上传镜像</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn clean package docker:build  -DpushImage</span><br></pre></td></tr></table></figure>
<p>执行后，会有如下输出，代码正在上传</p>
<p><img src="image/9_81.png" alt></p>
<p>浏览器访问  <a href="http://192.168.184.135:5000/v2/_catalog" target="_blank" rel="noopener">http://192.168.184.135:5000/v2/_catalog</a>  ，输出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;repositories&quot;:[&quot;tensquare_eureka&quot;]&#125;</span><br></pre></td></tr></table></figure>
<p>（6）进入宿主机 , 查看镜像</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker images</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">REPOSITORY                              TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">192.168.184.135:5000/tensquare_eureka   1.0-SNAPSHOT        83efa6b4478c        10 minutes ago      687.9 MB</span><br><span class="line">192.168.184.135:5000/jdk1.8             latest              507438a0158f        6 hours ago         584 MB</span><br><span class="line">jdk1.8                                  latest              507438a0158f        6 hours ago         584 MB</span><br></pre></td></tr></table></figure>
<p>输出如上内容，表示tensquare_eureka微服务已经做成镜像</p>
<p>（7） 启动容器：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -di --name=eureka -p 6868:6868 192.168.184.135:5000/tensquare_eureka:1.0-SNAPSHOT</span><br></pre></td></tr></table></figure>
<h1 id="3-理解持续集成"><a href="#3-理解持续集成" class="headerlink" title="3 理解持续集成"></a>3 理解持续集成</h1><h2 id="3-1-什么是持续集成"><a href="#3-1-什么是持续集成" class="headerlink" title="3.1 什么是持续集成"></a>3.1 什么是持续集成</h2><p>​    持续集成   Continuous integration ，简称CI    </p>
<p>​    随着软件开发复杂度的不断提高，团队开发成员间如何更好地协同工作以确保软件开发的质量已经慢慢成为开发过程中不可回避的问题。尤其是近些年来，敏捷（Agile） 在软件工程领域越来越红火，如何能再不断变化的需求中快速适应和保证软件的质量也显得尤其的重要。</p>
<p>​    持续集成正是针对这一类问题的一种软件开发实践。它倡导团队开发成员必须经常集成他们的工作，甚至每天都可能发生多次集成。而每次的集成都是通过自动化的构建来验证，包括自动编译、发布和测试，从而尽快地发现集成错误，让团队能够更快的开发内聚的软件。</p>
<h2 id="3-2-持续集成的特点"><a href="#3-2-持续集成的特点" class="headerlink" title="3.2 持续集成的特点"></a>3.2 持续集成的特点</h2><ul>
<li>它是一个自动化的周期性的集成测试过程，从检出代码、编译构建、运行测试、结果记录、测试统计等都是自动完成的，无需人工干预；</li>
<li>需要有专门的集成服务器来执行集成构建；</li>
<li>需要有代码托管工具支持，我们下一小节将介绍Git以及可视化界面Gogs的使用</li>
</ul>
<h2 id="3-3-持续集成作用"><a href="#3-3-持续集成作用" class="headerlink" title="3.3 持续集成作用"></a>3.3 持续集成作用</h2><ul>
<li>保证团队开发人员提交代码的质量，减轻了软件发布时的压力；</li>
<li>持续集成中的任何一个环节都是自动完成的，无需太多的人工干预，有利于减少重复过程以节省时间、费用和工作量；</li>
</ul>
<h1 id="4-Gogs"><a href="#4-Gogs" class="headerlink" title="4 Gogs"></a>4 Gogs</h1><h2 id="4-1-什么是Gogs"><a href="#4-1-什么是Gogs" class="headerlink" title="4.1 什么是Gogs"></a>4.1 什么是Gogs</h2><p>Gogs 是一款极易搭建的自助 Git 服务。</p>
<p>Gogs 的目标是打造一个最简单、最快速和最轻松的方式搭建自助 Git 服务。使用 Go 语言开发使得 Gogs 能够通过独立的二进制分发，并且支持 Go 语言支持的 <strong>所有平台</strong>，包括 Linux、Mac OS X、Windows 以及 ARM 平台。</p>
<p>地址：<a href="https://gitee.com/Unknown/gogs" target="_blank" rel="noopener">https://gitee.com/Unknown/gogs</a></p>
<h2 id="4-2-Gogs安装与配置"><a href="#4-2-Gogs安装与配置" class="headerlink" title="4.2 Gogs安装与配置"></a>4.2 Gogs安装与配置</h2><h3 id="4-2-1-安装"><a href="#4-2-1-安装" class="headerlink" title="4.2.1 安装"></a>4.2.1 安装</h3><p>（1）下载镜像</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull gogs/gogs</span><br></pre></td></tr></table></figure>
<p>（2）创建容器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name=gogs -p 10022:22 -p 3000:3000 -v /var/gogsdata:/data gogs/gogs</span><br></pre></td></tr></table></figure>
<h3 id="4-2-2-配置"><a href="#4-2-2-配置" class="headerlink" title="4.2.2 配置"></a>4.2.2 配置</h3><p>假设我的centos虚拟机IP为192.168.184.135  完成以下步骤</p>
<p>（1）在地址栏输入<a href="http://192.168.184.135:3000" target="_blank" rel="noopener">http://192.168.184.135:3000</a>  会进入首次运行安装程序页面，我们可以选择一种数据库作为gogs数据的存储，最简单的是选择SQLite3。如果对于规模较大的公司，可以选择MySQL  </p>
<p><img src="image/9_82.png" alt></p>
<p><img src="image/9_83.png" alt> </p>
<p>点击“立即安装”</p>
<p>这里的域名要设置为centos的IP地址,安装后显示主界面</p>
<p><img src="image/8_5.png" alt></p>
<p>（2）注册</p>
<p><img src="image/8_6.png" alt></p>
<p>（3）登录</p>
<p><img src="image/8_9.png" alt></p>
<p>（4）创建仓库 <img src="image/8_1.png" alt="创建仓库"></p>
<p><img src="image/9_84.png" alt></p>
<h2 id="4-3-IDEA配置Git"><a href="#4-3-IDEA配置Git" class="headerlink" title="4.3 IDEA配置Git"></a>4.3 IDEA配置Git</h2><p>步骤：</p>
<p>（1）在本地安装git(Windows版本)</p>
<p>（2）在IDEA中选择菜单 :  File – settings ,  在窗口中选择Version Control –  Git</p>
<p><img src="image/8_2.png" alt></p>
<h2 id="4-4-将十次方代码提交到Git"><a href="#4-4-将十次方代码提交到Git" class="headerlink" title="4.4 将十次方代码提交到Git"></a>4.4 将十次方代码提交到Git</h2><p>（1）选择菜单VCS  –&gt; Enable Version Control Integration… </p>
<p><img src="image/8_3.png" alt></p>
<p>选择Git</p>
<p>（2）设置远程地址:  右键点击工程选择菜单    Git –&gt; Repository   –&gt;Remotes…</p>
<p><img src="image/8_4.png" alt></p>
<p><img src="image/9_85.png" alt></p>
<p>（3）右键点击工程选择菜单    Git –&gt; Add</p>
<p>（4）右键点击工程选择菜单    Git –&gt; Commit Directory…</p>
<p>（5）右键点击工程选择菜单    Git –&gt; Repository   –&gt; Push …</p>
<h1 id="5-运用Jenkins实现持续集成"><a href="#5-运用Jenkins实现持续集成" class="headerlink" title="5 运用Jenkins实现持续集成"></a>5 运用Jenkins实现持续集成</h1><h2 id="5-1-Jenkins简介"><a href="#5-1-Jenkins简介" class="headerlink" title="5.1 Jenkins简介"></a>5.1 Jenkins简介</h2><p>​    Jenkins，原名Hudson，2011年改为现在的名字，它 是一个开源的实现持续集成的软件工具。官方网站：<a href="http://jenkins-ci.org/" target="_blank" rel="noopener">http://jenkins-ci.org/</a>。</p>
<p>​    Jenkins 能实施监控集成中存在的错误，提供详细的日志文件和提醒功能，还能用图表的形式形象地展示项目构建的趋势和稳定性。</p>
<p>​    特点：</p>
<ul>
<li>易安装：仅仅一个 java -jar jenkins.war，从官网下载该文件后，直接运行，无需额外的安装，更无需安装数据库；</li>
<li>易配置：提供友好的GUI配置界面；</li>
<li>变更支持：Jenkins能从代码仓库（Subversion/CVS）中获取并产生代码更新列表并输出到编译输出信息中；</li>
<li>支持永久链接：用户是通过web来访问Jenkins的，而这些web页面的链接地址都是永久链接地址，因此，你可以在各种文档中直接使用该链接；</li>
<li>集成E-Mail/RSS/IM：当完成一次集成时，可通过这些工具实时告诉你集成结果（据我所知，构建一次集成需要花费一定时间，有了这个功能，你就可以在等待结果过程中，干别的事情）；</li>
<li>JUnit/TestNG测试报告：也就是用以图表等形式提供详细的测试报表功能；</li>
<li>支持分布式构建：Jenkins可以把集成构建等工作分发到多台计算机中完成；</li>
<li>文件指纹信息：Jenkins会保存哪次集成构建产生了哪些jars文件，哪一次集成构建使用了哪个版本的jars文件等构建记录；</li>
<li>支持第三方插件：使得 Jenkins 变得越来越强大</li>
</ul>
<h2 id="5-2-Jenkins安装"><a href="#5-2-Jenkins安装" class="headerlink" title="5.2 Jenkins安装"></a>5.2 Jenkins安装</h2><h3 id="5-2-1-JDK安装-此步略"><a href="#5-2-1-JDK安装-此步略" class="headerlink" title="5.2.1 JDK安装(此步略)"></a>5.2.1 JDK安装(此步略)</h3><p>（1）将jdk-8u171-linux-x64.rpm上传至服务器（虚拟机）</p>
<p>（2）执行安装命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -ivh jdk-8u171-linux-x64.rpm</span><br></pre></td></tr></table></figure>
<p>RPM方式安装JDK，其根目录为：/usr/java/jdk1.8.0_171t</p>
<h3 id="5-2-2-Jenkins安装与启动"><a href="#5-2-2-Jenkins安装与启动" class="headerlink" title="5.2.2 Jenkins安装与启动"></a>5.2.2 Jenkins安装与启动</h3><p>（1）下载jenkins</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://pkg.jenkins.io/redhat/jenkins-2.83-1.1.noarch.rpm</span><br></pre></td></tr></table></figure>
<p>（2）安装jenkins</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -ivh jenkins-2.83-1.1.noarch.rpm</span><br></pre></td></tr></table></figure>
<p>（3）配置jenkins</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/sysconfig/jenkins</span><br></pre></td></tr></table></figure>
<p>修改用户和端口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">JENKINS_USER=&quot;root&quot;</span><br><span class="line">JENKINS_PORT=&quot;8888&quot;</span><br></pre></td></tr></table></figure>
<p>（4）启动服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start jenkins</span><br></pre></td></tr></table></figure>
<p>（5）访问链接 <a href="http://192.168.184.135:8888" target="_blank" rel="noopener">http://192.168.184.135:8888</a></p>
<p>从/var/lib/jenkins/secrets/initialAdminPassword中获取初始密码串 </p>
<p><img src="image/9_1.png" alt></p>
<p>cat /var/lib/jenkins/secrets/initialAdminPassword</p>
<p>（6）安装插件  </p>
<p><img src="image/9_86.png" alt></p>
<p><img src="image/9_2.png" alt></p>
<p>（7）新建用户</p>
<p><img src="image/9_3.png" alt></p>
<p>完成安装进入主界面</p>
<p><img src="image/9_4.png" alt></p>
<h2 id="5-3-Jenkins插件安装"><a href="#5-3-Jenkins插件安装" class="headerlink" title="5.3 Jenkins插件安装"></a>5.3 Jenkins插件安装</h2><h3 id="5-3-1-安装Maven插件"><a href="#5-3-1-安装Maven插件" class="headerlink" title="5.3.1 安装Maven插件"></a>5.3.1 安装Maven插件</h3><p>（1）点击左侧的“系统管理”菜单 ,然后点击</p>
<p><img src="image/9_5.png" alt></p>
<p>（2）选择“可选插件”选项卡，搜索maven，在列表中选择Maven Integration  ，点击“直接安装”按钮</p>
<p><img src="image/9_6.png" alt></p>
<p>看到如下图时，表示已经完成</p>
<p><img src="image/9_7.png" alt></p>
<h3 id="5-3-2-安装Git插件"><a href="#5-3-2-安装Git插件" class="headerlink" title="5.3.2 安装Git插件"></a>5.3.2 安装Git插件</h3><p>步骤如上图，搜索git</p>
<p><img src="image/9_8.png" alt></p>
<h2 id="5-4-全局工具配置"><a href="#5-4-全局工具配置" class="headerlink" title="5.4 全局工具配置"></a>5.4 全局工具配置</h2><h3 id="5-4-1-安装Maven与本地仓库"><a href="#5-4-1-安装Maven与本地仓库" class="headerlink" title="5.4.1 安装Maven与本地仓库"></a>5.4.1 安装Maven与本地仓库</h3><p>（1）将Maven压缩包上传至服务器（虚拟机）</p>
<p>（2）解压</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar zxvf apache-maven-3.3.9-bin.tar.gz</span><br></pre></td></tr></table></figure>
<p>（3）移动目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv apache-maven-3.3.9 /usr/share/maven</span><br></pre></td></tr></table></figure>
<p>（4）编辑setting.xml配置文件<code>vi /usr/share/maven/conf/settings.xml</code>，配置本地仓库目录,内容如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;localRepository&gt;/usr/local/repository&lt;/localRepository&gt;</span><br><span class="line"></span><br><span class="line">vi  /etc/profile</span><br><span class="line">export MAVEN_HOME=/usr/share/maven</span><br><span class="line">export PATH=$MAVEN_HOME/bin:$PATH</span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure>
<p>（5）将开发环境的本地仓库上传至服务器（虚拟机）并移动到/usr/local/repository   。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">put -r  本地仓库路径</span><br><span class="line">mv reponsitory_boot /usr/local/repository</span><br></pre></td></tr></table></figure>
<p>执行此步是为了以后在打包的时候不必重新下载，缩短打包的时间。</p>
<p>（6）编辑setting.xml配置文件<code>vi /usr/local/maven/conf/settings.xml</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;pluginGroups&gt;    </span><br><span class="line">    &lt;pluginGroup&gt;com.spotify&lt;/pluginGroup&gt;    </span><br><span class="line">&lt;/pluginGroups&gt;</span><br></pre></td></tr></table></figure>
<h3 id="5-4-2-全局工具配置"><a href="#5-4-2-全局工具配置" class="headerlink" title="5.4.2 全局工具配置"></a>5.4.2 全局工具配置</h3><p>选择系统管理，全局工具配置</p>
<p>（1）JDK配置</p>
<p><img src="image/9_10.png" alt></p>
<p>设置javahome为 /usr/java/jdk1.8.0_171-amd64</p>
<p>（2）Git配置   （本地已经安装了Git软件）</p>
<p><img src="image/9_11.png" alt></p>
<p>（3）Maven配置</p>
<p><img src="image/9_12.png" alt></p>
<h2 id="5-5-持续集成"><a href="#5-5-持续集成" class="headerlink" title="5.5 持续集成"></a>5.5 持续集成</h2><h3 id="5-5-1-创建任务"><a href="#5-5-1-创建任务" class="headerlink" title="5.5.1 创建任务"></a>5.5.1 创建任务</h3><p>（1）回到首页，点击新建按钮 .如下图，输入名称，选择创建一个Maven项目，点击OK</p>
<p><img src="image/9_21.png" alt></p>
<p>（2）源码管理，选择Git</p>
<p><img src="image/9_22.png" alt></p>
<p>（3）Build</p>
<p><img src="image/9_23.png" alt></p>
<p>命令:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clean package docker:build -DpushImage</span><br></pre></td></tr></table></figure>
<p>用于清除、打包，构建docker镜像</p>
<p>最后点击“保存”按钮</p>
<h3 id="5-5-2-执行任务"><a href="#5-5-2-执行任务" class="headerlink" title="5.5.2 执行任务"></a>5.5.2 执行任务</h3><p>返回首页，在列表中找到我们刚才创建的任务</p>
<p><img src="image/9_24.png" alt></p>
<p>点击右边的绿色箭头按钮，即可执行此任务.</p>
<p>点击下面正在执行的任务</p>
<p><img src="image/9_25.png" alt></p>
<p>可以看到实时输出的日志</p>
<p><img src="image/9_26.png" alt></p>
<p>这就是镜像做好了在上传，如果你之前没有将你的本地仓库上传到服务器，会首先下载依赖的jar包，接下来就是漫长的等待了。</p>
<p>看到下面的结果就表示你已经成功了</p>
<p><img src="image/9_27.png" alt></p>
<p>首战告捷！哈哈，兴奋不？返回首页  看到列表</p>
<p><img src="image/9_28.png" alt></p>
<p>我们在浏览器看一下docker私有仓库</p>
<p><a href="http://192.168.184.135:5000/v2/_catalog" target="_blank" rel="noopener">http://192.168.184.135:5000/v2/_catalog</a> ,会看到tensquare_eureka已经上传成功了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;repositories&quot;:[&quot;jdk1.8&quot;,&quot;tensquare_eureka&quot;]&#125;</span><br></pre></td></tr></table></figure>
<p>按此方法完成其它微服务的构建</p>
<h3 id="5-5-3-完成配置中心的持续集成"><a href="#5-5-3-完成配置中心的持续集成" class="headerlink" title="5.5.3 完成配置中心的持续集成"></a>5.5.3 完成配置中心的持续集成</h3><p>（1）配置中心的pom.xml中，添加docker插件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>app<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">          <span class="comment">&lt;!-- docker的maven插件，官网：https://github.com/spotify/docker-maven-plugin --&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.spotify<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>docker-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.4.13<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">imageName</span>&gt;</span>192.168.184.135:5000/$&#123;project.artifactId&#125;:$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">imageName</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">baseImage</span>&gt;</span>jdk1.8<span class="tag">&lt;/<span class="name">baseImage</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">entryPoint</span>&gt;</span>["java", "-jar", "/$&#123;project.build.finalName&#125;.jar"]<span class="tag">&lt;/<span class="name">entryPoint</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">targetPath</span>&gt;</span>/<span class="tag">&lt;/<span class="name">targetPath</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">directory</span>&gt;</span>$&#123;project.build.directory&#125;<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">include</span>&gt;</span>$&#123;project.build.finalName&#125;.jar<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">dockerHost</span>&gt;</span>http://192.168.184.135:2375<span class="tag">&lt;/<span class="name">dockerHost</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>（2）提交代码到git</p>
<p>（3）按照同样的方法，完成配置中心的持续集成。完成后会看到私有仓库中添加了tensquare_config</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;repositories&quot;:[&quot;jdk1.8&quot;,&quot;tensquare_config&quot;,&quot;tensquare_eureka&quot;]&#125;</span><br></pre></td></tr></table></figure>
<p>（4）创建rabbitMQ容器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -di --name=tensquare_rabbitmq -p 5671:5671 -p 5672:5672 -p 4369:4369 -p 15671:15671 -p 15672:15672 -p 25672:25672 镜像id</span><br></pre></td></tr></table></figure>
<p>（5）创建容器：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -di --name=config -p 12000:12000 192.168.184.135:5000/tensquare_config:1.0-SNAPSHOT</span><br></pre></td></tr></table></figure>
<h3 id="5-5-4-完成基础微服务的持续集成"><a href="#5-5-4-完成基础微服务的持续集成" class="headerlink" title="5.5.4 完成基础微服务的持续集成"></a>5.5.4 完成基础微服务的持续集成</h3><p>（1）代码中添加docker插件 ,更改配置文件中的配置中心的地址为<a href="http://192.168.184.135:12000" target="_blank" rel="noopener">http://192.168.184.135:12000</a></p>
<p>（2）提交代码到git</p>
<p>（3）按照同样的方式构建基础微服务</p>
<p>（4）准备数据库环境</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -di --name=mysql -p 3306:3306 -e MYSQL_ROOT_PASSWORD=123456 centos/mysql-57-centos7</span><br></pre></td></tr></table></figure>
<p>（5）创建基础微服务容器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -di --name=base -p 9001:9001 192.168.184.135:5000/tensquare_base:1.0-SNAPSHOT</span><br></pre></td></tr></table></figure>
<h3 id="5-5-5-完成微服务网关的构建"><a href="#5-5-5-完成微服务网关的构建" class="headerlink" title="5.5.5 完成微服务网关的构建"></a>5.5.5 完成微服务网关的构建</h3><p>按照同样的步骤完成微服务网关tensquare_web的构建</p>
<h3 id="5-5-6-完成其它微服务的构建"><a href="#5-5-6-完成其它微服务的构建" class="headerlink" title="5.5.6 完成其它微服务的构建"></a>5.5.6 完成其它微服务的构建</h3><p>学员实现</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-my-work0 (8)" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/04/20/my-work0 (8)/" class="article-date">
      <time datetime="2019-04-20T14:58:54.641Z" itemprop="datePublished">2019-04-20</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="第8章-SpringCloud之一统天下"><a href="#第8章-SpringCloud之一统天下" class="headerlink" title="第8章-SpringCloud之一统天下"></a>第8章-SpringCloud之一统天下</h1><p>学习目标：</p>
<h1 id="1-熔断器Hystrix"><a href="#1-熔断器Hystrix" class="headerlink" title="1 熔断器Hystrix"></a>1 熔断器Hystrix</h1><h2 id="1-1-为什么要使用熔断器"><a href="#1-1-为什么要使用熔断器" class="headerlink" title="1.1 为什么要使用熔断器"></a>1.1 为什么要使用熔断器</h2><p>​    在微服务架构中通常会有多个服务层调用，基础服务的故障可能会导致级联故障，进而造成整个系统不可用的情况，这种现象被称为服务雪崩效应。服务雪崩效应是一种因“服务提供者”的不可用导致“服务消费者”的不可用,并将不可用逐渐放大的过程。</p>
<p>​    如果下图所示：A作为服务提供者，B为A的服务消费者，C和D是B的服务消费者。A不可用引起了B的不可用，并将不可用像滚雪球一样放大到C和D时，雪崩效应就形成了。</p>
<p> <img src="image/6-4.jpg" alt></p>
<p>​    如何避免产生这种雪崩效应呢？我们可以使用Hystrix来实现熔断器。</p>
<h2 id="1-2-什么是Hystrix"><a href="#1-2-什么是Hystrix" class="headerlink" title="1.2 什么是Hystrix"></a>1.2 什么是Hystrix</h2><p><strong>Hystrix</strong> [hɪst’rɪks]的中文含义是豪猪, 因其背上长满了刺,而拥有自我保护能力         <img src="image/6-5.jpg" alt></p>
<p>​    Hystrix 能使你的系统在出现依赖服务失效的时候，通过隔离系统所依赖的服务，防止服务级联失败，同时提供失败回退机制，更优雅地应对失效，并使你的系统能更快地从异常中恢复。</p>
<p>​    了解熔断器模式请看下图：</p>
<p><img src="image/6-7.jpg" alt></p>
<h2 id="1-3-快速体验"><a href="#1-3-快速体验" class="headerlink" title="1.3 快速体验"></a>1.3 快速体验</h2><p>Feign 本身支持Hystrix，不需要额外引入依赖。</p>
<p>（1）修改tensquare_qa模块的application.yml ，开启hystrix</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line"><span class="attr">  hystrix:</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>（2）在com.tensquare.qa.client包下创建impl包，包下创建熔断实现类，实现自接口LabelClient</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LabelClientImpl</span> <span class="keyword">implements</span> <span class="title">LabelClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">findById</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">false</span>, StatusCode.ERROR,<span class="string">"熔断器启动了"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（3）修改LabelClient的注解  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient</span>(value=<span class="string">"tensquare-base"</span>,fallback = LabelClientImpl.class)</span><br></pre></td></tr></table></figure>
<p>（4）测试运行</p>
<p>重新启动问答微服务，测试看熔断器是否运行。</p>
<h1 id="2-微服务网关Zuul"><a href="#2-微服务网关Zuul" class="headerlink" title="2 微服务网关Zuul"></a>2 微服务网关Zuul</h1><h2 id="2-1-为什么需要微服务网关"><a href="#2-1-为什么需要微服务网关" class="headerlink" title="2.1 为什么需要微服务网关"></a>2.1 为什么需要微服务网关</h2><p>不同的微服务一般有不同的网络地址，而外部的客户端可能需要调用多个服务的接口才能完成一个业务需求。比如一个电影购票的收集APP,可能回调用电影分类微服务，用户微服务，支付微服务等。如果客户端直接和微服务进行通信，会存在一下问题：</p>
<p># 客户端会多次请求不同微服务，增加客户端的复杂性</p>
<p># 存在跨域请求，在一定场景下处理相对复杂</p>
<p># 认证复杂，每一个服务都需要独立认证</p>
<p># 难以重构，随着项目的迭代，可能需要重新划分微服务，如果客户端直接和微服务通信，那么重构会难以实施</p>
<p># 某些微服务可能使用了其他协议，直接访问有一定困难</p>
<p>上述问题，都可以借助微服务网关解决。微服务网关是介于客户端和服务器端之间的中间层，所有的外部请求都会先经过微服务网关。</p>
<h2 id="2-2-什么是Zuul"><a href="#2-2-什么是Zuul" class="headerlink" title="2.2 什么是Zuul"></a>2.2 什么是Zuul</h2><p>​    Zuul是Netflix开源的微服务网关，他可以和Eureka,Ribbon,Hystrix等组件配合使用。Zuul组件的核心是一系列的过滤器，这些过滤器可以完成以下功能：</p>
<p># 身份认证和安全: 识别每一个资源的验证要求，并拒绝那些不符的请求</p>
<p>#审查与监控：</p>
<p>## 动态路由：动态将请求路由到不同后端集群</p>
<p># 压力测试：逐渐增加指向集群的流量，以了解性能</p>
<p># 负载分配：为每一种负载类型分配对应容量，并弃用超出限定值的请求</p>
<p># 静态响应处理：边缘位置进行响应，避免转发到内部集群</p>
<p># 多区域弹性：跨域AWS Region进行请求路由，旨在实现ELB(ElasticLoad Balancing)使用多样化</p>
<p>Spring Cloud对Zuul进行了整合和增强。</p>
<p>使用Zuul后，架构图演变为以下形式</p>
<p><img src="image/6-6.jpg" alt></p>
<h2 id="2-3-Zuul路由转发"><a href="#2-3-Zuul路由转发" class="headerlink" title="2.3 Zuul路由转发"></a>2.3 Zuul路由转发</h2><h3 id="2-3-1-管理后台微服务网关"><a href="#2-3-1-管理后台微服务网关" class="headerlink" title="2.3.1 管理后台微服务网关"></a>2.3.1 管理后台微服务网关</h3><p>（1）创建子模块tensquare_manager，pom.xml引入eureka-client 和zuul的依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-zuul<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>（2）创建application.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">9011</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">tensquare-manager</span> <span class="comment">#指定服务名</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line"><span class="attr">    serviceUrl:</span> <span class="comment">#Eureka客户端与Eureka服务端进行交互的地址</span></span><br><span class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://127.0.0.1:6868/eureka/</span></span><br><span class="line"><span class="attr">  instance:</span></span><br><span class="line"><span class="attr">    prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">zuul:</span></span><br><span class="line"><span class="attr">  routes:</span></span><br><span class="line"><span class="attr">    tensquare-gathering:</span> <span class="comment">#活动</span></span><br><span class="line"><span class="attr">      path:</span> <span class="string">/gathering/**</span> <span class="comment">#配置请求URL的请求规则</span></span><br><span class="line"><span class="attr">      serviceId:</span> <span class="string">tensquare-gathering</span> <span class="comment">#指定Eureka注册中心中的服务id</span></span><br><span class="line"><span class="attr">    tensquare-article:</span> <span class="comment">#文章</span></span><br><span class="line"><span class="attr">      path:</span> <span class="string">/article/**</span> <span class="comment">#配置请求URL的请求规则</span></span><br><span class="line"><span class="attr">      serviceId:</span> <span class="string">tensquare-article</span> <span class="comment">#指定Eureka注册中心中的服务id</span></span><br><span class="line"><span class="attr">    tensquare-base:</span> <span class="comment">#基础</span></span><br><span class="line"><span class="attr">      path:</span> <span class="string">/base/**</span> <span class="comment">#配置请求URL的请求规则</span></span><br><span class="line"><span class="attr">      serviceId:</span> <span class="string">tensquare-base</span> <span class="comment">#指定Eureka注册中心中的服务id</span></span><br><span class="line"><span class="attr">    tensquare-friend:</span> <span class="comment">#交友</span></span><br><span class="line"><span class="attr">      path:</span> <span class="string">/friend/**</span> <span class="comment">#配置请求URL的请求规则</span></span><br><span class="line"><span class="attr">      serviceId:</span> <span class="string">tensquare-friend</span> <span class="comment">#指定Eureka注册中心中的服务id </span></span><br><span class="line"><span class="attr">    tensquare-qa:</span> <span class="comment">#问答</span></span><br><span class="line"><span class="attr">      path:</span> <span class="string">/qa/**</span> <span class="comment">#配置请求URL的请求规则</span></span><br><span class="line"><span class="attr">      serviceId:</span> <span class="string">tensquare-qa</span> <span class="comment">#指定Eureka注册中心中的服务id </span></span><br><span class="line"><span class="attr">    tensquare-recruit:</span> <span class="comment">#招聘</span></span><br><span class="line"><span class="attr">      path:</span> <span class="string">/recruit/**</span> <span class="comment">#配置请求URL的请求规则</span></span><br><span class="line"><span class="attr">      serviceId:</span> <span class="string">tensquare-recruit</span> <span class="comment">#指定Eureka注册中心中的服务id          </span></span><br><span class="line"><span class="attr">    tensquare-spit:</span> <span class="comment">#吐槽</span></span><br><span class="line"><span class="attr">      path:</span> <span class="string">/spit/**</span> <span class="comment">#配置请求URL的请求规则</span></span><br><span class="line"><span class="attr">      serviceId:</span> <span class="string">tensquare-spit</span> <span class="comment">#指定Eureka注册中心中的服务id      </span></span><br><span class="line"><span class="attr">    tensquare-user:</span> <span class="comment">#用户</span></span><br><span class="line"><span class="attr">      path:</span> <span class="string">/user/**</span> <span class="comment">#配置请求URL的请求规则</span></span><br><span class="line"><span class="attr">      serviceId:</span> <span class="string">tensquare-user</span> <span class="comment">#指定Eureka注册中心中的服务id</span></span><br></pre></td></tr></table></figure>
<p>（3）编写启动类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableZuulProxy</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(Application.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-3-2-网站前台的微服务网关"><a href="#2-3-2-网站前台的微服务网关" class="headerlink" title="2.3.2 网站前台的微服务网关"></a>2.3.2 网站前台的微服务网关</h3><p>（1）创建子模块tensquare_web，pom.xml引入依赖zuul</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-zuul<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>（2）创建application.yml </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">9012</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">tensquare-web</span> <span class="comment">#指定服务名</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line"><span class="attr">    serviceUrl:</span> <span class="comment">#Eureka客户端与Eureka服务端进行交互的地址</span></span><br><span class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://127.0.0.1:6868/eureka/</span></span><br><span class="line"><span class="attr">  instance:</span></span><br><span class="line"><span class="attr">    prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">zuul:</span></span><br><span class="line"><span class="attr">  routes:</span></span><br><span class="line"><span class="attr">    tensquare-gathering:</span> <span class="comment">#活动</span></span><br><span class="line"><span class="attr">      path:</span> <span class="string">/gathering/**</span> <span class="comment">#配置请求URL的请求规则</span></span><br><span class="line"><span class="attr">      serviceId:</span> <span class="string">tensquare-gathering</span> <span class="comment">#指定Eureka注册中心中的服务id</span></span><br><span class="line"><span class="attr">    tensquare-article:</span> <span class="comment">#文章</span></span><br><span class="line"><span class="attr">      path:</span> <span class="string">/article/**</span> <span class="comment">#配置请求URL的请求规则</span></span><br><span class="line"><span class="attr">      serviceId:</span> <span class="string">tensquare-article</span> <span class="comment">#指定Eureka注册中心中的服务id</span></span><br><span class="line"><span class="attr">    tensquare-base:</span> <span class="comment">#基础</span></span><br><span class="line"><span class="attr">      path:</span> <span class="string">/base/**</span> <span class="comment">#配置请求URL的请求规则</span></span><br><span class="line"><span class="attr">      serviceId:</span> <span class="string">tensquare-base</span> <span class="comment">#指定Eureka注册中心中的服务id</span></span><br><span class="line"><span class="attr">    tensquare-friend:</span> <span class="comment">#交友</span></span><br><span class="line"><span class="attr">      path:</span> <span class="string">/friend/**</span> <span class="comment">#配置请求URL的请求规则</span></span><br><span class="line"><span class="attr">      serviceId:</span> <span class="string">tensquare-friend</span> <span class="comment">#指定Eureka注册中心中的服务id</span></span><br><span class="line"><span class="attr">    tensquare-qa:</span> <span class="comment">#问答</span></span><br><span class="line"><span class="attr">      path:</span> <span class="string">/qa/**</span> <span class="comment">#配置请求URL的请求规则</span></span><br><span class="line"><span class="attr">      serviceId:</span> <span class="string">tensquare-qa</span> <span class="comment">#指定Eureka注册中心中的服务id</span></span><br><span class="line"><span class="attr">    tensquare-recruit:</span> <span class="comment">#招聘</span></span><br><span class="line"><span class="attr">      path:</span> <span class="string">/recruit/**</span> <span class="comment">#配置请求URL的请求规则</span></span><br><span class="line"><span class="attr">      serviceId:</span> <span class="string">tensquare-recruit</span> <span class="comment">#指定Eureka注册中心中的服务id</span></span><br><span class="line"><span class="attr">    tensquare-spit:</span> <span class="comment">#吐槽</span></span><br><span class="line"><span class="attr">      path:</span> <span class="string">/spit/**</span> <span class="comment">#配置请求URL的请求规则</span></span><br><span class="line"><span class="attr">      serviceId:</span> <span class="string">tensquare-spit</span> <span class="comment">#指定Eureka注册中心中的服务id</span></span><br><span class="line"><span class="attr">    tensquare-user:</span> <span class="comment">#用户</span></span><br><span class="line"><span class="attr">      path:</span> <span class="string">/user/**</span> <span class="comment">#配置请求URL的请求规则</span></span><br><span class="line"><span class="attr">      serviceId:</span> <span class="string">tensquare-user</span> <span class="comment">#指定Eureka注册中心中的服务id</span></span><br><span class="line"><span class="attr">    tensquare-search:</span> <span class="comment">#搜索</span></span><br><span class="line"><span class="attr">      path:</span> <span class="string">/search/**</span> <span class="comment">#配置请求URL的请求规则</span></span><br><span class="line"><span class="attr">      serviceId:</span> <span class="string">tensquare-search</span> <span class="comment">#指定Eureka注册中心中的服务id</span></span><br></pre></td></tr></table></figure>
<p>（3）编写启动类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableZuulProxy</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(WebApplication.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-4-Zuul过滤器"><a href="#2-4-Zuul过滤器" class="headerlink" title="2.4 Zuul过滤器"></a>2.4 Zuul过滤器</h2><h3 id="2-4-1-Zuul过滤器快速体验"><a href="#2-4-1-Zuul过滤器快速体验" class="headerlink" title="2.4.1 Zuul过滤器快速体验"></a>2.4.1 Zuul过滤器快速体验</h3><p>我们现在在tensquare_web 创建一个简单的zuul过滤器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebFilter</span> <span class="keyword">extends</span> <span class="title">ZuulFilter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">filterType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="string">"pre"</span>;<span class="comment">// 前置过滤器</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">filterOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;<span class="comment">// 优先级为0，数字越大，优先级越低</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">shouldFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;<span class="comment">// 是否执行该过滤器，此处为true，说明需要过滤</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> ZuulException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"zuul过滤器..."</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>启动tensquare_web会发现过滤器已经执行</p>
<p>filterType：返回一个字符串代表过滤器的类型，在zuul中定义了四种不同生命周期的过滤器类型，具体如下：</p>
<ul>
<li><code>pre</code>：    可以在请求被路由之前调用</li>
<li><code>route</code>：在路由请求时候被调用</li>
<li><code>post</code>：在route和error过滤器之后被调用</li>
<li><code>error</code>：处理请求时发生错误时被调用</li>
</ul>
<p><code>filterOrder</code>：通过int值来定义过滤器的执行顺序</p>
<p><code>shouldFilter</code>：返回一个boolean类型来判断该过滤器是否要执行，所以通过此函数可实现过滤器的开关。在上例中，我们直接返回true，所以该过滤器总是生效</p>
<p><code>run</code>：过滤器的具体逻辑。</p>
<h3 id="2-4-2-网站前台的token转发"><a href="#2-4-2-网站前台的token转发" class="headerlink" title="2.4.2 网站前台的token转发"></a>2.4.2 网站前台的token转发</h3><p>我们现在在过滤器中接收header，转发给微服务</p>
<p>修改tensquare_web的过滤器。如果有token，直接转发。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> ZuulException </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"zuul过滤器..."</span>);</span><br><span class="line">    <span class="comment">//向header中添加鉴权令牌</span></span><br><span class="line">    RequestContext requestContext = RequestContext.getCurrentContext();</span><br><span class="line">    <span class="comment">//获取header</span></span><br><span class="line">    HttpServletRequest request = requestContext.getRequest();</span><br><span class="line">    String authorization = request.getHeader(<span class="string">"Authorization"</span>);</span><br><span class="line">    <span class="keyword">if</span>(authorization!=<span class="keyword">null</span>)&#123;</span><br><span class="line">        requestContext.addZuulRequestHeader(<span class="string">"Authorization"</span>,authorization);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-4-3-管理后台过滤器实现token校验"><a href="#2-4-3-管理后台过滤器实现token校验" class="headerlink" title="2.4.3 管理后台过滤器实现token校验"></a>2.4.3 管理后台过滤器实现token校验</h3><p>修改tensquare_manager的过滤器,  因为是管理后台使用，所以需要在过滤器中对token进行验证。</p>
<p>（1）tensquare_manager引入tensquare_common依赖  ，因为需要用到其中的JWT工具类</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.tensquare<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tensquare_common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>（2）修改tensquare_manager配置文件application.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">jwt:</span></span><br><span class="line"><span class="attr"> config:</span></span><br><span class="line"><span class="attr">    key:</span> <span class="string">itcast</span></span><br></pre></td></tr></table></figure>
<p>（3）修改tensquare_manager的启动类,添加bean</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> JwtUtil <span class="title">jwtUtil</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> JwtUtil();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（4）tensquare_manager编写过滤器类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ManagerFilter</span> <span class="keyword">extends</span> <span class="title">ZuulFilter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JwtUtil jwtUtil;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">filterType</span><span class="params">()</span> </span>&#123;<span class="comment">//过滤器类型</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"pre"</span>;<span class="comment">//前置过滤器</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">filterOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;<span class="comment">//优先级，数字越大，优先级越低</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">shouldFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;<span class="comment">//过滤器开关，true表示开启</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> ZuulException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Zuul过滤器"</span>);</span><br><span class="line">        RequestContext requestContext=RequestContext.getCurrentContext();</span><br><span class="line">        HttpServletRequest request = requestContext.getRequest();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(request.getMethod().equals(<span class="string">"OPTIONS"</span>))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        String url=request.getRequestURL().toString();</span><br><span class="line">        <span class="keyword">if</span>(url.indexOf(<span class="string">"/admin/login"</span>)&gt;<span class="number">0</span>)&#123;</span><br><span class="line">            System.out.println(<span class="string">"登陆页面"</span>+url);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String authHeader =(String)request.getHeader(<span class="string">"Authorization"</span>);<span class="comment">//获取头信息</span></span><br><span class="line">        <span class="keyword">if</span>(authHeader!=<span class="keyword">null</span> &amp;&amp; authHeader.startsWith(<span class="string">"Bearer "</span>) )&#123;</span><br><span class="line">            String token = authHeader.substring(<span class="number">7</span>);</span><br><span class="line">            Claims claims = jwtUtil.parseJWT(token);</span><br><span class="line">            <span class="keyword">if</span>(claims!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                <span class="keyword">if</span>(<span class="string">"admin"</span>.equals(claims.get(<span class="string">"roles"</span>)))&#123;</span><br><span class="line">                    requestContext.addZuulRequestHeader(<span class="string">"Authorization"</span>,authHeader);</span><br><span class="line">                    System.out.println(<span class="string">"token 验证通过，添加了头信息"</span>+authHeader);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        requestContext.setSendZuulResponse(<span class="keyword">false</span>);<span class="comment">//终止运行</span></span><br><span class="line">        requestContext.setResponseStatusCode(<span class="number">401</span>);<span class="comment">//http状态码</span></span><br><span class="line">        requestContext.setResponseBody(<span class="string">"无权访问"</span>);</span><br><span class="line">        requestContext.getResponse().setContentType(<span class="string">"text/html;charset=UTF-8"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>需要注意，这里我们通过<code>ctx.setSendZuulResponse(false)</code>令zuul过滤该请求，不对其进行路由，然后通过<code>ctx.setResponseStatusCode(401)</code>设置了其返回的错误码</p>
<h1 id="3-集中配置组件SpringCloudConfig"><a href="#3-集中配置组件SpringCloudConfig" class="headerlink" title="3 集中配置组件SpringCloudConfig"></a>3 集中配置组件SpringCloudConfig</h1><h2 id="3-1-Spring-Cloud-Config简介"><a href="#3-1-Spring-Cloud-Config简介" class="headerlink" title="3.1 Spring Cloud Config简介"></a>3.1 Spring Cloud Config简介</h2><p>在分布式系统中，由于服务数量巨多，为了方便服务配置文件统一管理，实时更新，所以需要分布式配置中心组件。在Spring Cloud中，有分布式配置中心组件spring cloud config ，它支持配置服务放在配置服务的内存中（即本地），也支持放在远程Git仓库中。在spring cloud config 组件中，分两个角色，一是config server，二是config client。</p>
<p>Config Server是一个可横向扩展、集中式的配置服务器，它用于集中管理应用程序各个环境下的配置，默认使用Git存储配置文件内容，也可以使用SVN存储，或者是本地文件存储。</p>
<p>Config Client是Config Server的客户端，用于操作存储在Config Server中的配置内容。微服务在启动时会请求Config Server获取配置文件的内容，请求到后再启动容器。</p>
<p>详细内容看在线文档： <a href="https://springcloud.cc/spring-cloud-config.html" target="_blank" rel="noopener">https://springcloud.cc/spring-cloud-config.html</a></p>
<h2 id="3-2-配置服务端"><a href="#3-2-配置服务端" class="headerlink" title="3.2 配置服务端"></a>3.2 配置服务端</h2><h3 id="3-2-1-将配置文件提交到码云"><a href="#3-2-1-将配置文件提交到码云" class="headerlink" title="3.2.1 将配置文件提交到码云"></a>3.2.1 将配置文件提交到码云</h3><p>使用GitHub时，国内的用户经常遇到的问题是访问速度太慢，有时候还会出现无法连接的情况。如果我们希望体验Git飞一般的速度，可以使用国内的Git托管服务——<a href="https://gitee.com/" target="_blank" rel="noopener">码云</a>（<a href="https://gitee.com/" target="_blank" rel="noopener">gitee.com</a>）。</p>
<p>和GitHub相比，码云也提供免费的Git仓库。此外，还集成了代码质量检测、项目演示等功能。对于团队协作开发，码云还提供了项目管理、代码托管、文档管理的服务。</p>
<p>步骤：</p>
<p>（1）浏览器打开gitee.com，注册用户 ，注册后登陆码云管理控制台</p>
<p><img src="image/8_21.png" alt></p>
<p>（2）创建项目  tensquare-config  (点击右上角的加号 ，下拉菜单选择创建项目)</p>
<p>（3）上传配置文件，将tensquare_base工程的application.yml改名为base-dev.yml后上传</p>
<p><img src="image/8_25.png" alt></p>
<p>可以通过拖拽的方式将文件上传上去</p>
<p><img src="image/8_26.png" alt></p>
<p>上传成功后列表可见</p>
<p><img src="image/8_23.png" alt></p>
<p>可以再次编辑此文件</p>
<p><img src="image/8_22.png" alt></p>
<p>文件命名规则：</p>
<p>{application}-{profile}.yml或{application}-{profile}.properties</p>
<p>application为应用名称 profile指的开发环境（用于区分开发环境，测试环境、生产环境等）</p>
<p>（4）复制git地址 ,备用</p>
<p><img src="image/8_24.png" alt></p>
<p>地址为：<a href="https://gitee.com/chuanzhiliubei/tensquare-config.git" target="_blank" rel="noopener">https://gitee.com/chuanzhiliubei/tensquare-config.git</a></p>
<h3 id="3-2-2-配置中心微服务"><a href="#3-2-2-配置中心微服务" class="headerlink" title="3.2.2 配置中心微服务"></a>3.2.2 配置中心微服务</h3><p>（1）创建工程模块 配置中心微服务  tensquare_config   ,pom.xml引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-config-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>（2）创建启动类ConfigServerApplication</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableConfigServer</span> <span class="comment">//开启配置服务</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigServerApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ConfigServerApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（3）编写配置文件application.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">tensquare-config</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    config:</span></span><br><span class="line"><span class="attr">      server:</span></span><br><span class="line"><span class="attr">        git:</span></span><br><span class="line"><span class="attr">          uri:</span> <span class="attr">https://gitee.com/chuanzhiliubei/tensquare-config.git</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">12000</span></span><br></pre></td></tr></table></figure>
<p>（4）浏览器测试：<a href="http://localhost:12000/base-dev.yml" target="_blank" rel="noopener">http://localhost:12000/base-dev.yml</a> 可以看到配置内容</p>
<h2 id="3-3-配置客户端"><a href="#3-3-配置客户端" class="headerlink" title="3.3 配置客户端"></a>3.3 配置客户端</h2><p>（1）在tensquare_base工程添加依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>（2）添加bootstrap.yml ,删除application.yml </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    config:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">base</span></span><br><span class="line"><span class="attr">      profile:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">      label:</span> <span class="string">master</span></span><br><span class="line"><span class="attr">      uri:</span> <span class="attr">http://127.0.0.1:12000</span></span><br></pre></td></tr></table></figure>
<p>（3）测试： 启动工程tensquare_eureka   tensquare_config  tensquare_base，看是否可以正常运行</p>
<p><a href="http://localhost:9001/label" target="_blank" rel="noopener">http://localhost:9001/label</a>  </p>
<h1 id="4-消息总线组件SpringCloudBus"><a href="#4-消息总线组件SpringCloudBus" class="headerlink" title="4 消息总线组件SpringCloudBus"></a>4 消息总线组件SpringCloudBus</h1><h2 id="4-1-SpringCloudBus简介"><a href="#4-1-SpringCloudBus简介" class="headerlink" title="4.1 SpringCloudBus简介"></a>4.1 SpringCloudBus简介</h2><p>​    如果我们更新码云中的配置文件，那客户端工程是否可以及时接受新的配置信息呢？我们现在来做有一个测试，修改一下码云中的配置文件中mysql的端口  ，然后测试<a href="http://localhost:9001/label" target="_blank" rel="noopener">http://localhost:9001/label</a>  数据依然可以查询出来，证明修改服务器中的配置并没有更新立刻到工程，只有重新启动程序才会读取配置。 那我们如果想在不重启微服务的情况下更新配置如何来实现呢?  我们使用SpringCloudBus来实现配置的自动更新。</p>
<h2 id="4-2-代码实现"><a href="#4-2-代码实现" class="headerlink" title="4.2 代码实现"></a>4.2 代码实现</h2><h3 id="4-2-1-配置服务端"><a href="#4-2-1-配置服务端" class="headerlink" title="4.2.1 配置服务端"></a>4.2.1 配置服务端</h3><p>（1）修改tensquare_config工程的pom.xml，引用依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-bus<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-stream-binder-rabbit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>（2）修改application.yml ，添加配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">  rabbitmq:</span></span><br><span class="line"><span class="attr">    host:</span> <span class="number">192.168</span><span class="number">.184</span><span class="number">.135</span></span><br><span class="line"><span class="attr">management:</span> <span class="comment">#暴露触发消息总线的地址</span></span><br><span class="line"><span class="attr">  endpoints:</span></span><br><span class="line"><span class="attr">    web:</span></span><br><span class="line"><span class="attr">      exposure:</span></span><br><span class="line"><span class="attr">        include:</span> <span class="string">bus-refresh</span></span><br></pre></td></tr></table></figure>
<h3 id="4-2-2-配置客户端"><a href="#4-2-2-配置客户端" class="headerlink" title="4.2.2 配置客户端"></a>4.2.2 配置客户端</h3><p>我们还是以基础模块为例，加入消息总线</p>
<p>（1）修改tensquare_base工程 ，引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-bus<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-stream-binder-rabbit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>（2）在码云的配置文件中配置rabbitMQ的地址：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">rabbitmq:</span></span><br><span class="line"><span class="attr">  host:</span> <span class="number">192.168</span><span class="number">.184</span><span class="number">.135</span></span><br></pre></td></tr></table></figure>
<p>（2）启动tensquare_eureka  、tensquare_config和tensquare_base  看是否正常运行</p>
<p>（3）修改码云上的配置文件 ，将数据库连接IP  改为127.0.0.1  ，在本地部署一份数据库。</p>
<p>（4）postman测试    Url: <a href="http://127.0.0.1:12000/actuator/bus-refresh" target="_blank" rel="noopener">http://127.0.0.1:12000/actuator/bus-refresh</a>   Method: post  </p>
<p>（5）再次观察输出的数据是否是读取了本地的mysql数据。</p>
<h3 id="4-2-3-自定义配置的读取"><a href="#4-2-3-自定义配置的读取" class="headerlink" title="4.2.3 自定义配置的读取"></a>4.2.3 自定义配置的读取</h3><p>（1）修改码云上的配置文件，增加自定义配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sms:</span><br><span class="line">  ip: 127.0.0.1</span><br></pre></td></tr></table></figure>
<p>（2）在tensquare_base工程中新建controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;sms.ip&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String ip;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/ip"</span>, method = RequestMethod.GET)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">ip</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ip;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（3）运行测试看是否能够读取配置信息  ，OK.</p>
<p>（4）修改码云上的配置文件中的自定义配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sms:</span><br><span class="line">  ip: 192.168.184.134</span><br></pre></td></tr></table></figure>
<p>（5）通过postman测试    Url: <a href="http://127.0.0.1:12000/actuator/bus-refresh" target="_blank" rel="noopener">http://127.0.0.1:12000/actuator/bus-refresh</a>   Method: post    </p>
<p>测试后观察,发现并没有更新信息。</p>
<p>这是因为我们的 controller少了一个注解@RefreshScope  此注解用于刷新配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RefreshScope</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;sms.ip&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String ip;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/ip"</span>, method = RequestMethod.GET)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">ip</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ip;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>添加后再次进行测试。</p>
<h3 id="4-2-4-完成十次方工程的配置集中管理"><a href="#4-2-4-完成十次方工程的配置集中管理" class="headerlink" title="4.2.4 完成十次方工程的配置集中管理"></a>4.2.4 完成十次方工程的配置集中管理</h3><p>步骤：</p>
<p>（1）将每一个工程的配置文件提取出来，重命名</p>
<p><img src="image/8_31.png" alt></p>
<p>（2）将这些文件上传到码云</p>
<p>（3）修改每一个微服务工程，pom.xml中添加依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-bus<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-stream-binder-rabbit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>（4）删除每一个微服务的application.yml</p>
<p>（5）为每一个微服务添加bootstrap.yml  （参考tesquare_base工程）</p>
<p>（6）修改码云上的配置文件添加rabbitmq地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rabbitmq:</span><br><span class="line">  host: 192.168.184.135</span><br></pre></td></tr></table></figure>
<h1 id="面试问题总结"><a href="#面试问题总结" class="headerlink" title="面试问题总结"></a>面试问题总结</h1><h2 id="解释雪崩效应，为什么要使用熔断器"><a href="#解释雪崩效应，为什么要使用熔断器" class="headerlink" title="解释雪崩效应，为什么要使用熔断器"></a>解释雪崩效应，为什么要使用熔断器</h2><h2 id="解释为什么使用微服务网关"><a href="#解释为什么使用微服务网关" class="headerlink" title="解释为什么使用微服务网关"></a>解释为什么使用微服务网关</h2><p>（1）微服务工程统一入口，方便前端调用</p>
<p>（2）集中处理权限问题</p>
<h2 id="解释为什么使用集中配置管理"><a href="#解释为什么使用集中配置管理" class="headerlink" title="解释为什么使用集中配置管理"></a>解释为什么使用集中配置管理</h2><p>将配置文件放到云端，方便后期维护</p>
<h2 id="解释为什么使用消息总线"><a href="#解释为什么使用消息总线" class="headerlink" title="解释为什么使用消息总线"></a>解释为什么使用消息总线</h2><p>我们可以在不重启微服务的情况下，更新配置文件，让其立刻生效</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-my-work0 (7)" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/04/20/my-work0 (7)/" class="article-date">
      <time datetime="2019-04-20T14:58:54.621Z" itemprop="datePublished">2019-04-20</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="第7章-SpringCloud之初入江湖"><a href="#第7章-SpringCloud之初入江湖" class="headerlink" title="第7章-SpringCloud之初入江湖"></a>第7章-SpringCloud之初入江湖</h1><p>学习目标：</p>
<ul>
<li>能够说出SpringCloud包含的主要框架</li>
<li>能够使用服务发现组件Eureka</li>
<li>能够使用Feign实现服务间的调用</li>
<li>完成交友微服务开发</li>
</ul>
<h1 id="1-SpringCloud简介"><a href="#1-SpringCloud简介" class="headerlink" title="1 SpringCloud简介"></a>1 SpringCloud简介</h1><h2 id="1-1-什么是SpringCloud"><a href="#1-1-什么是SpringCloud" class="headerlink" title="1.1 什么是SpringCloud"></a>1.1 什么是SpringCloud</h2><p>​    Spring Cloud是一系列框架的有序集合。它利用Spring Boot的开发便利性巧妙地简化了分布式系统基础设施的开发，如服务发现注册、配置中心、消息总线、负载均衡、熔断器、数据监控等，都可以用Spring Boot的开发风格做到一键启动和部署。Spring并没有重复制造轮子，它只是将目前各家公司开发的比较成熟、经得起实际考验的服务框架组合起来，通过Spring Boot风格进行再封装屏蔽掉了复杂的配置和实现原理，最终给开发者留出了一套简单易懂、易部署和易维护的分布式系统开发工具包。</p>
<p>​    Spring Cloud项目的官方网址：<a href="http://projects.spring.io/spring-cloud/" target="_blank" rel="noopener">http://projects.spring.io/spring-cloud/</a></p>
<h2 id="1-2-SpringCloud与SpringBoot的关系"><a href="#1-2-SpringCloud与SpringBoot的关系" class="headerlink" title="1.2 SpringCloud与SpringBoot的关系"></a>1.2 SpringCloud与SpringBoot的关系</h2><p>​    Spring Boot 是 Spring 的一套快速配置脚手架，可以基于Spring Boot 快速开发单个微服务，Spring Cloud是一个基于Spring Boot实现的云应用开发工具；Spring Boot专注于快速、方便集成的单个微服务个体，Spring Cloud关注全局的服务治理框架；Spring Boot使用了默认大于配置的理念，很多集成方案已经帮你选择好了，能不配置就不配置，Spring Cloud很大的一部分是基于Spring Boot来实现，可以不基于Spring Boot吗？不可以。</p>
<p>​    Spring Boot可以离开Spring Cloud独立使用开发项目，但是Spring Cloud离不开Spring Boot，属于依赖的关系。</p>
<h2 id="1-3-SpringCloud主要框架"><a href="#1-3-SpringCloud主要框架" class="headerlink" title="1.3 SpringCloud主要框架"></a>1.3 SpringCloud主要框架</h2><ul>
<li>服务发现——Netflix Eureka</li>
<li>服务调用——Netflix Feign</li>
<li>熔断器——Netflix Hystrix</li>
<li>服务网关——Netflix Zuul</li>
<li>分布式配置——Spring Cloud Config</li>
<li>消息总线   —— Spring Cloud Bus</li>
</ul>
<h2 id="1-4-Spring-Cloud和Dubbo对比"><a href="#1-4-Spring-Cloud和Dubbo对比" class="headerlink" title="1.4 Spring Cloud和Dubbo对比"></a>1.4 Spring Cloud和Dubbo对比</h2><p>​      或许很多人会说Spring Cloud和Dubbo的对比有点不公平，Dubbo只是实现了服务治理，而Spring Cloud下面有17个子项目（可能还会新增）分别覆盖了微服务架构下的方方面面，服务治理只是其中的一个方面，一定程度来说，Dubbo只是Spring Cloud Netflix中的一个子集。</p>
<table>
<thead>
<tr>
<th></th>
<th>Dubbo</th>
<th>Spring Cloud</th>
</tr>
</thead>
<tbody>
<tr>
<td>服务注册中心</td>
<td>Zookeeper</td>
<td>Spring Cloud Netflix Eureka</td>
</tr>
<tr>
<td>服务调用方式</td>
<td>RPC</td>
<td>REST API</td>
</tr>
<tr>
<td>服务网关</td>
<td>无</td>
<td>Spring Cloud Netflix Zuul</td>
</tr>
<tr>
<td>熔断器</td>
<td>不完善</td>
<td>Spring Cloud Netflix Hystrix</td>
</tr>
<tr>
<td>分布式配置</td>
<td>无</td>
<td>Spring Cloud Config</td>
</tr>
<tr>
<td>服务跟踪</td>
<td>无</td>
<td>Spring Cloud Sleuth</td>
</tr>
<tr>
<td>消息总线</td>
<td>无</td>
<td>Spring Cloud Bus</td>
</tr>
<tr>
<td>数据流</td>
<td>无</td>
<td>Spring Cloud Stream</td>
</tr>
<tr>
<td>批量任务</td>
<td>无</td>
<td>Spring Cloud Task</td>
</tr>
<tr>
<td>……</td>
<td>……</td>
<td>……</td>
</tr>
</tbody>
</table>
<h2 id="1-5-说说SpringCloud的版本"><a href="#1-5-说说SpringCloud的版本" class="headerlink" title="1.5 说说SpringCloud的版本"></a>1.5 说说SpringCloud的版本</h2><p>我们目前课程采用的SpringCloud版本为Finchley.M9  。你可能会觉得这个版本怎么这么奇怪？SpringCloud由于是一系列框架组合，为了避免与包含的自框架版本产生混淆，采用伦敦地铁站的名称作为版本名，形式为版本名+里程碑号。  M9为第9个里程碑版本。</p>
<p>以下是SpringBoot与Spring Cloud版本的对照表，大家看看有没有找到什么规律呢？</p>
<table>
<thead>
<tr>
<th>Spring Boot</th>
<th>Spring Cloud</th>
</tr>
</thead>
<tbody>
<tr>
<td>1.2.x</td>
<td>Angel版本</td>
</tr>
<tr>
<td>1.3.x</td>
<td>Brixton版本</td>
</tr>
<tr>
<td>1.4.x</td>
<td>Camden版本</td>
</tr>
<tr>
<td>1.5.x</td>
<td>Dalston版本、Edgware版本</td>
</tr>
<tr>
<td>2.0.x</td>
<td>Finchley版本</td>
</tr>
</tbody>
</table>
<h1 id="2-服务发现组件-Eureka"><a href="#2-服务发现组件-Eureka" class="headerlink" title="2 服务发现组件 Eureka"></a>2 服务发现组件 Eureka</h1><h2 id="2-1-Eureka"><a href="#2-1-Eureka" class="headerlink" title="2.1 Eureka"></a>2.1 Eureka</h2><p>​    Eureka是Netflix开发的服务发现框架，SpringCloud将它集成在自己的子项目spring-cloud-netflix中，实现SpringCloud的服务发现功能。Eureka包含两个组件：Eureka Server和Eureka Client。</p>
<p>​    Eureka Server提供服务注册服务，各个节点启动后，会在Eureka Server中进行注册，这样EurekaServer中的服务注册表中将会存储所有可用服务节点的信息，服务节点的信息可以在界面中直观的看到。</p>
<p>​    Eureka Client是一个java客户端，用于简化与Eureka Server的交互，客户端同时也就别一个内置的、使用轮询(round-robin)负载算法的负载均衡器。在应用启动后，将会向Eureka Server发送心跳,默认周期为30秒，如果Eureka Server在多个心跳周期内没有接收到某个节点的心跳，Eureka Server将会从服务注册表中把这个服务节点移除(默认90秒)。</p>
<p>​    Eureka Server之间通过复制的方式完成数据的同步，Eureka还提供了客户端缓存机制，即使所有的Eureka Server都挂掉，客户端依然可以利用缓存中的信息消费其他服务的API。综上，Eureka通过心跳检查、客户端缓存等机制，确保了系统的高可用性、灵活性和可伸缩性。</p>
<h2 id="2-2-Eureka服务端开发"><a href="#2-2-Eureka服务端开发" class="headerlink" title="2.2 Eureka服务端开发"></a>2.2 Eureka服务端开发</h2><p>（1）创建tensquare_eureka模块</p>
<p>（2）引入依赖  父工程pom.xml定义SpringCloud版本</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>Finchley.M9<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>tensquare_eureka模块pom.xml引入eureka-server</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>（2）添加application.yml </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">6868</span> <span class="comment">#服务端口</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line"><span class="attr">    regiter-with-eureka:</span> <span class="literal">false</span> <span class="comment">#是否将自己注册到Eureka服务中，本身就是所有无需注册</span></span><br><span class="line"><span class="attr">    fetch-registry:</span> <span class="literal">false</span>  <span class="comment">#是否从Eureka中获取注册信息</span></span><br><span class="line"><span class="attr">    service-url:</span>  <span class="comment">#Eureka客户端与Eureka服务端进行交互的地址</span></span><br><span class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://127.0.0.1:$&#123;server.port&#125;/eureka</span></span><br></pre></td></tr></table></figure>
<p>（3）编写启动类</p>
<p>创建包com.tensquare.eureka ，包下建立类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaServer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(EurekaServer.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（4）启动运行启动类，然后在浏览器地址栏输入  <a href="http://localhost:6868/" target="_blank" rel="noopener">http://localhost:6868/</a>  运行效果如下：</p>
<p> <img src="image/6-1.jpg" alt> </p>
<p>主界面中system status为系统信息  General Info为一般信息  Instances currently registered with Eureka为注册到的所有微服务列表</p>
<h2 id="2-3-服务注册"><a href="#2-3-服务注册" class="headerlink" title="2.3 服务注册"></a>2.3 服务注册</h2><p>我们现在就将所有的微服务都注册到Eureka中，这样所有的微服务之间都可以互相调用了。</p>
<p>（1）将其他微服务模块添加依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>（2）修改每个微服务的application.yml，添加注册eureka服务的配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line"><span class="attr">    service-url:</span></span><br><span class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://localhost:6868/eureka</span></span><br><span class="line"><span class="attr">  instance:</span></span><br><span class="line"><span class="attr">    prefer-ip-address:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>（3）修改每个服务类的启动类，添加注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableEurekaClient</span></span><br></pre></td></tr></table></figure>
<p>（4）启动测试：将每个微服务启动起来，会发现eureka的注册列表中可以看到这些微服务了 </p>
<p><img src="image/7_2.png" alt> </p>
<h2 id="2-4-保护模式"><a href="#2-4-保护模式" class="headerlink" title="2.4 保护模式"></a>2.4 保护模式</h2><p>如果在Eureka Server的首页看到以下这段提示，则说明Eureka已经进入了保护模式：</p>
<p><img src="image/7_1.png" alt></p>
<p>Eureka Server在运行期间，会统计心跳失败的比例在15分钟之内是否低于85%，如果出现低于的情况（在单机调试的时候很容易满足，实际在生产环境上通常是由于网络不稳定导致），Eureka Server会将当前的实例注册信息保护起来，同时提示这个警告。保护模式主要用于一组客户端和Eureka Server之间存在网络分区场景下的保护。一旦进入保护模式，Eureka Server将会尝试保护其服务注册表中的信息，不再删除服务注册表中的数据（也就是不会注销任何微服务）。</p>
<h1 id="3-Feign实现服务间的调用"><a href="#3-Feign实现服务间的调用" class="headerlink" title="3 Feign实现服务间的调用"></a>3 Feign实现服务间的调用</h1><h2 id="3-1-Feign简介"><a href="#3-1-Feign简介" class="headerlink" title="3.1 Feign简介"></a>3.1 Feign简介</h2><p>​    Feign是简化Java HTTP客户端开发的工具（java-to-httpclient-binder），它的灵感来自于<a href="https://github.com/square/retrofit" target="_blank" rel="noopener">Retrofit</a>、<a href="https://jax-rs-spec.java.net/nonav/2.0/apidocs/index.html" target="_blank" rel="noopener">JAXRS-2.0</a>和<a href="http://www.oracle.com/technetwork/articles/java/jsr356-1937161.html" target="_blank" rel="noopener">WebSocket</a>。Feign的初衷是降低统一绑定<a href="https://github.com/Netflix/Denominator" target="_blank" rel="noopener">Denominator</a>到HTTP API的复杂度，不区分是否为restful。</p>
<h2 id="3-2-快速体验"><a href="#3-2-快速体验" class="headerlink" title="3.2 快速体验"></a>3.2 快速体验</h2><p>我们现在在问答微服务（客户端）调用基础微服务（服务端）的方法（根据ID查询标签）</p>
<p>（1）在tensquare_qa模块添加依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>（2）修改tensquare_qa模块的启动类，添加注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br></pre></td></tr></table></figure>
<p>（3）在tensquare_qa模块创建 com.tensquare.qa.client包，包下创建接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient</span>(<span class="string">"tensquare-base"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">LabelClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value=<span class="string">"/label/&#123;id&#125;"</span>, method = RequestMethod.GET)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">findById</span><span class="params">(@PathVariable(<span class="string">"id"</span>)</span> String id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>@FeignClient注解用于指定从哪个服务中调用功能  ，<strong><em>注意</em></strong>  里面的名称与被调用的服务名保持一致，并且不能包含下划线。</p>
<p>@RequestMapping注解用于对被调用的微服务进行地址映射。<strong><em>注意</em></strong>   @PathVariable注解一定要指定参数名称，否则出错</p>
<p>（5）修改tensquare_qa模块的  ProblemController</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> LabelClient labelClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/label/&#123;labelid&#125;"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">findLabelById</span><span class="params">(@PathVariable  String labelid)</span></span>&#123;</span><br><span class="line">	Result result = labelClient.findById(labelid);</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（6）测试：<a href="http://localhost:9003/problem/label/1" target="_blank" rel="noopener">http://localhost:9003/problem/label/1</a>  能看到标签的信息</p>
<h2 id="3-3-负载均衡"><a href="#3-3-负载均衡" class="headerlink" title="3.3 负载均衡"></a>3.3 负载均衡</h2><p>测试：同时开启多个基础微服务，看是否是轮流调用。</p>
<p>修改tensquare_base工程LabelController的findById方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value=<span class="string">"/&#123;id&#125;"</span>, method = RequestMethod.GET)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">findById</span><span class="params">(@PathVariable String id)</span></span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"No.1"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">true</span>,StatusCode.OK,<span class="string">"查询成功"</span>,labelService.findById(id)  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>启动基础微服务后，修改端口和输出信息，再次启动基础微服务</p>
<p>启动问答微服务，浏览器执行<a href="http://localhost:9003/problem/label/1" target="_blank" rel="noopener">http://localhost:9003/problem/label/1</a>   看是否轮流启动。</p>
<h1 id="4-交友微服务开发"><a href="#4-交友微服务开发" class="headerlink" title="4 交友微服务开发"></a>4 交友微服务开发</h1><h2 id="4-1-需求分析"><a href="#4-1-需求分析" class="headerlink" title="4.1 需求分析"></a>4.1 需求分析</h2><p>好友表：</p>
<table>
<thead>
<tr>
<th>好友表</th>
<th>tb_friend</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>字段名称</td>
<td>字段含义</td>
<td>字段类型</td>
<td>备注</td>
</tr>
<tr>
<td>userid</td>
<td>用户ID</td>
<td>文本</td>
<td></td>
</tr>
<tr>
<td>friendid</td>
<td>好友ID</td>
<td>文本</td>
<td></td>
</tr>
<tr>
<td>islike</td>
<td>是否互相喜欢</td>
<td>文本</td>
<td>0：单向喜欢  1：互相喜欢</td>
</tr>
</tbody>
</table>
<p>非好友表：</p>
<table>
<thead>
<tr>
<th>好友表</th>
<th>tb_nofriend</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>字段名称</td>
<td>字段含义</td>
<td>字段类型</td>
<td>备注</td>
</tr>
<tr>
<td>userid</td>
<td>用户ID</td>
<td>文本</td>
<td></td>
</tr>
<tr>
<td>friendid</td>
<td>好友ID</td>
<td>文本</td>
</tr>
</tbody>
</table>
<p>交友微服务本身的功能:</p>
<p>（1）当用户登陆后在推荐好友列表中点击“心”，表示喜欢此人 ，在数据库tb_friend表中插入一条数据，islike 为0</p>
<p>（2）当你点击了喜欢过的人，也喜欢了你 , 表示互粉成功！也向tb_friend表中插入一条数据，islike为1 ，并且将你喜欢她的数据islike也修改为1 </p>
<p>（3）当你点击了不喜欢某人（点击了叉），向tb_nofriend添加记录.</p>
<p>（4）当两个人互粉后，其中一人不喜欢对方了，删除好友表中的记录 ，向非好友表中添加记录</p>
<p>什么场景下使用springCloud呢？</p>
<p>我们来看用户表，有两列：  fanscount 表示粉丝数  ，followcount表示关注数</p>
<p>（1）当用户点击了喜欢：</p>
<p>比如小宝关注了楚楚，小宝的followcount（关注数）加1  ， 楚楚的fanscount （粉丝数）加1</p>
<p>（2）当用户删除了好友：</p>
<p>比如楚楚删除了好友小宝，小宝的fanscount （粉丝数）减1 ，楚楚的followcount（关注数）减1</p>
<h2 id="4-2-交友微服务-添加与删除好友"><a href="#4-2-交友微服务-添加与删除好友" class="headerlink" title="4.2 交友微服务-添加与删除好友"></a>4.2 交友微服务-添加与删除好友</h2><h3 id="4-2-1-模块搭建"><a href="#4-2-1-模块搭建" class="headerlink" title="4.2.1 模块搭建"></a>4.2.1 模块搭建</h3><p>（1）创建工程tensquare_friend，pom.xml引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.tensquare<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tensquare_common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>（2）创建application.yml </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span> </span><br><span class="line"><span class="attr">  port:</span> <span class="number">9010</span></span><br><span class="line"><span class="attr">spring:</span> </span><br><span class="line"><span class="attr">  application:</span>  </span><br><span class="line"><span class="attr">    name:</span> <span class="string">tensquare-friend</span> <span class="comment">#指定服务名</span></span><br><span class="line"><span class="attr">  datasource:</span>  </span><br><span class="line"><span class="attr">    driverClassName:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="attr">    url:</span> <span class="attr">jdbc:mysql://192.168.184.134:3306/tensquare_friend?characterEncoding=utf-8</span></span><br><span class="line"><span class="attr">    username:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    password:</span> <span class="number">123456</span></span><br><span class="line"><span class="attr">  jpa:</span> </span><br><span class="line"><span class="attr">    database:</span> <span class="string">MySQL</span></span><br><span class="line"><span class="attr">    show-sql:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">jwt:</span></span><br><span class="line"><span class="attr"> config:</span></span><br><span class="line"><span class="attr">    key:</span> <span class="string">itcast</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line"><span class="attr">    service-url:</span></span><br><span class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://localhost:6868/eureka</span></span><br><span class="line"><span class="attr">  instance:</span></span><br><span class="line"><span class="attr">    prefer-ip-address:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>（3）编写启动类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		SpringApplication.run(Application.class, args);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> IdWorker <span class="title">idWorkker</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> IdWorker(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> JwtUtil <span class="title">jwtUtil</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> util.JwtUtil();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（4）创建JwtFilter（参见User工程）</p>
<p>（5）创建ApplicationConfig（参见User工程）</p>
<h3 id="4-2-2-添加好友"><a href="#4-2-2-添加好友" class="headerlink" title="4.2.2 添加好友"></a>4.2.2 添加好友</h3><p>（1）创建实体类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table</span>(name=<span class="string">"tb_friend"</span>)</span><br><span class="line"><span class="meta">@IdClass</span>(Friend.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Friend</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> String userid;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> String friendid;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUserid</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userid;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserid</span><span class="params">(String userid)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userid = userid;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getFriendid</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> friendid;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFriendid</span><span class="params">(String friendid)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.friendid = friendid;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（2）新建dao包，创建FriendDao接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 交友数据访问层</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">FriendDao</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">Friend</span>,<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据用户ID与被关注用户ID查询记录个数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userid</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> friendid</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Query</span>(<span class="string">"select count(f) from Friend f where f.userid=?1 and f.friendid=?2"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">selectCount</span><span class="params">(String userid,String friendid)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 更新为互相喜欢</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userid</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> friendid</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Modifying</span></span><br><span class="line">    <span class="meta">@Query</span>(<span class="string">"update Friend f  set f.islike=?3 where f.userid=?1 and f.friendid=?2"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateLike</span><span class="params">(String userid,String friendid,String islike)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（3）创建业务逻辑类</p>
<p>创建com.tensquare.friend.service包，包下建立类FriendService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FriendService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> FriendDao friendDao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">addFriend</span><span class="params">(String userid,String friendid)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//判断如果用户已经添加了这个好友，则不进行任何操作,返回0</span></span><br><span class="line">        <span class="keyword">if</span>(friendDao.selectCount(userid, friendid)&gt;<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//向喜欢表中添加记录</span></span><br><span class="line">        Friend friend=<span class="keyword">new</span> Friend();</span><br><span class="line">        friend.setUserid(userid);</span><br><span class="line">        friend.setFriendid(friendid);</span><br><span class="line">        friend.setIslike(<span class="string">"0"</span>);</span><br><span class="line">        friendDao.save(friend);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//判断对方是否喜欢你，如果喜欢，将islike设置为1</span></span><br><span class="line">        <span class="keyword">if</span>(friendDao.selectCount( friendid,userid)&gt;<span class="number">0</span>)&#123;</span><br><span class="line">            friendDao.updateLike(userid,friendid,<span class="string">"1"</span>);</span><br><span class="line">            friendDao.updateLike(friendid,userid,<span class="string">"1"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（3）控制器类</p>
<p>创建包com.tensquare.friend.controller，包下创建FriendController</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/friend"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FriendController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> FriendService friendService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> HttpServletRequest request;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  添加好友</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> friendid 对方用户ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> type  1：喜欢 0：不喜欢</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value=<span class="string">"/like/&#123;friendid&#125;/&#123;type&#125;"</span>,method= RequestMethod.PUT)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">addFriend</span><span class="params">(@PathVariable String friendid , @PathVariable String type)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        Claims claims=(Claims)request.getAttribute(<span class="string">"user_claims"</span>);</span><br><span class="line">        <span class="keyword">if</span>(claims==<span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">false</span>, StatusCode.ACCESSERROR,<span class="string">"无权访问"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//如果是喜欢</span></span><br><span class="line">        <span class="keyword">if</span>(type.equals(<span class="string">"1"</span>))&#123;</span><br><span class="line">            <span class="keyword">if</span>(friendService.addFriend(claims.getId(),friendid)==<span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">false</span>, StatusCode.REPERROR,<span class="string">"已经添加此好友"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">//不喜欢</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">true</span>, StatusCode.OK, <span class="string">"操作成功"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（4）测试：</p>
<p>​    启动用户微服务，登陆用户获取token</p>
<p>​    启动交友微服务，通过postMan测试  <a href="http://localhost:9010/friend/like/1/1,添加头信息" target="_blank" rel="noopener">http://localhost:9010/friend/like/1/1,添加头信息</a>  Authorization  内容为Bearer  加上获取的token.</p>
<h3 id="4-2-3-添加非好友"><a href="#4-2-3-添加非好友" class="headerlink" title="4.2.3 添加非好友"></a>4.2.3 添加非好友</h3><p>需求：当用户点击不喜欢某人，将对方的ID记录不喜欢列表中</p>
<p>（1）构建实体类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table</span>(name=<span class="string">"tb_nofriend"</span>)</span><br><span class="line"><span class="meta">@IdClass</span>(NoFriend.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NoFriend</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> String userid;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> String friendid;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUserid</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userid;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserid</span><span class="params">(String userid)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userid = userid;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getFriendid</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> friendid;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFriendid</span><span class="params">(String friendid)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.friendid = friendid;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（2）创建数据访问接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 不喜欢列表数据访问层</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">NoFriendDao</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">NoFriend</span>,<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（3）修改业务逻辑类FriendService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> NoFriendDao noFriendDao;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 向不喜欢列表中添加记录</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> userid</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> friendid</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addNoFriend</span><span class="params">(String userid,String friendid)</span></span>&#123;</span><br><span class="line">    NoFriend noFriend=<span class="keyword">new</span> NoFriend();</span><br><span class="line">    noFriend.setUserid(userid);</span><br><span class="line">    noFriend.setFriendid(friendid);</span><br><span class="line">    noFriendDao.save(noFriend);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（2）修改FriendController的addFriend方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  添加好友</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> friendid 对方用户ID</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> type  1：喜欢 0：不喜欢</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(value=<span class="string">"/like/&#123;friendid&#125;/&#123;type&#125;"</span>,method= RequestMethod.PUT)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">addFriend</span><span class="params">(@PathVariable String friendid , @PathVariable String type)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    Claims claims=(Claims)request.getAttribute(<span class="string">"user_claims"</span>);</span><br><span class="line">    <span class="keyword">if</span>(claims==<span class="keyword">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">false</span>, StatusCode.ACCESSERROR,<span class="string">"无权访问"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//如果是喜欢</span></span><br><span class="line">    <span class="keyword">if</span>(type.equals(<span class="string">"1"</span>))&#123;</span><br><span class="line">        <span class="keyword">if</span>(friendService.addFriend(claims.getId(),friendid)==<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">false</span>, StatusCode.REPERROR,<span class="string">"已经添加此好友"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">//不喜欢</span></span><br><span class="line">        friendService.addNoFriend(claims.getId(),friendid);<span class="comment">//向不喜欢列表中添加记录</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">true</span>, StatusCode.OK, <span class="string">"操作成功"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-2-4-删除好友"><a href="#4-2-4-删除好友" class="headerlink" title="4.2.4 删除好友"></a>4.2.4 删除好友</h3><p>（1）FriendDao新增方法定义</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 删除喜欢</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> userid</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> friendid</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Modifying</span></span><br><span class="line"><span class="meta">@Query</span>(<span class="string">"delete from Friend f where f.userid=?1 and f.friendid=?2"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteFriend</span><span class="params">(String userid,String friendid)</span></span>;</span><br></pre></td></tr></table></figure>
<p>（2）FriendService新增方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 删除好友</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> userid</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> friendid</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="meta">@Transactional</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteFriend</span><span class="params">(String userid,String friendid)</span></span>&#123;</span><br><span class="line">     friendDao.deleteFriend(userid,friendid);</span><br><span class="line">     friendDao.updateLike(friendid,userid,<span class="string">"0"</span>);</span><br><span class="line">     addNoFriend(userid,friendid);<span class="comment">//向不喜欢表中添加记录</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>（3）FriendController新增方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 删除好友</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> friendid</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(value=<span class="string">"/&#123;friendid&#125;"</span>,method=RequestMethod.DELETE)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">remove</span><span class="params">(@PathVariable String friendid)</span></span>&#123;</span><br><span class="line">    Claims claims=(Claims)request.getAttribute(<span class="string">"user_claims"</span>);</span><br><span class="line">    <span class="keyword">if</span>(claims==<span class="keyword">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">false</span>, StatusCode.ACCESSERROR,<span class="string">"无权访问"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    friendService.deleteFriend(claims.getId(), friendid);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">true</span>, StatusCode.OK, <span class="string">"删除成功"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-3-用户微服务-粉丝数与关注数的变更"><a href="#4-3-用户微服务-粉丝数与关注数的变更" class="headerlink" title="4.3 用户微服务-粉丝数与关注数的变更"></a>4.3 用户微服务-粉丝数与关注数的变更</h2><h3 id="4-3-1-变更粉丝数"><a href="#4-3-1-变更粉丝数" class="headerlink" title="4.3.1 变更粉丝数"></a>4.3.1 变更粉丝数</h3><p>（1）修改tensquare_user工程的UserDao，增加方法定义</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 更新粉丝数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> userid 用户ID</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> x 粉丝数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Modifying</span></span><br><span class="line"><span class="meta">@Query</span>(<span class="string">"update User u set u.fanscount=u.fanscount+?2  where u.id=?1"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">incFanscount</span><span class="params">(String userid,<span class="keyword">int</span> x)</span></span>;</span><br></pre></td></tr></table></figure>
<p>（2）UserService增加方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  更新粉丝数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> x</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span>  <span class="title">incFanscount</span><span class="params">(String userid,<span class="keyword">int</span> x)</span></span>&#123;</span><br><span class="line">	userDao.incFanscount(userid,x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（3）UserController增加方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  增加粉丝数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> userid</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> x</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(value=<span class="string">"/incfans/&#123;userid&#125;/&#123;x&#125;"</span>,method= RequestMethod.POST)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">incFanscount</span><span class="params">(@PathVariable String userid,@PathVariable <span class="keyword">int</span> x)</span></span>&#123;</span><br><span class="line">	userService.incFanscount(userid,x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-3-2-变更关注数"><a href="#4-3-2-变更关注数" class="headerlink" title="4.3.2 变更关注数"></a>4.3.2 变更关注数</h3><p>（1）修改tensquare_user工程的UserDao，增加方法定义</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 更新关注数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> userid 用户ID</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> x 粉丝数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Modifying</span></span><br><span class="line"><span class="meta">@Query</span>(<span class="string">"update User u set u.followcount=u.followcount+?2  where u.id=?1"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">incFollowcount</span><span class="params">(String userid,<span class="keyword">int</span> x)</span></span>;</span><br></pre></td></tr></table></figure>
<p>（2）UserService增加方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  更新关注数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> x</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span>  <span class="title">incFollowcount</span><span class="params">(String userid,<span class="keyword">int</span> x)</span></span>&#123;</span><br><span class="line">	userDao.incFollowcount(userid,x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（3）UserController增加方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  增加关注数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> userid</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> x</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(value=<span class="string">"/incfollow/&#123;userid&#125;/&#123;x&#125;"</span>,method= RequestMethod.POST)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">incFollowcount</span><span class="params">(@PathVariable String userid,@PathVariable <span class="keyword">int</span> x)</span></span>&#123;</span><br><span class="line">	userService.incFollowcount(userid,x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-4-调用用户微服务"><a href="#4-4-调用用户微服务" class="headerlink" title="4.4 调用用户微服务"></a>4.4 调用用户微服务</h2><h3 id="4-4-1-喜欢某人更新用户数据"><a href="#4-4-1-喜欢某人更新用户数据" class="headerlink" title="4.4.1 喜欢某人更新用户数据"></a>4.4.1 喜欢某人更新用户数据</h3><p>（1）在tensquare_friend模块创建 com.tensquare.friend.client包，包下创建接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户客户端</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@FeignClient</span>(<span class="string">"tensquare-user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  增加粉丝数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userid</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> x</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value=<span class="string">"/user/incfans/&#123;userid&#125;/&#123;x&#125;"</span>,method= RequestMethod.POST)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">incFanscount</span><span class="params">(@PathVariable(<span class="string">"userid"</span>)</span> String userid, @<span class="title">PathVariable</span><span class="params">(<span class="string">"x"</span>)</span> <span class="keyword">int</span> x)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  增加关注数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userid</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> x</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value=<span class="string">"/user/incfollow/&#123;userid&#125;/&#123;x&#125;"</span>,method= RequestMethod.POST)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">incFollowcount</span><span class="params">(@PathVariable(<span class="string">"userid"</span>)</span> String userid,@<span class="title">PathVariable</span><span class="params">(<span class="string">"x"</span>)</span> <span class="keyword">int</span> x)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>@FeignClient注解用于指定从哪个服务中调用功能  </p>
<p>@RequestMapping注解用于对被调用的微服务进行地址映射。</p>
<p><strong><em>注意</em></strong>   @PathVariable注解一定要指定参数名称，否则出错</p>
<p>（2）修改FriendService ，注入UserClient</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> UserClient userClient;</span><br></pre></td></tr></table></figure>
<p>​          修改addFriend方法,增加对userClient方法的调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">userClient.incFollowcount(userid,<span class="number">1</span>);<span class="comment">//增加自己的关注数</span></span><br><span class="line">userClient.incFanscount(friendid,<span class="number">1</span>);<span class="comment">//增加对方的粉丝数</span></span><br></pre></td></tr></table></figure>
<h3 id="4-4-2-删除好友更新用户数据"><a href="#4-4-2-删除好友更新用户数据" class="headerlink" title="4.4.2 删除好友更新用户数据"></a>4.4.2 删除好友更新用户数据</h3><p>修改FriendService的deleteFriend方法 ,增加调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">userClient.incFollowcount(userid,-<span class="number">1</span>);<span class="comment">//减少自己的关注数</span></span><br><span class="line">userClient.incFanscount(friendid,-<span class="number">1</span>);<span class="comment">//减少对方的粉丝数</span></span><br></pre></td></tr></table></figure>
<h1 id="面试问题"><a href="#面试问题" class="headerlink" title="面试问题"></a>面试问题</h1><h2 id="你在项目中使用SpringCloud的哪些组件"><a href="#你在项目中使用SpringCloud的哪些组件" class="headerlink" title="你在项目中使用SpringCloud的哪些组件?"></a>你在项目中使用SpringCloud的哪些组件?</h2><p>服务注册组件Eureka  服务发现组件Feign 熔断器   网关  SpringCloudConfig (集中配置管理) SpringCloudBus(消息总线)</p>
<h2 id="你在项目中哪个业务场景使用到微服务间的调用"><a href="#你在项目中哪个业务场景使用到微服务间的调用" class="headerlink" title="你在项目中哪个业务场景使用到微服务间的调用"></a>你在项目中哪个业务场景使用到微服务间的调用</h2><p>交友微服务  添加好友，在交友微服务中调用用户微服务的更改粉丝数与关注数的方法。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-my-work0 (6)" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/04/20/my-work0 (6)/" class="article-date">
      <time datetime="2019-04-20T14:58:54.611Z" itemprop="datePublished">2019-04-20</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="第6章-密码加密与微服务鉴权JWT"><a href="#第6章-密码加密与微服务鉴权JWT" class="headerlink" title="第6章-密码加密与微服务鉴权JWT"></a>第6章-密码加密与微服务鉴权JWT</h1><p>学习目标：</p>
<ul>
<li>能够使用BCrypt密码加密算法实现注册与登陆功能</li>
<li>能够说出常见的认证机制</li>
<li>能够说出JWT的组成部分，以及使用JWT的优点</li>
<li>能够使用JJWT 创建和解析token</li>
<li>能够使用JJWT完成微服务鉴权</li>
</ul>
<h1 id="1-BCrypt密码加密"><a href="#1-BCrypt密码加密" class="headerlink" title="1 BCrypt密码加密"></a>1 BCrypt密码加密</h1><h2 id="1-1-准备工作"><a href="#1-1-准备工作" class="headerlink" title="1.1 准备工作"></a>1.1 准备工作</h2><p>任何应用考虑到安全，绝不能明文的方式保存密码。密码应该通过哈希算法进行加密。有很多标准的算法比如SHA或者MD5，结合salt(盐)是一个不错的选择。 Spring Security 提供了BCryptPasswordEncoder类,实现Spring的PasswordEncoder接口使用BCrypt强哈希方法来加密密码。</p>
<p>BCrypt强哈希方法 每次加密的结果都不一样。</p>
<p>（1）tensquare_user工程的pom引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>（2）添加配置类  （资源/工具类中提供）</p>
<p>我们在添加了spring security依赖后，所有的地址都被spring security所控制了，我们目前只是需要用到BCrypt密码加密的部分，所以我们要添加一个配置类，配置为所有地址都可以匿名访问。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 安全配置类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http</span><br><span class="line">                .authorizeRequests()</span><br><span class="line">                .antMatchers(<span class="string">"/**"</span>).permitAll()</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and().csrf().disable();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（3）修改tensquare_user工程的Application,  配置bean </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> BCryptPasswordEncoder <span class="title">bcryptPasswordEncoder</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> BCryptPasswordEncoder();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="1-2-管理员密码加密"><a href="#1-2-管理员密码加密" class="headerlink" title="1.2 管理员密码加密"></a>1.2 管理员密码加密</h2><h3 id="1-2-1-新增管理员密码加密"><a href="#1-2-1-新增管理员密码加密" class="headerlink" title="1.2.1 新增管理员密码加密"></a>1.2.1 新增管理员密码加密</h3><p>修改tensquare_user工程的AdminService </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">BCryptPasswordEncoder encoder;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(Admin admin)</span> </span>&#123;</span><br><span class="line">	admin.setId(idWorker.nextId()+<span class="string">""</span>); <span class="comment">//主键值</span></span><br><span class="line">	<span class="comment">//密码加密</span></span><br><span class="line">	String newpassword = encoder.encode(admin.getPassword());<span class="comment">//加密后的密码</span></span><br><span class="line">	admin.setPassword(newpassword);			</span><br><span class="line">	adminDao.save(admin);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-2-2-管理员登陆密码校验"><a href="#1-2-2-管理员登陆密码校验" class="headerlink" title="1.2.2 管理员登陆密码校验"></a>1.2.2 管理员登陆密码校验</h3><p>（1）AdminDao增加方法定义</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Admin <span class="title">findByLoginname</span><span class="params">(String loginname)</span></span>;</span><br></pre></td></tr></table></figure>
<p>（2）AdminService增加方法 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据登陆名和密码查询</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> loginname</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> password</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Admin <span class="title">findByLoginnameAndPassword</span><span class="params">(String loginname, String password)</span></span>&#123;</span><br><span class="line">	Admin admin = adminDao.findByLoginname(loginname);</span><br><span class="line">	<span class="keyword">if</span>( admin!=<span class="keyword">null</span> &amp;&amp; encoder.matches(password,admin.getPassword()))&#123;</span><br><span class="line">		<span class="keyword">return</span> admin;</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（3）AdminController增加方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户登陆</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> loginname</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> password</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(value=<span class="string">"/login"</span>,method=RequestMethod.POST)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">login</span><span class="params">(@RequestBody Map&lt;String,String&gt; loginMap)</span></span>&#123;</span><br><span class="line">	Admin admin = adminService.findByLoginnameAndPassword(loginMap.get(<span class="string">"loginname"</span>), loginMap.get(<span class="string">"password"</span>));</span><br><span class="line">	<span class="keyword">if</span>(admin!=<span class="keyword">null</span>)&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">true</span>,StatusCode.OK,<span class="string">"登陆成功"</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">false</span>,StatusCode.LOGINERROR,<span class="string">"用户名或密码错误"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="1-3-用户密码加密"><a href="#1-3-用户密码加密" class="headerlink" title="1.3 用户密码加密"></a>1.3 用户密码加密</h2><h3 id="1-3-1-添加用户密码加密"><a href="#1-3-1-添加用户密码加密" class="headerlink" title="1.3.1 添加用户密码加密"></a>1.3.1 添加用户密码加密</h3><p>（4）修改tensquare_user工程的UserService 类，引入BCryptPasswordEncoder</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">BCryptPasswordEncoder encoder;</span><br></pre></td></tr></table></figure>
<p>（5）修改tensquare_user工程的UserService 类的add方法，添加密码加密的逻辑</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 增加</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> user</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> code</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(User user,String code)</span> </span>&#123;</span><br><span class="line">		........</span><br><span class="line">		........</span><br><span class="line">		........</span><br><span class="line">		<span class="comment">//密码加密</span></span><br><span class="line">		String newpassword = encoder.encode(user.getPassword());<span class="comment">//加密后的密码</span></span><br><span class="line">		user.setPassword(newpassword);</span><br><span class="line">		userDao.save(user);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>（4）测试运行后，添加数据</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"mobile"</span>: <span class="string">"13901238899"</span></span><br><span class="line">    <span class="string">"password"</span>: <span class="string">"123123"</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>数据库中的密码为以下形式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$2a$10$a/EYRjdKwQ6zjr0/HJ6RR.rcA1dwv1ys7Uso1xShUaBWlIWTyJl5S</span><br></pre></td></tr></table></figure>
<h3 id="1-3-2-用户登陆密码判断"><a href="#1-3-2-用户登陆密码判断" class="headerlink" title="1.3.2 用户登陆密码判断"></a>1.3.2 用户登陆密码判断</h3><p>（1）修改tensquare_user工程的UserDao接口，增加方法定义</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据手机号查询用户</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mobile</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">findByMobile</span><span class="params">(String mobile)</span></span>;</span><br></pre></td></tr></table></figure>
<p>（2）修改tensquare_user工程的UserService 类，增加方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据手机号和密码查询用户</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mobile</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> password</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">findByMobileAndPassword</span><span class="params">(String mobile,String password)</span></span>&#123;</span><br><span class="line">	User user = userDao.findByMobile(mobile);</span><br><span class="line">	<span class="keyword">if</span>(user!=<span class="keyword">null</span> &amp;&amp;  encoder.matches(password,user.getPassword()))&#123;</span><br><span class="line">		<span class="keyword">return</span> user;</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（4）修改tensquare_user工程的UserController类，增加login方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户登陆</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mobile</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> password</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(value=<span class="string">"/login"</span>,method=RequestMethod.POST)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">login</span><span class="params">(@RequestBody Map&lt;String,String&gt; loginMap)</span></span>&#123;</span><br><span class="line">        User user =                                    userService.findByMobileAndPassword(loginMap.get(<span class="string">"mobile"</span>),loginMap.get(<span class="string">"password"</span>));</span><br><span class="line">	<span class="keyword">if</span>(user!=<span class="keyword">null</span>)&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">true</span>,StatusCode.OK,<span class="string">"登陆成功"</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">false</span>,StatusCode.LOGINERROR,<span class="string">"用户名或密码错误"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（4）使用刚才新增加的账号进行测试，查看返回结果</p>
<h1 id="2-常见的认证机制"><a href="#2-常见的认证机制" class="headerlink" title="2 常见的认证机制"></a>2 常见的认证机制</h1><h2 id="2-1-HTTP-Basic-Auth"><a href="#2-1-HTTP-Basic-Auth" class="headerlink" title="2.1 HTTP Basic Auth"></a>2.1 HTTP Basic Auth</h2><p>​    HTTP Basic Auth简单点说明就是每次请求API时都提供用户的username和password，简言之，Basic Auth是配合RESTful API 使用的最简单的认证方式，只需提供用户名密码即可，但由于有把用户名密码暴露给第三方客户端的风险，在生产环境下被使用的越来越少。因此，在开发对外开放的RESTful API时，尽量避免采用HTTP Basic Auth</p>
<h2 id="2-2-Cookie-Auth"><a href="#2-2-Cookie-Auth" class="headerlink" title="2.2 Cookie Auth"></a>2.2 Cookie Auth</h2><p>​    Cookie认证机制就是为一次请求认证在服务端创建一个Session对象，同时在客户端的浏览器端创建了一个Cookie对象；通过客户端带上来Cookie对象来与服务器端的session对象匹配来实现状态管理的。默认的，当我们关闭浏览器的时候，cookie会被删除。但可以通过修改cookie 的expire time使cookie在一定时间内有效；</p>
<p><img src="image/7-1.jpg" alt> </p>
<h2 id="2-3-OAuth"><a href="#2-3-OAuth" class="headerlink" title="2.3 OAuth"></a>2.3 OAuth</h2><p>​    OAuth（开放授权）是一个开放的授权标准，允许用户让第三方应用访问该用户在某一web服务上存储的私密的资源（如照片，视频，联系人列表），而无需将用户名和密码提供给第三方应用。</p>
<p>​    OAuth允许用户提供一个令牌，而不是用户名和密码来访问他们存放在特定服务提供者的数据。每一个令牌授权一个特定的第三方系统（例如，视频编辑网站)在特定的时段（例如，接下来的2小时内）内访问特定的资源（例如仅仅是某一相册中的视频）。这样，OAuth让用户可以授权第三方网站访问他们存储在另外服务提供者的某些特定信息，而非所有内容</p>
<p>下面是OAuth2.0的流程：</p>
<p><img src="image/7-2.jpg" alt></p>
<p>​    这种基于OAuth的认证机制适用于个人消费者类的互联网产品，如社交类APP等应用，但是不太适合拥有自有认证权限管理的企业应用。</p>
<h2 id="2-4-Token-Auth"><a href="#2-4-Token-Auth" class="headerlink" title="2.4 Token Auth"></a>2.4 Token Auth</h2><p>使用基于 Token 的身份验证方法，在服务端不需要存储用户的登录记录。大概的流程是这样的：</p>
<ol>
<li>客户端使用用户名跟密码请求登录</li>
<li>服务端收到请求，去验证用户名与密码</li>
<li>验证成功后，服务端会签发一个 Token，再把这个 Token 发送给客户端</li>
<li>客户端收到 Token 以后可以把它存储起来，比如放在 Cookie 里</li>
<li>客户端每次向服务端请求资源的时候需要带着服务端签发的 Token</li>
<li>服务端收到请求，然后去验证客户端请求里面带着的 Token，如果验证成功，就向客户端返回请求的数据</li>
</ol>
<p><img src="image/7-3.jpg" alt> </p>
<p>Token Auth的优点</p>
<p>Token机制相对于Cookie机制又有什么好处呢？</p>
<ul>
<li><strong>支持跨域访问</strong>: Cookie是不允许垮域访问的，这一点对Token机制是不存在的，前提是传输的用户认证信息通过HTTP头传输.</li>
<li><strong>无状态(也称：服务端可扩展行)</strong>:Token机制在服务端不需要存储session信息，因为Token 自身包含了所有登录用户的信息，只需要在客户端的cookie或本地介质存储状态信息.</li>
<li><strong>更适用CDN</strong>: 可以通过内容分发网络请求你服务端的所有资料（如：javascript，HTML,图片等），而你的服务端只要提供API即可.</li>
<li><strong>去耦</strong>: 不需要绑定到一个特定的身份验证方案。Token可以在任何地方生成，只要在你的API被调用的时候，你可以进行Token生成调用即可.</li>
<li><strong>更适用于移动应用</strong>: 当你的客户端是一个原生平台（iOS, Android，Windows 8等）时，Cookie是不被支持的（你需要通过Cookie容器进行处理），这时采用Token认证机制就会简单得多。</li>
<li><strong>CSRF</strong>:因为不再依赖于Cookie，所以你就不需要考虑对CSRF（跨站请求伪造）的防范。</li>
<li><strong>性能</strong>: 一次网络往返时间（通过数据库查询session信息）总比做一次HMACSHA256计算 的Token验证和解析要费时得多.</li>
<li><strong>不需要为登录页面做特殊处理</strong>: 如果你使用Protractor 做功能测试的时候，不再需要为登录页面做特殊处理.</li>
<li><strong>基于标准化</strong>:你的API可以采用标准化的 JSON Web Token (JWT). 这个标准已经存在多个后端库（.NET, Ruby, Java,Python, PHP）和多家公司的支持（如：Firebase,Google, Microsoft）.</li>
</ul>
<h1 id="3-基于JWT的Token认证机制实现"><a href="#3-基于JWT的Token认证机制实现" class="headerlink" title="3 基于JWT的Token认证机制实现"></a>3 基于JWT的Token认证机制实现</h1><h2 id="3-1-什么是JWT"><a href="#3-1-什么是JWT" class="headerlink" title="3.1 什么是JWT"></a>3.1 什么是JWT</h2><p>​    JSON Web Token（JWT）是一个非常轻巧的规范。这个规范允许我们使用JWT在用户和服务器之间传递安全可靠的信息。 token==》令牌</p>
<h2 id="3-2-JWT组成"><a href="#3-2-JWT组成" class="headerlink" title="3.2 JWT组成"></a>3.2 JWT组成</h2><p>一个JWT实际上就是一个字符串，它由三部分组成，头部、载荷与签名。</p>
<p><strong>头部（Header）</strong></p>
<p>头部用于描述关于该JWT的最基本的信息，例如其类型以及签名所用的算法等。这也可以被表示成一个JSON对象。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"typ"</span>:<span class="string">"JWT"</span>,<span class="attr">"alg"</span>:<span class="string">"HS256"</span>&#125;</span><br></pre></td></tr></table></figure>
<p>在头部指明了签名算法是HS256算法。 我们进行BASE64编码</p>
<p><a href="http://tool.oschina.net/encrypt?type=3" target="_blank" rel="noopener">http://tool.oschina.net/encrypt?type=3</a></p>
<p><a href="http://base64.xpcha.com/，" target="_blank" rel="noopener">http://base64.xpcha.com/，</a></p>
<p>编码后的字符串如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9</span><br></pre></td></tr></table></figure>
<blockquote>
<p>小知识：Base64是一种基于64个可打印字符来表示二进制数据的表示方法。由于2的6次方等于64，所以每6个比特为一个单元，对应某个可打印字符。三个字节有24个比特，对应于4个Base64单元，即3个字节需要用4个可打印字符来表示。JDK 中提供了非常方便的 <strong>BASE64Encoder</strong> 和 <strong>BASE64Decoder</strong>，用它们可以非常方便的完成基于 BASE64 的编码和解码</p>
</blockquote>
<p><strong>载荷（playload）</strong></p>
<p>载荷就是存放有效信息的地方。这个名字像是特指飞机上承载的货品，这些有效信息包含三个部分</p>
<p>（1）标准中注册的声明（建议但不强制使用）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">iss: jwt签发者</span><br><span class="line">sub: jwt所面向的用户</span><br><span class="line">aud: 接收jwt的一方</span><br><span class="line">exp: jwt的过期时间，这个过期时间必须要大于签发时间</span><br><span class="line">nbf: 定义在什么时间之前，该jwt都是不可用的.</span><br><span class="line">iat: jwt的签发时间</span><br><span class="line">jti: jwt的唯一身份标识，主要用来作为一次性token,从而回避重放攻击。</span><br></pre></td></tr></table></figure>
<p>（2）公共的声明</p>
<p>公共的声明可以添加任何的信息，一般添加用户的相关信息或其他业务需要的必要信息.但不建议添加敏感信息，因为该部分在客户端可解密.   </p>
<p>（3）私有的声明</p>
<p>私有声明是提供者和消费者所共同定义的声明，一般不建议存放敏感信息，因为base64是对称解密的，意味着该部分信息可以归类为明文信息。</p>
<p>这个指的就是自定义的claim。比如前面那个结构举例中的admin和name都属于自定的claim。这些claim跟JWT标准规定的claim区别在于：JWT规定的claim，JWT的接收方在拿到JWT之后，都知道怎么对这些标准的claim进行验证(还不知道是否能够验证)；而private claims不会验证，除非明确告诉接收方要对这些claim进行验证以及规则才行。</p>
<p>定义一个payload:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;sub&quot;:&quot;1234567890&quot;,&quot;name&quot;:&quot;John Doe&quot;,&quot;admin&quot;:true&#125;</span><br></pre></td></tr></table></figure>
<p>然后将其进行base64编码，得到Jwt的第二部分。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9</span><br></pre></td></tr></table></figure>
<p><strong>签证（signature）</strong></p>
<p>jwt的第三部分是一个签证信息，这个签证信息由三部分组成：</p>
<blockquote>
<p>header (base64后的)</p>
<p>payload (base64后的)</p>
<p>secret:秘钥 自定义的（打死也不能告诉别人）</p>
</blockquote>
<p>这个部分需要base64编码后的header和base64编码后的payload使用.连接组成的字符串，然后通过header中声明的加密方式进行加盐secret组合加密，然后就构成了jwt的第三部分。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ</span><br></pre></td></tr></table></figure>
<p>将这三部分用.连接成一个完整的字符串,构成了最终的jwt:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ</span><br></pre></td></tr></table></figure>
<p><strong>注意：secret是保存在服务器端的，jwt的签发生成也是在服务器端的，secret就是用来进行jwt的签发和jwt的验证，所以，它就是你服务端的私钥，在任何场景都不应该流露出去。一旦客户端得知这个secret, 那就意味着客户端是可以自我签发jwt了。</strong></p>
<h1 id="4-Java的JJWT实现JWT"><a href="#4-Java的JJWT实现JWT" class="headerlink" title="4 Java的JJWT实现JWT"></a>4 Java的JJWT实现JWT</h1><h2 id="4-1-什么是JJWT"><a href="#4-1-什么是JJWT" class="headerlink" title="4.1 什么是JJWT"></a>4.1 什么是JJWT</h2><p>​    JJWT是一个提供端到端的JWT创建和验证的Java库。永远免费和开源(Apache License，版本2.0)，JJWT很容易使用和理解。它被设计成一个以建筑为中心的流畅界面，隐藏了它的大部分复杂性。</p>
<h2 id="4-2-JJWT快速入门"><a href="#4-2-JJWT快速入门" class="headerlink" title="4.2 JJWT快速入门"></a>4.2 JJWT快速入门</h2><h3 id="4-2-1-token的创建"><a href="#4-2-1-token的创建" class="headerlink" title="4.2.1 token的创建"></a>4.2.1 token的创建</h3><p>（1）创建maven工程，引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.jsonwebtoken<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jjwt<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.6.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>（2）创建类CreateJwtTest，用于生成token</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CreateJwtTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        JwtBuilder builder= Jwts.builder().setId(<span class="string">"888"</span>)</span><br><span class="line">                .setSubject(<span class="string">"小白"</span>)</span><br><span class="line">                .setIssuedAt(<span class="keyword">new</span> Date())</span><br><span class="line">                .signWith(SignatureAlgorithm.HS256,<span class="string">"itcast"</span>);</span><br><span class="line">        System.out.println( builder.compact() );</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>setIssuedAt用于设置签发时间</p>
<p>signWith用于设置签名秘钥</p>
<p>（3）测试运行，输出如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eyJhbGciOiJIUzI1NiJ9.eyJqdGkiOiI4ODgiLCJzdWIiOiLlsI_nmb0iLCJpYXQiOjE1MjM0MTM0NTh9.gq0J-cOM_qCNqU_s-d_IrRytaNenesPmqAIhQpYXHZk</span><br></pre></td></tr></table></figure>
<p>再次运行，会发现每次运行的结果是不一样的，因为我们的载荷中包含了时间。</p>
<h3 id="4-2-2-token的解析"><a href="#4-2-2-token的解析" class="headerlink" title="4.2.2 token的解析"></a>4.2.2 token的解析</h3><p>​    我们刚才已经创建了token ，在web应用中这个操作是由服务端进行然后发给客户端，客户端在下次向服务端发送请求时需要携带这个token（这就好像是拿着一张门票一样），那服务端接到这个token 应该解析出token中的信息（例如用户id）,根据这些信息查询数据库返回相应的结果。</p>
<p>创建ParseJwtTest</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ParseJwtTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String token=<span class="string">"eyJhbGciOiJIUzI1NiJ9.eyJqdGkiOiI4ODgiLCJzdWIiOiLlsI_nmb0iLCJpYXQiOjE1MjM0MTM0NTh9.gq0J-cOM_qCNqU_s-d_IrRytaNenesPmqAIhQpYXHZk"</span>;</span><br><span class="line">        Claims claims = Jwts.parser().setSigningKey(<span class="string">"itcast"</span>).parseClaimsJws(token).getBody();</span><br><span class="line">        System.out.println(<span class="string">"id:"</span>+claims.getId());</span><br><span class="line">        System.out.println(<span class="string">"subject:"</span>+claims.getSubject());</span><br><span class="line">        System.out.println(<span class="string">"IssuedAt:"</span>+claims.getIssuedAt());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>试着将token或签名秘钥篡改一下，会发现运行时就会报错，所以解析token也就是验证token </p>
<h3 id="4-2-3-token过期校验"><a href="#4-2-3-token过期校验" class="headerlink" title="4.2.3 token过期校验"></a>4.2.3 token过期校验</h3><p>有很多时候，我们并不希望签发的token是永久生效的，所以我们可以为token添加一个过期时间。</p>
<p>创建CreateJwtTest2</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CreateJwtTest2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//为了方便测试，我们将过期时间设置为1分钟</span></span><br><span class="line">        <span class="keyword">long</span> now = System.currentTimeMillis();<span class="comment">//当前时间</span></span><br><span class="line">        <span class="keyword">long</span> exp = now + <span class="number">1000</span>*<span class="number">60</span>;<span class="comment">//过期时间为1分钟</span></span><br><span class="line">        JwtBuilder builder= Jwts.builder().setId(<span class="string">"888"</span>)</span><br><span class="line">                .setSubject(<span class="string">"小白"</span>)</span><br><span class="line">                .setIssuedAt(<span class="keyword">new</span> Date())</span><br><span class="line">                .signWith(SignatureAlgorithm.HS256,<span class="string">"itcast"</span>)</span><br><span class="line">          		.setExpiration(<span class="keyword">new</span> Date(exp));</span><br><span class="line">        System.out.println( builder.compact() );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>setExpiration 方法用于设置过期时间</p>
<p>修改ParseJwtTest</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ParseJwtTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String compactJws=<span class="string">"eyJhbGciOiJIUzI1NiJ9.eyJqdGkiOiI4ODgiLCJzdWIiOiLlsI_nmb0iLCJpYXQiOjE1MjM0MTY1NjksImV4cCI6MTUyMzQxNjYyOX0.Tk91b6mvyjpKcldkic8DgXz0zsPFFnRgTgkgcAsa9cc"</span>;</span><br><span class="line">        Claims claims = Jwts.parser().setSigningKey(<span class="string">"itcast"</span>).parseClaimsJws(compactJws).getBody();</span><br><span class="line">        System.out.println(<span class="string">"id:"</span>+claims.getId());</span><br><span class="line">        System.out.println(<span class="string">"subject:"</span>+claims.getSubject());</span><br><span class="line">        SimpleDateFormat sdf=<span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd hh:mm:ss"</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"签发时间:"</span>+sdf.format(claims.getIssuedAt()));</span><br><span class="line">        System.out.println(<span class="string">"过期时间:"</span>+sdf.format(claims.getExpiration()));</span><br><span class="line">        System.out.println(<span class="string">"当前时间:"</span>+sdf.format(<span class="keyword">new</span> Date()) );</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试运行，当未过期时可以正常读取，当过期时会引发io.jsonwebtoken.ExpiredJwtException异常。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread &quot;main&quot; io.jsonwebtoken.ExpiredJwtException: JWT expired at 2018-06-08T21:44:55+0800. Current time: 2018-06-08T21:44:56+0800</span><br><span class="line">	at io.jsonwebtoken.impl.DefaultJwtParser.parse(DefaultJwtParser.java:365)</span><br><span class="line">	at io.jsonwebtoken.impl.DefaultJwtParser.parse(DefaultJwtParser.java:458)</span><br><span class="line">	at io.jsonwebtoken.impl.DefaultJwtParser.parseClaimsJws(DefaultJwtParser.java:518)</span><br><span class="line">	at cn.itcast.demo.ParseJwtTest.main(ParseJwtTest.java:13)</span><br></pre></td></tr></table></figure>
<h3 id="4-2-4-自定义claims"><a href="#4-2-4-自定义claims" class="headerlink" title="4.2.4 自定义claims"></a>4.2.4 自定义claims</h3><p>我们刚才的例子只是存储了id和subject两个信息，如果你想存储更多的信息（例如角色）可以定义自定义claims   创建CreateJwtTest3 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CreateJwtTest3</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//为了方便测试，我们将过期时间设置为1分钟</span></span><br><span class="line">        <span class="keyword">long</span> now = System.currentTimeMillis();<span class="comment">//当前时间</span></span><br><span class="line">        <span class="keyword">long</span> exp = now + <span class="number">1000</span>*<span class="number">60</span>;<span class="comment">//过期时间为1分钟</span></span><br><span class="line">        JwtBuilder builder= Jwts.builder().setId(<span class="string">"888"</span>)</span><br><span class="line">                .setSubject(<span class="string">"小白"</span>)</span><br><span class="line">                .setIssuedAt(<span class="keyword">new</span> Date())</span><br><span class="line">                .signWith(SignatureAlgorithm.HS256,<span class="string">"itcast"</span>)</span><br><span class="line">                .setExpiration(<span class="keyword">new</span> Date(exp))</span><br><span class="line">                .claim(<span class="string">"roles"</span>,<span class="string">"admin"</span>)</span><br><span class="line">                .claim(<span class="string">"logo"</span>,<span class="string">"logo.png"</span>);</span><br><span class="line">        System.out.println( builder.compact() );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>修改ParseJwtTest</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ParseJwtTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String compactJws=<span class="string">"eyJhbGciOiJIUzI1NiJ9.eyJqdGkiOiI4ODgiLCJzdWIiOiLlsI_nmb0iLCJpYXQiOjE1MjM0MTczMjMsImV4cCI6MTUyMzQxNzM4Mywicm9sZXMiOiJhZG1pbiIsImxvZ28iOiJsb2dvLnBuZyJ9.b11p4g4rE94rqFhcfzdJTPCORikqP_1zJ1MP8KihYTQ"</span>;</span><br><span class="line">        Claims claims = Jwts.parser().setSigningKey(<span class="string">"itcast"</span>).parseClaimsJws(compactJws).getBody();</span><br><span class="line">        System.out.println(<span class="string">"id:"</span>+claims.getId());</span><br><span class="line">        System.out.println(<span class="string">"subject:"</span>+claims.getSubject());</span><br><span class="line">        System.out.println(<span class="string">"roles:"</span>+claims.get(<span class="string">"roles"</span>));</span><br><span class="line">        System.out.println(<span class="string">"logo:"</span>+claims.get(<span class="string">"logo"</span>));</span><br><span class="line"></span><br><span class="line">        SimpleDateFormat sdf=<span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd hh:mm:ss"</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"签发时间:"</span>+sdf.format(claims.getIssuedAt()));</span><br><span class="line">        System.out.println(<span class="string">"过期时间:"</span>+sdf.format(claims.getExpiration()));</span><br><span class="line">        System.out.println(<span class="string">"当前时间:"</span>+sdf.format(<span class="keyword">new</span> Date()) );</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="5-十次方微服务鉴权"><a href="#5-十次方微服务鉴权" class="headerlink" title="5 十次方微服务鉴权"></a>5 十次方微服务鉴权</h1><h2 id="5-1-JWT工具类编写"><a href="#5-1-JWT工具类编写" class="headerlink" title="5.1 JWT工具类编写"></a>5.1 JWT工具类编写</h2><p>（1）tensquare_common工程引入依赖（考虑到工具类的通用性）</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.jsonwebtoken<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jjwt<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.6.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>（2）修改tensquare_common工程，创建util.JwtUtil</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConfigurationProperties</span>(<span class="string">"jwt.config"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String key ;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> ttl ;<span class="comment">//一个小时</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setKey</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.key = key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getTtl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ttl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTtl</span><span class="params">(<span class="keyword">long</span> ttl)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.ttl = ttl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成JWT</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> subject</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">createJWT</span><span class="params">(String id, String subject, String roles)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> nowMillis = System.currentTimeMillis();</span><br><span class="line">        Date now = <span class="keyword">new</span> Date(nowMillis);</span><br><span class="line">        JwtBuilder builder = Jwts.builder().setId(id)</span><br><span class="line">                .setSubject(subject)</span><br><span class="line">                .setIssuedAt(now)</span><br><span class="line">                .signWith(SignatureAlgorithm.HS256, key).claim(<span class="string">"roles"</span>, roles);</span><br><span class="line">        <span class="keyword">if</span> (ttl &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            builder.setExpiration( <span class="keyword">new</span> Date( nowMillis + ttl));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> builder.compact();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解析JWT</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jwtStr</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Claims <span class="title">parseJWT</span><span class="params">(String jwtStr)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span>  Jwts.parser()</span><br><span class="line">                .setSigningKey(key)</span><br><span class="line">                .parseClaimsJws(jwtStr)</span><br><span class="line">                .getBody();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（3）修改tensquare_user工程的application.yml,  添加配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">jwt:</span></span><br><span class="line"><span class="attr"> config:</span></span><br><span class="line"><span class="attr">    key:</span> <span class="string">itcast</span></span><br><span class="line"><span class="attr">    ttl:</span> <span class="number">360000</span></span><br></pre></td></tr></table></figure>
<h2 id="5-2-管理员登陆后台签发token"><a href="#5-2-管理员登陆后台签发token" class="headerlink" title="5.2 管理员登陆后台签发token"></a>5.2 管理员登陆后台签发token</h2><p>（1）配置bean .修改tensquare_user工程Application类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> JwtUtil <span class="title">jwtUtil</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> util.JwtUtil();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（2）修改AdminController的login方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> JwtUtil jwtUtil;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户登陆</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> loginname</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> password</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(value=<span class="string">"/login"</span>,method=RequestMethod.POST)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">login</span><span class="params">(@RequestBody Map&lt;String,String&gt; loginMap)</span></span>&#123;</span><br><span class="line">	Admin admin = adminService.findByLoginnameAndPassword(loginMap.get(<span class="string">"loginname"</span>), loginMap.get(<span class="string">"password"</span>));</span><br><span class="line">	<span class="keyword">if</span>(admin!=<span class="keyword">null</span>)&#123;</span><br><span class="line">		<span class="comment">//生成token</span></span><br><span class="line">		String token = jwtUtil.createJWT(admin.getId(), admin.getLoginname(), <span class="string">"admin"</span>);</span><br><span class="line">		Map map=<span class="keyword">new</span> HashMap();</span><br><span class="line">		map.put(<span class="string">"token"</span>,token);</span><br><span class="line">		map.put(<span class="string">"name"</span>,admin.getLoginname());<span class="comment">//登陆名</span></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">true</span>,StatusCode.OK,<span class="string">"登陆成功"</span>,map);</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">false</span>,StatusCode.LOGINERROR,<span class="string">"用户名或密码错误"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试运行结果</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"flag"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"code"</span>: <span class="number">20000</span>,</span><br><span class="line">  <span class="attr">"message"</span>: <span class="string">"登陆成功"</span>,</span><br><span class="line">  <span class="attr">"data"</span>: &#123;</span><br><span class="line">    <span class="attr">"token"</span>: <span class="string">"eyJhbGciOiJIUzI1NiJ9.eyJqdGkiOiI5ODQzMjc1MDc4ODI5MzgzNjgiLCJzdWIiOiJ4aWFvbWkiLCJpYXQiOjE1MjM1MjQxNTksInJvbGVzIjoiYWRtaW4iLCJleHAiOjE1MjM1MjQ1MTl9._YF3oftRNTbq9WCD8Jg1tqcez3cSWoQiDIxMuPmp73o"</span>,</span><br><span class="line">    <span class="attr">"name"</span>:<span class="string">"admin"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="5-3-删除用户功能鉴权"><a href="#5-3-删除用户功能鉴权" class="headerlink" title="5.3 删除用户功能鉴权"></a>5.3 删除用户功能鉴权</h2><p>需求：删除用户，必须拥有管理员权限，否则不能删除。</p>
<p>前后端约定：前端请求微服务时需要添加头信息Authorization ,内容为Bearer+空格+token </p>
<p>（1）修改UserController的delete方法  ，判断请求中的头信息，提取token并验证权限。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> HttpServletRequest request;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 删除</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(value=<span class="string">"/&#123;id&#125;"</span>,method= RequestMethod.DELETE)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">delete</span><span class="params">(@PathVariable String id )</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	String authHeader = request.getHeader(<span class="string">"Authorization"</span>);<span class="comment">//获取头信息</span></span><br><span class="line">	<span class="keyword">if</span>(authHeader==<span class="keyword">null</span>)&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">false</span>,StatusCode.ACCESSERROR,<span class="string">"权限不足"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(!authHeader.startsWith(<span class="string">"Bearer "</span>))&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">false</span>,StatusCode.ACCESSERROR,<span class="string">"权限不足"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	String token=authHeader.substring(<span class="number">7</span>);<span class="comment">//提取token</span></span><br><span class="line">	Claims claims = jwtUtil.parseJWT(token);</span><br><span class="line">	<span class="keyword">if</span>(claims==<span class="keyword">null</span>)&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">false</span>,StatusCode.ACCESSERROR,<span class="string">"权限不足"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(!<span class="string">"admin"</span>.equals(claims.get(<span class="string">"roles"</span>)))&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">false</span>,StatusCode.ACCESSERROR,<span class="string">"权限不足"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	userService.deleteById(id);</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">true</span>,StatusCode.OK,<span class="string">"删除成功"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="5-4-使用拦截器方式实现token鉴权"><a href="#5-4-使用拦截器方式实现token鉴权" class="headerlink" title="5.4 使用拦截器方式实现token鉴权"></a>5.4 使用拦截器方式实现token鉴权</h2><p>如果我们每个方法都去写一段代码，冗余度太高，不利于维护，那如何做使我们的代码看起来更清爽呢？我们可以将这段代码放入拦截器去实现</p>
<h3 id="5-4-1-添加拦截器"><a href="#5-4-1-添加拦截器" class="headerlink" title="5.4.1 添加拦截器"></a>5.4.1 添加拦截器</h3><p>Spring为我们提供了org.springframework.web.servlet.handler.HandlerInterceptorAdapter这个适配器，继承此类，可以非常方便的实现自己的拦截器。他有三个方法：</p>
<p>分别实现预处理、后处理（调用了Service并返回ModelAndView，但未进行页面渲染）、返回处理（已经渲染了页面）<br>在preHandle中，可以进行编码、安全控制等处理；<br>在postHandle中，有机会修改ModelAndView；<br>在afterCompletion中，可以根据ex是否为null判断是否发生了异常，进行日志记录。 </p>
<p>（1）创建拦截器类。创建 com.tensquare.user.filter.JwtFilter</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtFilter</span> <span class="keyword">extends</span> <span class="title">HandlerInterceptorAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> JwtUtil jwtUtil;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span></span></span><br><span class="line"><span class="function">			<span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"经过了拦截器"</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（2）配置拦截器类,创建com.tensquare.user.ApplicationConfig</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationConfig</span> <span class="keyword">extends</span> <span class="title">WebMvcConfigurationSupport</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> JwtFilter jwtFilter;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> </span>&#123;</span><br><span class="line">		registry.addInterceptor(jwtFilter).</span><br><span class="line">				addPathPatterns(<span class="string">"/**"</span>).</span><br><span class="line">				excludePathPatterns(<span class="string">"/**/login"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-4-2-拦截器验证token"><a href="#5-4-2-拦截器验证token" class="headerlink" title="5.4.2 拦截器验证token"></a>5.4.2 拦截器验证token</h3><p>（1）修改拦截器类  JwtFilter</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtFilter</span> <span class="keyword">extends</span> <span class="title">HandlerInterceptorAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> JwtUtil jwtUtil;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span>	<span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"经过了拦截器"</span>);</span><br><span class="line">		<span class="keyword">final</span> String authHeader = request.getHeader(<span class="string">"Authorization"</span>);</span><br><span class="line">		<span class="keyword">if</span> (authHeader != <span class="keyword">null</span> &amp;&amp;  authHeader.startsWith(<span class="string">"Bearer "</span>)) &#123;</span><br><span class="line">			<span class="keyword">final</span> String token = authHeader.substring(<span class="number">7</span>); <span class="comment">// The part after "Bearer "</span></span><br><span class="line">			Claims claims = jwtUtil.parseJWT(token);</span><br><span class="line">			<span class="keyword">if</span> (claims != <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="keyword">if</span>(<span class="string">"admin"</span>.equals(claims.get(<span class="string">"roles"</span>)))&#123;<span class="comment">//如果是管理员</span></span><br><span class="line">					request.setAttribute(<span class="string">"admin_claims"</span>, claims);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span>(<span class="string">"user"</span>.equals(claims.get(<span class="string">"roles"</span>)))&#123;<span class="comment">//如果是用户</span></span><br><span class="line">					request.setAttribute(<span class="string">"user_claims"</span>, claims);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（2）修改UserController的delete方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 删除</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(value=<span class="string">"/&#123;id&#125;"</span>,method= RequestMethod.DELETE)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">delete</span><span class="params">(@PathVariable String id )</span></span>&#123;</span><br><span class="line">	Claims claims=(Claims) request.getAttribute(<span class="string">"admin_claims"</span>);</span><br><span class="line">	<span class="keyword">if</span>(claims==<span class="keyword">null</span>)&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">true</span>,StatusCode.ACCESSRROR,<span class="string">"无权访问"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	userService.deleteById(id);</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">true</span>,StatusCode.OK,<span class="string">"删除成功"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="6-发布信息验证Token"><a href="#6-发布信息验证Token" class="headerlink" title="6 发布信息验证Token"></a>6 发布信息验证Token</h1><h2 id="6-1-用户登陆签发-JWT"><a href="#6-1-用户登陆签发-JWT" class="headerlink" title="6.1 用户登陆签发 JWT"></a>6.1 用户登陆签发 JWT</h2><p>（2）修改UserController，引入JwtUtil    修改login方法  ，返回token，昵称，头像等信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> JwtUtil jwtUtil;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户登陆</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mobile</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> password</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(value=<span class="string">"/login"</span>,method=RequestMethod.POST)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">login</span><span class="params">(@RequestBody Map&lt;String,String&gt; loginMap)</span></span>&#123;</span><br><span class="line">	User user = userService.findByMobileAndPassword(loginMap.get(<span class="string">"mobile"</span>),loginMap.get(<span class="string">"password"</span>));</span><br><span class="line">	<span class="keyword">if</span>(user!=<span class="keyword">null</span>)&#123;</span><br><span class="line">		String token = jwtUtil.createJWT(user.getId(), user.getNickname(), <span class="string">"user"</span>);</span><br><span class="line">		Map map=<span class="keyword">new</span> HashMap();</span><br><span class="line">		map.put(<span class="string">"token"</span>,token);</span><br><span class="line">		map.put(<span class="string">"name"</span>,user.getNickname());<span class="comment">//昵称</span></span><br><span class="line">		map.put(<span class="string">"avatar"</span>,user.getAvatar());<span class="comment">//头像</span></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">true</span>,StatusCode.OK,<span class="string">"登陆成功"</span>,map);</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">false</span>,StatusCode.LOGINERROR,<span class="string">"用户名或密码错误"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（4）测试运行  <a href="http://localhost:9008/user/login" target="_blank" rel="noopener">http://localhost:9008/user/login</a>  (POST) ，结果为如下形式</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"flag"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"code"</span>: <span class="number">20000</span>,</span><br><span class="line">  <span class="attr">"message"</span>: <span class="string">"登陆成功"</span>,</span><br><span class="line">  <span class="attr">"data"</span>: &#123;</span><br><span class="line">    <span class="attr">"token"</span>: <span class="string">"eyJhbGciOiJIUzI1NiJ9.eyJqdGkiOiI5ODM5ODc0ODk1MDcyNTAxNzYiLCJpYXQiOjE1MjM1MDIzMDEsInJvbGVzIjoidXNlciIsImV4cCI6MTUyMzUwMjY2MX0.QH-WMRgIAxHDcYReH7patg7qkcjc4ZuyDbHaIah-spQ"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"name"</span>:<span class="string">"小雅"</span>,</span><br><span class="line">  <span class="attr">"avatar"</span>:<span class="string">"......."</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="6-2-发布问题"><a href="#6-2-发布问题" class="headerlink" title="6.2 发布问题"></a>6.2 发布问题</h2><p>（1）修改tensquare_qa工程的QaApplication，增加bean</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> JwtUtil <span class="title">jwtUtil</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> util.JwtUtil();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（2）tensquare_qa工程配置文件application.yml增加配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">jwt:</span></span><br><span class="line"><span class="attr">  config:</span></span><br><span class="line"><span class="attr">    key:</span> <span class="string">itcast</span></span><br></pre></td></tr></table></figure>
<p>（3）增加拦截器类 （参考上面的拦截器代码）</p>
<p>（4）增加配置类ApplicationConfig  （参考上面的配置类代码）</p>
<p>（5）修改ProblemController的add方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> HttpServletRequest request;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 发布问题</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> problem</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(method=RequestMethod.POST)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">add</span><span class="params">(@RequestBody Problem problem  )</span></span>&#123;</span><br><span class="line">	Claims claims=(Claims)request.getAttribute(<span class="string">"user_claims"</span>);</span><br><span class="line">	<span class="keyword">if</span>(claims==<span class="keyword">null</span>)&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">false</span>,StatusCode.ACCESSERROR,<span class="string">"无权访问"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	problem.setUserid(claims.getId());</span><br><span class="line">	problemService.add(problem);</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">true</span>,StatusCode.OK,<span class="string">"增加成功"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="6-3-回答问题"><a href="#6-3-回答问题" class="headerlink" title="6.3 回答问题"></a>6.3 回答问题</h2><p>学员实现，步骤略</p>
<h2 id="6-4-发吐槽"><a href="#6-4-发吐槽" class="headerlink" title="6.4 发吐槽"></a>6.4 发吐槽</h2><p>学员实现，步骤略</p>
<h2 id="6-5-发文章"><a href="#6-5-发文章" class="headerlink" title="6.5 发文章"></a>6.5 发文章</h2><p>学员实现，步骤略</p>
<h1 id="面试问题"><a href="#面试问题" class="headerlink" title="面试问题"></a>面试问题</h1><h2 id="你是如何实现微服务鉴权的？"><a href="#你是如何实现微服务鉴权的？" class="headerlink" title="你是如何实现微服务鉴权的？"></a>你是如何实现微服务鉴权的？</h2><p>JWT实现微服务鉴权</p>
<h2 id="为什么使用JWT"><a href="#为什么使用JWT" class="headerlink" title="为什么使用JWT?"></a>为什么使用JWT?</h2><p>（1）模块之间零耦合</p>
<p>（2）鉴权逻辑执行效率高</p>
<p>（3）可以支持更多类型的客户端  （前端  H5  安卓  IOS）</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-my-work0 (5)" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/04/20/my-work0 (5)/" class="article-date">
      <time datetime="2019-04-20T14:58:54.591Z" itemprop="datePublished">2019-04-20</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="第5章-消息中间件RabbitMQ"><a href="#第5章-消息中间件RabbitMQ" class="headerlink" title="第5章-消息中间件RabbitMQ"></a>第5章-消息中间件RabbitMQ</h1><p>学习目标：</p>
<ul>
<li>能够说出消息队列的应用场景以及RabbitMQ的主要概念</li>
<li>完成RabbitMQ安装以及RabbitMQ三种模式的入门案例</li>
<li>完成用户注册，能够将消息发送给RabbitMQ</li>
<li>完成短信微服务，能够接收消息并调用阿里云通信完成短信发送</li>
</ul>
<h1 id="1-RabbitMQ简介"><a href="#1-RabbitMQ简介" class="headerlink" title="1 RabbitMQ简介"></a>1 RabbitMQ简介</h1><h2 id="1-1消息队列中间件简介"><a href="#1-1消息队列中间件简介" class="headerlink" title="1.1消息队列中间件简介"></a>1.1消息队列中间件简介</h2><p>​    消息队列中间件是分布式系统中重要的组件，主要解决应用耦合，异步消息，流量削锋等问题实现高性能，高可用，可伸缩和最终一致性[架构]   使用较多的消息队列有ActiveMQ，RabbitMQ，ZeroMQ，Kafka，MetaMQ，RocketMQ</p>
<p>以下介绍消息队列在实际应用中常用的使用场景：异步处理，应用解耦，流量削锋和消息通讯四个场景</p>
<h2 id="1-2什么是RabbitMQ"><a href="#1-2什么是RabbitMQ" class="headerlink" title="1.2什么是RabbitMQ"></a>1.2什么是RabbitMQ</h2><p>RabbitMQ 是一个由 Erlang 语言开发的 AMQP 的开源实现。</p>
<p>AMQP ：Advanced Message Queue，高级消息队列协议。它是应用层协议的一个开放标准，为面向消息的中间件设计，基于此协议的客户端与消息中间件可传递消息，并不受产品、开发语言等条件的限制。</p>
<p>RabbitMQ 最初起源于金融系统，用于在分布式系统中存储转发消息，在易用性、扩展性、高可用性等方面表现不俗。具体特点包括：</p>
<p>1.可靠性（Reliability）</p>
<p>RabbitMQ 使用一些机制来保证可靠性，如持久化、传输确认、发布确认。</p>
<p>2.灵活的路由（Flexible Routing）</p>
<p>在消息进入队列之前，通过 Exchange 来路由消息的。对于典型的路由功能，RabbitMQ 已经提供了一些内置的 Exchange 来实现。针对更复杂的路由功能，可以将多个 Exchange 绑定在一起，也通过插件机制实现自己的 Exchange 。</p>
<p>3.消息集群（Clustering）</p>
<p>多个 RabbitMQ 服务器可以组成一个集群，形成一个逻辑 Broker 。</p>
<p>4.高可用（Highly Available Queues）</p>
<p>队列可以在集群中的机器上进行镜像，使得在部分节点出问题的情况下队列仍然可用。</p>
<p>5.多种协议（Multi-protocol）</p>
<p>RabbitMQ 支持多种消息队列协议，比如 STOMP、MQTT 等等。</p>
<p>6.多语言客户端（Many Clients）</p>
<p>RabbitMQ 几乎支持所有常用语言，比如 Java、.NET、Ruby 等等。</p>
<p>7.管理界面（Management UI）</p>
<p>RabbitMQ 提供了一个易用的用户界面，使得用户可以监控和管理消息 Broker 的许多方面。</p>
<p>8.跟踪机制（Tracing）</p>
<p>如果消息异常，RabbitMQ 提供了消息跟踪机制，使用者可以找出发生了什么。</p>
<p>9.插件机制（Plugin System）</p>
<p>RabbitMQ 提供了许多插件，来从多方面进行扩展，也可以编写自己的插件。</p>
<h2 id="1-3架构图与主要概念"><a href="#1-3架构图与主要概念" class="headerlink" title="1.3架构图与主要概念"></a>1.3架构图与主要概念</h2><h3 id="1-3-1架构图"><a href="#1-3-1架构图" class="headerlink" title="1.3.1架构图"></a>1.3.1架构图</h3><p>Exchange:交换器</p>
<p>RoutingKey:通俗理解“消息队列名称”</p>
<p><img src="image\5-1.jpg" alt></p>
<h3 id="1-3-2主要概念"><a href="#1-3-2主要概念" class="headerlink" title="1.3.2主要概念"></a>1.3.2主要概念</h3><p><strong>RabbitMQ Server：</strong> 也叫broker server，它是一种传输服务。 他的角色就是维护一条从Producer到Consumer的路线，保证数据能够按照指定的方式进行传输。</p>
<p><strong>Producer：</strong> 消息生产者，如图A、B、C，数据的发送方。消息生产者连接RabbitMQ服务器然后将消息投递到Exchange。</p>
<p><strong>Consumer：</strong>消息消费者，如图1、2、3，数据的接收方。消息消费者订阅队列，RabbitMQ将Queue中的消息发送到消息消费者。</p>
<p><strong>Exchange：</strong>生产者将消息发送到Exchange（交换器），由Exchange将消息路由到一个或多个Queue中（或者丢弃）。Exchange并不存储消息。RabbitMQ中的Exchange有direct、fanout、topic、headers四种类型，每种类型对应不同的路由规则。</p>
<p><strong>Queue：</strong>（队列）是RabbitMQ的内部对象，用于存储消息。消息消费者就是通过订阅队列来获取消息的，RabbitMQ中的消息都只能存储在Queue中，生产者生产消息并最终投递到Queue中，消费者可以从Queue中获取消息并消费。多个消费者可以订阅同一个Queue，这时Queue中的消息会被平均分摊给多个消费者进行处理，而不是每个消费者都收到所有的消息并处理。</p>
<p><strong>RoutingKey：</strong>生产者在将消息发送给Exchange的时候，一般会指定一个routing key，来指定这个消息的路由规则，而这个routing key需要与Exchange Type及binding key联合使用才能最终生效。在Exchange Type与binding key固定的情况下（在正常使用时一般这些内容都是固定配置好的），我们的生产者就可以在发送消息给Exchange时，通过指定routing key来决定消息流向哪里。RabbitMQ为routing key设定的长度限制为255 bytes。</p>
<p><strong>Connection： （连接）</strong>：Producer和Consumer都是通过TCP连接到RabbitMQ Server的。以后我们可以看到，程序的起始处就是建立这个TCP连接。</p>
<p><strong>Channels： （信道）</strong>：它建立在上述的TCP连接中。数据流动都是在Channel中进行的。也就是说，一般情况是程序起始建立TCP连接，第二步就是建立这个Channel。</p>
<p><strong>VirtualHost：</strong>权限控制的基本单位，一个VirtualHost里面有若干Exchange和MessageQueue，以及指定被哪些user使用</p>
<h1 id="2-走进RabbitMQ"><a href="#2-走进RabbitMQ" class="headerlink" title="2 走进RabbitMQ"></a>2 走进RabbitMQ</h1><h2 id="2-1-RabbitMQ安装与启动"><a href="#2-1-RabbitMQ安装与启动" class="headerlink" title="2.1 RabbitMQ安装与启动"></a>2.1 RabbitMQ安装与启动</h2><h3 id="2-1-1-windows环境下的安装"><a href="#2-1-1-windows环境下的安装" class="headerlink" title="2.1.1 windows环境下的安装"></a>2.1.1 windows环境下的安装</h3><p>（1）下载并安装<a href="http://http//www.erlang.org/downloads" target="_blank" rel="noopener"> Eralng</a></p>
<p>配套软件中已提供otp_win64_20.2.exe   （以管理员身份运行安装）</p>
<p>（2）下载并安装rabbitmq</p>
<p>配套软件中已提供rabbitmq-server-3.7.4.exe。双击安装，注意不要安装在包含中文和空格的目录下！安装后window服务中就存在rabbitMQ了，并且是启动状态。</p>
<p>（3）安装管理界面（插件）</p>
<p>进入rabbitMQ安装目录的sbin目录，输入命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmq-plugins enable rabbitmq_management</span><br></pre></td></tr></table></figure>
<p>（4）重新启动服务</p>
<p>（5）打开浏览器，地址栏输入<a href="http://127.0.0.1:15672" target="_blank" rel="noopener">http://127.0.0.1:15672</a>  ,即可看到管理界面的登陆页</p>
<p><img src="image\5-2.jpg" alt></p>
<p>输入用户名和密码，都为guest  进入主界面：</p>
<p><img src="image\5-10.jpg" alt></p>
<p>最上侧的导航以此是：概览、连接、信道、交换器、队列、用户管理 </p>
<h3 id="2-1-2-docker环境下的安装"><a href="#2-1-2-docker环境下的安装" class="headerlink" title="2.1.2 docker环境下的安装"></a>2.1.2 docker环境下的安装</h3><p>（1）下载镜像：（此步省略）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull rabbitmq:management</span><br></pre></td></tr></table></figure>
<p>（2）创建容器，rabbitmq需要有映射以下端口:  5671   5672  4369  15671   15672   25672 </p>
<ul>
<li>15672 (if management plugin is enabled)</li>
<li>15671  management监听端口</li>
</ul>
<ul>
<li>5672, 5671 (AMQP 0-9-1 without and with TLS)</li>
<li>4369 (epmd)   epmd  代表 Erlang 端口映射守护进程</li>
<li>25672 (Erlang distribution)</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -di --name=tensquare_rabbitmq -p 5671:5671 -p 5672:5672 -p 4369:4369 -p 15671:15671 -p 15672:15672 -p 25672:25672 镜像id</span><br></pre></td></tr></table></figure>
<p>浏览器访问   <a href="http://192.168.184.134:15672/#/" target="_blank" rel="noopener">http://192.168.184.134:15672/#/</a></p>
<h2 id="2-2-直接模式（Direct）"><a href="#2-2-直接模式（Direct）" class="headerlink" title="2.2 直接模式（Direct）"></a>2.2 直接模式（Direct）</h2><h3 id="2-2-1-什么是Direct模式"><a href="#2-2-1-什么是Direct模式" class="headerlink" title="2.2.1 什么是Direct模式"></a>2.2.1 什么是Direct模式</h3><p>我们需要将消息发给唯一一个节点时使用这种模式，这是最简单的一种形式。</p>
<p><img src="image/5-4.jpg" alt> </p>
<p>任何发送到Direct Exchange的消息都会被转发到RouteKey中指定的Queue。</p>
<p>1.一般情况可以使用rabbitMQ自带的Exchange：””(该Exchange的名字为空字符串，下文称其为default Exchange)。</p>
<p>2.这种模式下不需要将Exchange进行任何绑定(binding)操作</p>
<p>3.消息传递时需要一个“RouteKey”，可以简单的理解为要发送到的队列名字。</p>
<p>4.如果vhost中不存在RouteKey中指定的队列名，则该消息会被抛弃。</p>
<h3 id="2-2-2-创建队列"><a href="#2-2-2-创建队列" class="headerlink" title="2.2.2 创建队列"></a>2.2.2 创建队列</h3><p>做下面的例子前，我们先建立一个叫itcast的队列。</p>
<p><img src="image/5-5.jpg" alt> </p>
<p>Durability：是否做持久化   Durable（持久）     transient（临时）</p>
<p>Auto delete : 是否自动删除</p>
<h3 id="2-2-3-代码实现-消息生产者"><a href="#2-2-3-代码实现-消息生产者" class="headerlink" title="2.2.3 代码实现-消息生产者"></a>2.2.3 代码实现-消息生产者</h3><p>（1）创建工程rabbitmq_demo，引入amqp起步依赖 ，pom.xml如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.1.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.reporting.outputEncoding</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>（2）编写配置文件application.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  rabbitmq:</span></span><br><span class="line"><span class="attr">    host:</span> <span class="number">192.168</span><span class="number">.184</span><span class="number">.134</span></span><br></pre></td></tr></table></figure>
<p>（3）编写启动类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(Application.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（4）编写测试类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</span><br><span class="line"><span class="meta">@SpringBootTest</span>(classes=Application.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MqTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSend</span><span class="params">()</span></span>&#123;</span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">"itcast"</span>,<span class="string">"我要红包"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行测试方法</p>
<h3 id="2-2-4-代码实现-消息消费者"><a href="#2-2-4-代码实现-消息消费者" class="headerlink" title="2.2.4 代码实现-消息消费者"></a>2.2.4 代码实现-消息消费者</h3><p>（1）编写消息消费者类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@RabbitListener</span>(queues=<span class="string">"itcast"</span> )</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Customer1</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitHandler</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showMessage</span><span class="params">(String message)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"itcast接收到消息："</span>+message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（2）运行启动类，可以在控制台看到刚才发送的消息</p>
<h3 id="2-2-5-测试"><a href="#2-2-5-测试" class="headerlink" title="2.2.5 测试"></a>2.2.5 测试</h3><p>开启多个消费者工程，测试运行消息生产者工程，会发现只有一个消费者工程可以接收到消息。</p>
<p>如何在IDEA中多次启动同一个程序呢？</p>
<p>（1）选择IDEA右上角的类名称按钮</p>
<p><img src="image/5_1.png" alt></p>
<p>（2）选择Edit Configurations </p>
<p><img src="image/5_2.png" alt></p>
<p>（3）在弹出窗口中取消单例模式  ，点击OK</p>
<p><img src="image/5_3.png" alt></p>
<p>（4）每次运行前修改application.yml，指定不同的端口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 9202</span><br></pre></td></tr></table></figure>
<p>运行后在控制台可以看到多个窗口</p>
<p><img src="image/5_4.png" alt></p>
<h2 id="2-3-分列模式（Fanout）"><a href="#2-3-分列模式（Fanout）" class="headerlink" title="2.3 分列模式（Fanout）"></a>2.3 分列模式（Fanout）</h2><h3 id="2-3-1-什么是分列（Fanout）模式"><a href="#2-3-1-什么是分列（Fanout）模式" class="headerlink" title="2.3.1 什么是分列（Fanout）模式"></a>2.3.1 什么是分列（Fanout）模式</h3><p>当我们需要将消息一次发给多个队列时，需要使用这种模式。如下图：</p>
<p><img src="image\5-6.jpg" alt> </p>
<p>任何发送到Fanout Exchange的消息都会被转发到与该Exchange绑定(Binding)的所有Queue上。</p>
<p>1.可以理解为路由表的模式</p>
<p>2.这种模式不需要RouteKey</p>
<p>3.这种模式需要提前将Exchange与Queue进行绑定，一个Exchange可以绑定多个Queue，一个Queue可以同多个Exchange进行绑定。</p>
<p>4.如果接受到消息的Exchange没有与任何Queue绑定，则消息会被抛弃。</p>
<h3 id="2-3-2-交换器绑定队列"><a href="#2-3-2-交换器绑定队列" class="headerlink" title="2.3.2 交换器绑定队列"></a>2.3.2 交换器绑定队列</h3><p>（1）在queue中添加队列itheima 和kudingyu</p>
<p>（2）新建交换器chuanzhi</p>
<p><img src="image/5_5.png" alt></p>
<p>（3）将kudingyu和itheima两个队列绑定到交换器chuanzhi</p>
<p><img src="image/5_6.png" alt></p>
<p>点击chuanzhi进入交换器管理界面</p>
<p><img src="image/5_7.png" alt></p>
<p>   点击Bindings添加绑定  itheima和kudingyu</p>
<p><img src="image/5_9.png" alt> 绑定后效果如下：</p>
<p><img src="image/5_8.png" alt></p>
<h3 id="2-3-3-代码实现-消息生产者"><a href="#2-3-3-代码实现-消息生产者" class="headerlink" title="2.3.3 代码实现-消息生产者"></a>2.3.3 代码实现-消息生产者</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSendFanout</span><span class="params">()</span></span>&#123;</span><br><span class="line">	rabbitTemplate.convertAndSend(<span class="string">"chuanzhi"</span>,<span class="string">""</span>, <span class="string">"分列模式走起"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-3-4-代码实现-消息消费者"><a href="#2-3-4-代码实现-消息消费者" class="headerlink" title="2.3.4 代码实现-消息消费者"></a>2.3.4 代码实现-消息消费者</h3><p>创建消息监听类，用于监听itheima的消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@RabbitListener</span>(queues=<span class="string">"itheima"</span> )</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Customer2</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RabbitHandler</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showMessage</span><span class="params">(String message)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"itheima接收到消息："</span>+message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建消息监听类，用于监听kudingyu的消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@RabbitListener</span>(queues=<span class="string">"kudingyu"</span> )</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Customer3</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RabbitHandler</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showMessage</span><span class="params">(String message)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"kudingyu接收到消息："</span>+message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-3-5-测试"><a href="#2-3-5-测试" class="headerlink" title="2.3.5 测试"></a>2.3.5 测试</h3><p>启动消费者工程，发送消息测试</p>
<p><img src="image/5_10.png" alt></p>
<h2 id="2-4-主题模式（Topic）"><a href="#2-4-主题模式（Topic）" class="headerlink" title="2.4 主题模式（Topic）"></a>2.4 主题模式（Topic）</h2><h3 id="2-4-1-什么是主题模式"><a href="#2-4-1-什么是主题模式" class="headerlink" title="2.4.1 什么是主题模式"></a>2.4.1 什么是主题模式</h3><p>任何发送到Topic Exchange的消息都会被转发到所有关心RouteKey中指定话题的Queue上</p>
<p><img src="image/5_11.png" alt></p>
<p>如上图所示<br>此类交换器使得来自不同的源头的消息可以到达一个对列，其实说的更明白一点就是模糊匹配的意思，例如：上图中红色对列的routekey为usa.#，#代表匹配任意字符，但是要想消息能到达此对列，usa.必须匹配后面的#好可以随意。图中usa.news usa.weather,都能找到红色队列，符号<code>#</code>匹配一个或多个词，符号<code>*</code>匹配不多不少一个词。因此<code>usa.#</code>能够匹配到<code>usa.news.XXX</code>，但是<code>usa.*</code>只会匹配到<code>usa.XXX</code>。<br>注：<br>交换器说到底是一个名称与队列绑定的列表。当消息发布到交换器时，实际上是由你所连接的信道，将消息路由键同交换器上绑定的列表进行比较，最后路由消息。</p>
<p><strong>任何发送到Topic Exchange的消息都会被转发到所有关心RouteKey中指定话题的Queue上</strong></p>
<p>1.这种模式较为复杂，简单来说，就是每个队列都有其关心的主题，所有的消息都带有一个“标题”(RouteKey)，Exchange会将消息转发到所有关注主题能与RouteKey模糊匹配的队列。</p>
<p>2.这种模式需要RouteKey，也许要提前绑定Exchange与Queue。</p>
<p>3.在进行绑定时，要提供一个该队列关心的主题，如“#.log.#”表示该队列关心所有涉及log的消息(一个RouteKey为”MQ.log.error”的消息会被转发到该队列)。</p>
<p>4.“#”表示0个或若干个关键字，“<em>”表示一个关键字。如“log.</em>”能与“log.warn”匹配，无法与“log.warn.timeout”匹配；但是“log.#”能与上述两者匹配。</p>
<p>5.同样，如果Exchange没有发现能够与RouteKey匹配的Queue，则会抛弃此消息</p>
<h3 id="2-4-2-创建队列与绑定"><a href="#2-4-2-创建队列与绑定" class="headerlink" title="2.4.2 创建队列与绑定"></a>2.4.2 创建队列与绑定</h3><p>（1）新建一个交换器   ，类型选择topic</p>
<p><img src="image/5_14.png" alt></p>
<p>（2）点击新建的交换器topictest </p>
<p><img src="image/5_15.png" alt></p>
<p>添加匹配规则，添加后列表如下：</p>
<p><img src="image/5_13.png" alt></p>
<h3 id="2-4-3-代码实现"><a href="#2-4-3-代码实现" class="headerlink" title="2.4.3 代码实现"></a>2.4.3 代码实现</h3><p>编写测试类方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSendTopic1</span><span class="params">()</span></span>&#123;</span><br><span class="line">    rabbitTemplate.convertAndSend(<span class="string">"topictest"</span>,<span class="string">"goods.aaa"</span>,<span class="string">"主题模式"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果：itcast接收到消息：主题模式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSendTopic2</span><span class="params">()</span></span>&#123;</span><br><span class="line">    rabbitTemplate.convertAndSend(<span class="string">"topictest"</span>,<span class="string">"article.content.log"</span>,<span class="string">"主题模式"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果：itheima接收到消息：主题模式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSendTopic3</span><span class="params">()</span></span>&#123;</span><br><span class="line">    rabbitTemplate.convertAndSend(<span class="string">"topictest"</span>,<span class="string">"goods.log"</span>,<span class="string">"主题模式"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<p>itheima接收到消息：主题模式<br>itcast接收到消息：主题模式<br>kudingyu接收到消息：主题模式</p>
<h1 id="3-用户微服务-用户注册"><a href="#3-用户微服务-用户注册" class="headerlink" title="3 用户微服务-用户注册"></a>3 用户微服务-用户注册</h1><h2 id="3-1-需求分析"><a href="#3-1-需求分析" class="headerlink" title="3.1 需求分析"></a>3.1 需求分析</h2><p>注册账号，用手机号注册，填写后发送短信验证码，填写短信验证码正确方可注册成功。</p>
<p><img src="image/5-9.jpg" alt> </p>
<p>我们这里所做的实际上就是消息生产者。</p>
<h2 id="3-2-代码生成"><a href="#3-2-代码生成" class="headerlink" title="3.2 代码生成"></a>3.2 代码生成</h2><p>（1）使用代码生成器生成用户微服务代码 tensquare_user</p>
<p>（2）拷贝到当前工程，并在父工程引入。</p>
<p>（3）修改Application类名称为UserApplication</p>
<p>（4）修改application.yml 中的端口为9008  ,url 为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jdbc:mysql://192.168.184.134:3306/tensquare_user?characterEncoding=UTF8</span><br></pre></td></tr></table></figure>
<p>（5）进行浏览器测试</p>
<h2 id="3-3-发送短信验证码"><a href="#3-3-发送短信验证码" class="headerlink" title="3.3 发送短信验证码"></a>3.3 发送短信验证码</h2><p>实现思路： 在用户微服务编写API ,生成手机验证码，存入Redis并发送到RabbitMQ</p>
<h3 id="3-3-1-准备工作"><a href="#3-3-1-准备工作" class="headerlink" title="3.3.1 准备工作"></a>3.3.1 准备工作</h3><p>（1）因为要用到缓存和消息队列，所以在用户微服务（tensquare_user）引入依赖redis和amqp的起步依赖。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>（2）修改application.yml ,在spring 节点下添加配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">redis:</span></span><br><span class="line"><span class="attr">  host:</span> <span class="number">192.168</span><span class="number">.184</span><span class="number">.134</span></span><br><span class="line"><span class="attr">rabbitmq:</span></span><br><span class="line"><span class="attr">  host:</span> <span class="number">192.168</span><span class="number">.184</span><span class="number">.134</span></span><br></pre></td></tr></table></figure>
<h3 id="3-3-2-代码实现"><a href="#3-3-2-代码实现" class="headerlink" title="3.3.2 代码实现"></a>3.3.2 代码实现</h3><p>（1）在UserService中新增方法，用于发送短信验证码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 发送短信验证码</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mobile 手机号</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendSms</span><span class="params">(String mobile)</span></span>&#123;</span><br><span class="line">	<span class="comment">//1.生成6位短信验证码</span></span><br><span class="line">	Random random=<span class="keyword">new</span> Random();</span><br><span class="line">	<span class="keyword">int</span> max=<span class="number">999999</span>;<span class="comment">//最大数</span></span><br><span class="line">	<span class="keyword">int</span> min=<span class="number">100000</span>;<span class="comment">//最小数</span></span><br><span class="line">	<span class="keyword">int</span> code = random.nextInt(max);<span class="comment">//随机生成</span></span><br><span class="line">	<span class="keyword">if</span>(code&lt;min)&#123;</span><br><span class="line">		code=code+min;</span><br><span class="line">	&#125;</span><br><span class="line">	System.out.println(mobile+<span class="string">"收到验证码是："</span>+code);</span><br><span class="line">	<span class="comment">//2.将验证码放入redis</span></span><br><span class="line">	redisTemplate.opsForValue().set(<span class="string">"smscode_"</span>+mobile, code+<span class="string">""</span> ,<span class="number">5</span>, TimeUnit.MINUTES );<span class="comment">//五分钟过期</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//3.将验证码和手机号发动到rabbitMQ中</span></span><br><span class="line">	Map&lt;String,String&gt; map=<span class="keyword">new</span> HashMap();</span><br><span class="line">	map.put(<span class="string">"mobile"</span>,mobile);</span><br><span class="line">	map.put(<span class="string">"code"</span>,code+<span class="string">""</span>);</span><br><span class="line">	rabbitTemplate.convertAndSend(<span class="string">"sms"</span>,map);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（2）UserController新增方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 发送短信验证码</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mobile</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(value=<span class="string">"/sendsms/&#123;mobile&#125;"</span>,method=RequestMethod.POST)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">sendsms</span><span class="params">(@PathVariable String mobile )</span></span>&#123;</span><br><span class="line">	userService.sendSms(mobile);</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">true</span>,StatusCode.OK,<span class="string">"发送成功"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（3）启动微服务，在rabbitMQ中创建名为sms的队列，测试API </p>
<h2 id="3-3-用户注册"><a href="#3-3-用户注册" class="headerlink" title="3.3 用户注册"></a>3.3 用户注册</h2><p>（1）UserService增加方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 增加</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> user 用户</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> code 用户填写的验证码</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(User user,String code)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//判断验证码是否正确</span></span><br><span class="line">	String syscode = (String)redisTemplate.opsForValue().get(<span class="string">"smscode_"</span> + user.getMobile()); <span class="comment">//提取系统正确的验证码</span></span><br><span class="line">	<span class="keyword">if</span>(syscode==<span class="keyword">null</span>)&#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"请点击获取短信验证码"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(!syscode.equals(code))&#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"验证码输入不正确"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	user.setId( idWorker.nextId()+<span class="string">""</span> );</span><br><span class="line">	user.setFollowcount(<span class="number">0</span>);<span class="comment">//关注数</span></span><br><span class="line">	user.setFanscount(<span class="number">0</span>);<span class="comment">//粉丝数</span></span><br><span class="line">	user.setOnline(<span class="number">0L</span>);<span class="comment">//在线时长</span></span><br><span class="line">	user.setRegdate(<span class="keyword">new</span> Date());<span class="comment">//注册日期</span></span><br><span class="line">	user.setUpdatedate(<span class="keyword">new</span> Date());<span class="comment">//更新日期</span></span><br><span class="line">	user.setLastdate(<span class="keyword">new</span> Date());<span class="comment">//最后登陆日期</span></span><br><span class="line"></span><br><span class="line">	userDao.save(user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（2）UserController增加方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户注册</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> user</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(value=<span class="string">"/register/&#123;code&#125;"</span>,method=RequestMethod.POST)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">register</span><span class="params">( @RequestBody User user  ,@PathVariable String code)</span></span>&#123;</span><br><span class="line">	userService.add(user,code);</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">true</span>,StatusCode.OK,<span class="string">"注册成功"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（3）测试</p>
<h1 id="4-短信微服务"><a href="#4-短信微服务" class="headerlink" title="4 短信微服务"></a>4 短信微服务</h1><h2 id="4-1-需求分析"><a href="#4-1-需求分析" class="headerlink" title="4.1 需求分析"></a>4.1 需求分析</h2><p>​    开发短信发送微服务，从rabbitMQ中提取消息，调用阿里大于短信接口实现短信发送 。（关于短信阿里大于，我们在前面的电商项目中已经讲解过，故账号申请等环节略过）</p>
<pre><code>我们这里实际做的就是消息的消费者.
</code></pre><h2 id="4-2-提取队列中的消息"><a href="#4-2-提取队列中的消息" class="headerlink" title="4.2 提取队列中的消息"></a>4.2 提取队列中的消息</h2><h3 id="4-2-1-工程搭建"><a href="#4-2-1-工程搭建" class="headerlink" title="4.2.1 工程搭建"></a>4.2.1 工程搭建</h3><p>（1）创建工程模块：tensquare_sms，pom.xml引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> 	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>（2）创建application.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span> </span><br><span class="line"><span class="attr">  port:</span> <span class="number">9009</span></span><br><span class="line"><span class="attr">spring:</span> </span><br><span class="line"><span class="attr">  application:</span>  </span><br><span class="line"><span class="attr">    name:</span> <span class="string">tensquare-sms</span> <span class="comment">#指定服务名</span></span><br><span class="line"><span class="attr">  rabbitmq:</span> </span><br><span class="line"><span class="attr">    host:</span> <span class="number">192.168</span><span class="number">.184</span><span class="number">.134</span></span><br></pre></td></tr></table></figure>
<p>（3）com.tensquare.sms 包下创建启动类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SmsApplication</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		SpringApplication.run(SmsApplication.class, args);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-2-2-消息监听类"><a href="#4-2-2-消息监听类" class="headerlink" title="4.2.2 消息监听类"></a>4.2.2 消息监听类</h3><p>（1）创建短信监听类，获取手机号和验证码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 短信监听类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@RabbitListener</span>(queues = <span class="string">"sms"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SmsListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  发送短信</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RabbitHandler</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendSms</span><span class="params">(Map&lt;String,String&gt; message)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"手机号："</span>+message.get(<span class="string">"mobile"</span>));</span><br><span class="line">        System.out.println(<span class="string">"验证码："</span>+message.get(<span class="string">"code"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（2）运行SmsApplication类，控制台显示手机号和验证码</p>
<h2 id="4-3-发送短信-阿里云通信"><a href="#4-3-发送短信-阿里云通信" class="headerlink" title="4.3 发送短信(阿里云通信)"></a>4.3 发送短信(阿里云通信)</h2><h3 id="4-3-1-阿里云通信简介"><a href="#4-3-1-阿里云通信简介" class="headerlink" title="4.3.1 阿里云通信简介"></a>4.3.1 阿里云通信简介</h3><p>​        阿里云通信（原名–阿里大于）是 阿里云旗下产品，融合了三大运营商的通信能力，通过将传统通信业务和能力与互联网相结合，创新融合阿里巴巴生态内容，全力为中小企业和开发者提供优质服务阿里大于提供包括短信、语音、流量直充、私密专线、店铺手机号等个性化服务。通过阿里大于打通三大运营商通信能力，全面融合阿里巴巴生态，以开放 API 及 SDK 的方式向开发者提供通信和数据服务，更好地支撑企业业务发展和创新服务。</p>
<h3 id="4-3-2-准备工作"><a href="#4-3-2-准备工作" class="headerlink" title="4.3.2 准备工作"></a>4.3.2 准备工作</h3><p>（1）在阿里云官网  <a href="http://www.alidayu.com" target="_blank" rel="noopener">www.alidayu.com</a> 注册账号</p>
<p>（2）手机下载”阿里云“APP，完成实名认证</p>
<p>（3）登陆阿里云，产品中选择”短信服务“</p>
<p>（4）申请签名</p>
<p>（5）申请模板</p>
<p>（6）创建 accessKey （注意保密！）</p>
<p>（7）充值  （没必要充太多，1至2元足矣，土豪请随意~）</p>
<h3 id="4-3-3-代码编写"><a href="#4-3-3-代码编写" class="headerlink" title="4.3.3 代码编写"></a>4.3.3 代码编写</h3><p>（1）创建工程模块tensquare_sms，pom.xml引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.aliyun<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aliyun-java-sdk-dysmsapi<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  		<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span> </span><br><span class="line">  		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.aliyun<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aliyun-java-sdk-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  		<span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>（2）修改application.yml ，增加配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">aliyun:</span> </span><br><span class="line"><span class="attr">  sms:</span> </span><br><span class="line"><span class="attr">    accessKeyId:</span> <span class="string">LTAIKwFq9lPHwLvh</span></span><br><span class="line"><span class="attr">    accessKeySecret:</span> <span class="string">不告诉你</span></span><br><span class="line"><span class="attr">    template_code:</span> <span class="string">SMS_149385475</span></span><br><span class="line"><span class="attr">    sign_name:</span> <span class="string">传智播客</span></span><br></pre></td></tr></table></figure>
<p>（3）创建短信工具类SmsUtil  （资源已提供，直接拷贝即可）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.tensquare.sms;</span><br><span class="line"><span class="keyword">import</span> com.aliyuncs.DefaultAcsClient;</span><br><span class="line"><span class="keyword">import</span> com.aliyuncs.IAcsClient;</span><br><span class="line"><span class="keyword">import</span> com.aliyuncs.dysmsapi.model.v20170525.QuerySendDetailsRequest;</span><br><span class="line"><span class="keyword">import</span> com.aliyuncs.dysmsapi.model.v20170525.QuerySendDetailsResponse;</span><br><span class="line"><span class="keyword">import</span> com.aliyuncs.dysmsapi.model.v20170525.SendSmsRequest;</span><br><span class="line"><span class="keyword">import</span> com.aliyuncs.dysmsapi.model.v20170525.SendSmsResponse;</span><br><span class="line"><span class="keyword">import</span> com.aliyuncs.exceptions.ClientException;</span><br><span class="line"><span class="keyword">import</span> com.aliyuncs.profile.DefaultProfile;</span><br><span class="line"><span class="keyword">import</span> com.aliyuncs.profile.IClientProfile;</span><br><span class="line"><span class="keyword">import</span> java.text.SimpleDateFormat;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.env.Environment;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 短信工具类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Administrator</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SmsUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//产品名称:云通信短信API产品,开发者无需替换</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String product = <span class="string">"Dysmsapi"</span>;</span><br><span class="line">    <span class="comment">//产品域名,开发者无需替换</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String domain = <span class="string">"dysmsapi.aliyuncs.com"</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Environment env;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// TODO 此处需要替换成开发者自己的AK(在阿里云访问控制台寻找)</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送短信</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> mobile 手机号</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> template_code 模板号</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sign_name 签名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> param 参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> ClientException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SendSmsResponse <span class="title">sendSms</span><span class="params">(String mobile,String template_code,String sign_name,String param)</span> <span class="keyword">throws</span> ClientException </span>&#123;</span><br><span class="line">    	String accessKeyId =env.getProperty(<span class="string">"aliyun.sms.accessKeyId"</span>);</span><br><span class="line">    String accessKeySecret = env.getProperty(<span class="string">"aliyun.sms.accessKeySecret"</span>);</span><br><span class="line">        <span class="comment">//可自助调整超时时间</span></span><br><span class="line">        System.setProperty(<span class="string">"sun.net.client.defaultConnectTimeout"</span>, <span class="string">"10000"</span>);</span><br><span class="line">        System.setProperty(<span class="string">"sun.net.client.defaultReadTimeout"</span>, <span class="string">"10000"</span>);</span><br><span class="line">        <span class="comment">//初始化acsClient,暂不支持region化</span></span><br><span class="line">        IClientProfile profile = DefaultProfile.getProfile(<span class="string">"cn-hangzhou"</span>, accessKeyId, accessKeySecret);</span><br><span class="line">        DefaultProfile.addEndpoint(<span class="string">"cn-hangzhou"</span>, <span class="string">"cn-hangzhou"</span>, product, domain);</span><br><span class="line">        IAcsClient acsClient = <span class="keyword">new</span> DefaultAcsClient(profile);</span><br><span class="line">        <span class="comment">//组装请求对象-具体描述见控制台-文档部分内容</span></span><br><span class="line">        SendSmsRequest request = <span class="keyword">new</span> SendSmsRequest();</span><br><span class="line">        <span class="comment">//必填:待发送手机号</span></span><br><span class="line">        request.setPhoneNumbers(mobile);</span><br><span class="line">        <span class="comment">//必填:短信签名-可在短信控制台中找到</span></span><br><span class="line">        request.setSignName(sign_name);</span><br><span class="line">        <span class="comment">//必填:短信模板-可在短信控制台中找到</span></span><br><span class="line">        request.setTemplateCode(template_code);</span><br><span class="line">        <span class="comment">//可选:模板中的变量替换JSON串,如模板内容为"亲爱的$&#123;name&#125;,您的验证码为$&#123;code&#125;"时,此处的值为</span></span><br><span class="line">        request.setTemplateParam(param);</span><br><span class="line">        <span class="comment">//选填-上行短信扩展码(无特殊需求用户请忽略此字段)</span></span><br><span class="line">        <span class="comment">//request.setSmsUpExtendCode("90997");</span></span><br><span class="line">        <span class="comment">//可选:outId为提供给业务方扩展字段,最终在短信回执消息中将此值带回给调用者</span></span><br><span class="line">        request.setOutId(<span class="string">"yourOutId"</span>);</span><br><span class="line">        <span class="comment">//hint 此处可能会抛出异常，注意catch</span></span><br><span class="line">        SendSmsResponse sendSmsResponse = acsClient.getAcsResponse(request);</span><br><span class="line">        <span class="keyword">return</span> sendSmsResponse;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span>  QuerySendDetailsResponse <span class="title">querySendDetails</span><span class="params">(String mobile,String bizId)</span> <span class="keyword">throws</span> ClientException </span>&#123;</span><br><span class="line">    	String accessKeyId =env.getProperty(<span class="string">"accessKeyId"</span>);</span><br><span class="line">        String accessKeySecret = env.getProperty(<span class="string">"accessKeySecret"</span>);</span><br><span class="line">        <span class="comment">//可自助调整超时时间</span></span><br><span class="line">        System.setProperty(<span class="string">"sun.net.client.defaultConnectTimeout"</span>, <span class="string">"10000"</span>);</span><br><span class="line">        System.setProperty(<span class="string">"sun.net.client.defaultReadTimeout"</span>, <span class="string">"10000"</span>);</span><br><span class="line">        <span class="comment">//初始化acsClient,暂不支持region化</span></span><br><span class="line">        IClientProfile profile = DefaultProfile.getProfile(<span class="string">"cn-hangzhou"</span>, accessKeyId, accessKeySecret);</span><br><span class="line">        DefaultProfile.addEndpoint(<span class="string">"cn-hangzhou"</span>, <span class="string">"cn-hangzhou"</span>, product, domain);</span><br><span class="line">        IAcsClient acsClient = <span class="keyword">new</span> DefaultAcsClient(profile);</span><br><span class="line">        <span class="comment">//组装请求对象</span></span><br><span class="line">        QuerySendDetailsRequest request = <span class="keyword">new</span> QuerySendDetailsRequest();</span><br><span class="line">        <span class="comment">//必填-号码</span></span><br><span class="line">        request.setPhoneNumber(mobile);</span><br><span class="line">        <span class="comment">//可选-流水号</span></span><br><span class="line">        request.setBizId(bizId);</span><br><span class="line">        <span class="comment">//必填-发送日期 支持30天内记录查询，格式yyyyMMdd</span></span><br><span class="line">        SimpleDateFormat ft = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyyMMdd"</span>);</span><br><span class="line">        request.setSendDate(ft.format(<span class="keyword">new</span> Date()));</span><br><span class="line">        <span class="comment">//必填-页大小</span></span><br><span class="line">        request.setPageSize(<span class="number">10L</span>);</span><br><span class="line">        <span class="comment">//必填-当前页码从1开始计数</span></span><br><span class="line">        request.setCurrentPage(<span class="number">1L</span>);</span><br><span class="line">        <span class="comment">//hint 此处可能会抛出异常，注意catch</span></span><br><span class="line">        QuerySendDetailsResponse querySendDetailsResponse = acsClient.getAcsResponse(request);</span><br><span class="line">        <span class="keyword">return</span> querySendDetailsResponse;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（4）修改消息监听类，完成短信发送</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 短信监听类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@RabbitListener</span>(queues = <span class="string">"sms"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SmsListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span>  SmsUtil smsUtil;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;aliyun.sms.template_code&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String templateCode;<span class="comment">//模板编号</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;aliyun.sms.sign_name&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String signName;<span class="comment">//签名</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitHandler</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendSms</span><span class="params">(Map&lt;String,String&gt; map)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"手机号："</span>+map.get(<span class="string">"mobile"</span>));</span><br><span class="line">        System.out.println(<span class="string">"验证码："</span>+map.get(<span class="string">"code"</span>));</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            smsUtil.sendSms(map.get(<span class="string">"mobile"</span>),templateCode,signName,<span class="string">"&#123;\"code\":"</span>+ map.get(<span class="string">"code"</span>) +<span class="string">"&#125;"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClientException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="面试问题总结"><a href="#面试问题总结" class="headerlink" title="面试问题总结"></a>面试问题总结</h1><h2 id="项目中哪部分业务用到消息队列"><a href="#项目中哪部分业务用到消息队列" class="headerlink" title="项目中哪部分业务用到消息队列"></a>项目中哪部分业务用到消息队列</h2><p>用户注册发送短信验证码</p>
<h2 id="项目中使用哪种消息队列？"><a href="#项目中使用哪种消息队列？" class="headerlink" title="项目中使用哪种消息队列？"></a>项目中使用哪种消息队列？</h2><p>rabbitMQ</p>
<h2 id="RabbitMQ-有哪几种发送模式"><a href="#RabbitMQ-有哪几种发送模式" class="headerlink" title="RabbitMQ 有哪几种发送模式"></a>RabbitMQ 有哪几种发送模式</h2><p>直接模式  分列模式  主题模式  headers</p>
<h2 id="项目中如何发送短信"><a href="#项目中如何发送短信" class="headerlink" title="项目中如何发送短信"></a>项目中如何发送短信</h2><p>阿里云通信（阿里大于）</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-my-work0 (4)" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/04/20/my-work0 (4)/" class="article-date">
      <time datetime="2019-04-20T14:58:54.584Z" itemprop="datePublished">2019-04-20</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="第4章-分布式搜索引擎ElasticSearch"><a href="#第4章-分布式搜索引擎ElasticSearch" class="headerlink" title="第4章-分布式搜索引擎ElasticSearch"></a>第4章-分布式搜索引擎ElasticSearch</h1><p>学习目标：</p>
<ul>
<li>了解Elasticsearch的特点及体系结构</li>
<li>完成Elasticsearch安装，能够调用RestAPI完成基本增删改查操作</li>
<li>完成Head插件安装，熟悉Head插件的基本使用方法</li>
<li>完成IK分词器的安装，能够使用IK分词器进行分词</li>
<li>使用SpringDataElasticsearch完成搜索微服务的开发（重点）</li>
<li>使用logstash完成mysql与Elasticsearch的同步工作</li>
<li>完成Elasticsearch在docker下的安装</li>
</ul>
<h1 id="1-ElasticSearch简介"><a href="#1-ElasticSearch简介" class="headerlink" title="1 ElasticSearch简介"></a>1 ElasticSearch简介</h1><h2 id="1-1-什么是ElasticSearch"><a href="#1-1-什么是ElasticSearch" class="headerlink" title="1.1 什么是ElasticSearch"></a>1.1 什么是ElasticSearch</h2><p>​    Elasticsearch是一个实时的分布式搜索和分析引擎。它可以帮助你用前所未有的速度去处理大规模数据。ElasticSearch是一个基于Lucene的搜索服务器。它提供了一个分布式多用户能力的全文搜索引擎，基于RESTful web接口。Elasticsearch是用Java开发的，并作为Apache许可条款下的开放源码发布，是当前流行的企业级搜索引擎。设计用于云计算中，能够达到实时搜索，稳定，可靠，快速，安装使用方便。</p>
<h2 id="1-2-ElasticSearch特点"><a href="#1-2-ElasticSearch特点" class="headerlink" title="1.2 ElasticSearch特点"></a>1.2 ElasticSearch特点</h2><p>（1）可以作为一个大型分布式集群（数百台服务器）技术，处理PB级数据，服务大公司；也可以运行在单机上</p>
<p>（2）将全文检索、数据分析以及分布式技术，合并在了一起，才形成了独一无二的ES；</p>
<p>（3）开箱即用的，部署简单</p>
<p>（4）全文检索，同义词处理，相关度排名，复杂数据分析，海量数据的近实时处理</p>
<h2 id="1-3-ElasticSearch体系结构"><a href="#1-3-ElasticSearch体系结构" class="headerlink" title="1.3 ElasticSearch体系结构"></a>1.3 ElasticSearch体系结构</h2><p>下表是Elasticsearch与MySQL数据库逻辑结构概念的对比</p>
<table>
<thead>
<tr>
<th>Elasticsearch</th>
<th>关系型数据库Mysql</th>
</tr>
</thead>
<tbody>
<tr>
<td>索引(index)</td>
<td>数据库(databases)</td>
</tr>
<tr>
<td>类型(type)</td>
<td>表(table)</td>
</tr>
<tr>
<td>文档(document)</td>
<td>行(row)</td>
</tr>
</tbody>
</table>
<h1 id="2-走进ElasticSearch"><a href="#2-走进ElasticSearch" class="headerlink" title="2 走进ElasticSearch"></a>2 走进ElasticSearch</h1><h2 id="2-1-ElasticSearch部署与启动"><a href="#2-1-ElasticSearch部署与启动" class="headerlink" title="2.1 ElasticSearch部署与启动"></a>2.1 ElasticSearch部署与启动</h2><p>下载ElasticSearch  5.6.8版本</p>
<p><a href="https://www.elastic.co/downloads/past-releases/elasticsearch-5-6-8" target="_blank" rel="noopener">https://www.elastic.co/downloads/past-releases/elasticsearch-5-6-8</a></p>
<p>资源\微服务资源\配套软件中也提供了安装包</p>
<p>无需安装，解压安装包后即可使用</p>
<p>在命令提示符下，进入ElasticSearch安装目录下的bin目录,执行命令</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">elasticsearch</span><br></pre></td></tr></table></figure>
<p>即可启动。</p>
<p>我们打开浏览器，在地址栏输入<a href="http://127.0.0.1:9200/" target="_blank" rel="noopener">http://127.0.0.1:9200/</a>  即可看到输出结果</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span> : <span class="string">"uV2glMR"</span>,</span><br><span class="line">  <span class="attr">"cluster_name"</span> : <span class="string">"elasticsearch"</span>,</span><br><span class="line">  <span class="attr">"cluster_uuid"</span> : <span class="string">"RdV7UTQZT1-Jnka9dDPsFg"</span>,</span><br><span class="line">  <span class="attr">"version"</span> : &#123;</span><br><span class="line">    <span class="attr">"number"</span> : <span class="string">"5.6.8"</span>,</span><br><span class="line">    <span class="attr">"build_hash"</span> : <span class="string">"688ecce"</span>,</span><br><span class="line">    <span class="attr">"build_date"</span> : <span class="string">"2018-02-16T16:46:30.010Z"</span>,</span><br><span class="line">    <span class="attr">"build_snapshot"</span> : <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"lucene_version"</span> : <span class="string">"6.6.1"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"tagline"</span> : <span class="string">"You Know, for Search"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-2-Postman调用RestAPI"><a href="#2-2-Postman调用RestAPI" class="headerlink" title="2.2 Postman调用RestAPI"></a>2.2 Postman调用RestAPI</h2><h3 id="2-2-1-新建索引"><a href="#2-2-1-新建索引" class="headerlink" title="2.2.1 新建索引"></a>2.2.1 新建索引</h3><p>例如我们要创建一个叫articleindex的索引  ,就以put方式提交</p>
<p> <a href="http://127.0.0.1:9200/articleindex/" target="_blank" rel="noopener">http://127.0.0.1:9200/articleindex/</a>  </p>
<h3 id="2-2-2-新建文档"><a href="#2-2-2-新建文档" class="headerlink" title="2.2.2 新建文档"></a>2.2.2 新建文档</h3><p>新建文档：</p>
<p>以post方式提交  <a href="http://127.0.0.1:9200/articleindex/article" target="_blank" rel="noopener">http://127.0.0.1:9200/articleindex/article</a> </p>
<p>body:  </p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"title"</span>:<span class="string">"SpringBoot2.0"</span>,</span><br><span class="line">	<span class="attr">"content"</span>:<span class="string">"发布啦"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>返回结果如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"_index"</span>: <span class="string">"articleindex"</span>,</span><br><span class="line">    <span class="attr">"_type"</span>: <span class="string">"article"</span>,</span><br><span class="line">    <span class="attr">"_id"</span>: <span class="string">"AWPKsdh0FdLZnId5S_F9"</span>,</span><br><span class="line">    <span class="attr">"_version"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"result"</span>: <span class="string">"created"</span>,</span><br><span class="line">    <span class="attr">"_shards"</span>: &#123;</span><br><span class="line">        <span class="attr">"total"</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="attr">"successful"</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">"failed"</span>: <span class="number">0</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"created"</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>_id是由系统自动生成的。  为了方便之后的演示，我们再次录入几条测试数据。</p>
<h3 id="2-2-3-查询全部文档"><a href="#2-2-3-查询全部文档" class="headerlink" title="2.2.3 查询全部文档"></a>2.2.3 查询全部文档</h3><p>查询某索引某类型的全部数据，以get方式请求</p>
<p><a href="http://127.0.0.1:9200/articleindex/article/_search" target="_blank" rel="noopener">http://127.0.0.1:9200/articleindex/article/_search</a>  返回结果如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"took"</span>: <span class="number">5</span>,</span><br><span class="line">    <span class="attr">"timed_out"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"_shards"</span>: &#123;</span><br><span class="line">        <span class="attr">"total"</span>: <span class="number">5</span>,</span><br><span class="line">        <span class="attr">"successful"</span>: <span class="number">5</span>,</span><br><span class="line">        <span class="attr">"skipped"</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">"failed"</span>: <span class="number">0</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"hits"</span>: &#123;</span><br><span class="line">        <span class="attr">"total"</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="attr">"max_score"</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">"hits"</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"_index"</span>: <span class="string">"articleindex"</span>,</span><br><span class="line">                <span class="attr">"_type"</span>: <span class="string">"article"</span>,</span><br><span class="line">                <span class="attr">"_id"</span>: <span class="string">"AWPKrI4pFdLZnId5S_F7"</span>,</span><br><span class="line">                <span class="attr">"_score"</span>: <span class="number">1</span>,</span><br><span class="line">                <span class="attr">"_source"</span>: &#123;</span><br><span class="line">                    <span class="attr">"title"</span>: <span class="string">"SpringBoot2.0"</span>,</span><br><span class="line">                    <span class="attr">"content"</span>: <span class="string">"发布啦"</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"_index"</span>: <span class="string">"articleindex"</span>,</span><br><span class="line">                <span class="attr">"_type"</span>: <span class="string">"article"</span>,</span><br><span class="line">                <span class="attr">"_id"</span>: <span class="string">"AWPKsdh0FdLZnId5S_F9"</span>,</span><br><span class="line">                <span class="attr">"_score"</span>: <span class="number">1</span>,</span><br><span class="line">                <span class="attr">"_source"</span>: &#123;</span><br><span class="line">                    <span class="attr">"title"</span>: <span class="string">"elasticsearch入门"</span>,</span><br><span class="line">                    <span class="attr">"content"</span>: <span class="string">"零基础入门"</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-2-4-修改文档"><a href="#2-2-4-修改文档" class="headerlink" title="2.2.4 修改文档"></a>2.2.4 修改文档</h3><p>以put形式提交以下地址：</p>
<p><a href="http://127.0.0.1:9200/articleindex/article/AWPKrI4pFdLZnId5S_F7" target="_blank" rel="noopener">http://127.0.0.1:9200/articleindex/article/AWPKrI4pFdLZnId5S_F7</a>  </p>
<p>body:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"title"</span>:<span class="string">"SpringBoot2.0正式版"</span>,</span><br><span class="line">	<span class="attr">"content"</span>:<span class="string">"发布了吗"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>返回结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"_index"</span>: <span class="string">"articleindex"</span>,</span><br><span class="line">    <span class="attr">"_type"</span>: <span class="string">"article"</span>,</span><br><span class="line">    <span class="attr">"_id"</span>: <span class="string">"AWPKsdh0FdLZnId5S_F9"</span>,</span><br><span class="line">    <span class="attr">"_version"</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">"result"</span>: <span class="string">"updated"</span>,</span><br><span class="line">    <span class="attr">"_shards"</span>: &#123;</span><br><span class="line">        <span class="attr">"total"</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="attr">"successful"</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">"failed"</span>: <span class="number">0</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"created"</span>: <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果我们在地址中的ID不存在，则会创建新文档</p>
<p>以put形式提交以下地址：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1:9200/articleindex/article/1</span><br></pre></td></tr></table></figure>
<p>body:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"title"</span>:<span class="string">"十次方课程好给力"</span>,</span><br><span class="line">	<span class="attr">"content"</span>:<span class="string">"知识点很多"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>返回信息：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"_index"</span>: <span class="string">"articleindex"</span>,</span><br><span class="line">    <span class="attr">"_type"</span>: <span class="string">"article"</span>,</span><br><span class="line">    <span class="attr">"_id"</span>: <span class="string">"1"</span>,</span><br><span class="line">    <span class="attr">"_version"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"result"</span>: <span class="string">"created"</span>,</span><br><span class="line">    <span class="attr">"_shards"</span>: &#123;</span><br><span class="line">        <span class="attr">"total"</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="attr">"successful"</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">"failed"</span>: <span class="number">0</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"created"</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再次查询，看是否有新增的这条文档</p>
<h3 id="2-2-5-按ID查询文档"><a href="#2-2-5-按ID查询文档" class="headerlink" title="2.2.5 按ID查询文档"></a>2.2.5 按ID查询文档</h3><p>GET方式请求</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1:9200/articleindex/article/1</span><br></pre></td></tr></table></figure>
<h3 id="2-2-6-基本匹配查询"><a href="#2-2-6-基本匹配查询" class="headerlink" title="2.2.6 基本匹配查询"></a>2.2.6 基本匹配查询</h3><p>根据某列进行查询  get方式提交下列地址：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1:9200/articleindex/article/_search?q=title:十次方课程好给力</span><br></pre></td></tr></table></figure>
<p>以上为按标题查询，返回结果如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"took"</span>: <span class="number">10</span>,</span><br><span class="line">    <span class="attr">"timed_out"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"_shards"</span>: &#123;</span><br><span class="line">        <span class="attr">"total"</span>: <span class="number">5</span>,</span><br><span class="line">        <span class="attr">"successful"</span>: <span class="number">5</span>,</span><br><span class="line">        <span class="attr">"skipped"</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">"failed"</span>: <span class="number">0</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"hits"</span>: &#123;</span><br><span class="line">        <span class="attr">"total"</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">"max_score"</span>: <span class="number">2.0649285</span>,</span><br><span class="line">        <span class="attr">"hits"</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"_index"</span>: <span class="string">"articleindex"</span>,</span><br><span class="line">                <span class="attr">"_type"</span>: <span class="string">"article"</span>,</span><br><span class="line">                <span class="attr">"_id"</span>: <span class="string">"1"</span>,</span><br><span class="line">                <span class="attr">"_score"</span>: <span class="number">2.0649285</span>,</span><br><span class="line">                <span class="attr">"_source"</span>: &#123;</span><br><span class="line">                    <span class="attr">"title"</span>: <span class="string">"十次方课程好给力"</span>,</span><br><span class="line">                    <span class="attr">"content"</span>: <span class="string">"知识点很多"</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-2-7-模糊查询"><a href="#2-2-7-模糊查询" class="headerlink" title="2.2.7 模糊查询"></a>2.2.7 模糊查询</h3><p>我们可以用*代表任意字符： </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1:9200/articleindex/article/_search?q=title:*s*</span><br></pre></td></tr></table></figure>
<h3 id="2-2-8-删除文档"><a href="#2-2-8-删除文档" class="headerlink" title="2.2.8 删除文档"></a>2.2.8 删除文档</h3><p>根据ID删除文档,删除ID为1的文档   DELETE方式提交</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1:9200/articleindex/article/1</span><br></pre></td></tr></table></figure>
<p>返回结果如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"found"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"_index"</span>: <span class="string">"articleindex"</span>,</span><br><span class="line">    <span class="attr">"_type"</span>: <span class="string">"article"</span>,</span><br><span class="line">    <span class="attr">"_id"</span>: <span class="string">"1"</span>,</span><br><span class="line">    <span class="attr">"_version"</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">"result"</span>: <span class="string">"deleted"</span>,</span><br><span class="line">    <span class="attr">"_shards"</span>: &#123;</span><br><span class="line">        <span class="attr">"total"</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="attr">"successful"</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">"failed"</span>: <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再次查看全部是否还存在此记录</p>
<h1 id="3-Head插件的安装与使用"><a href="#3-Head插件的安装与使用" class="headerlink" title="3 Head插件的安装与使用"></a>3 Head插件的安装与使用</h1><h2 id="3-1-Head插件安装"><a href="#3-1-Head插件安装" class="headerlink" title="3.1 Head插件安装"></a>3.1 Head插件安装</h2><p>如果都是通过rest请求的方式使用Elasticsearch，未免太过麻烦，而且也不够人性化。我们一般都会使用图形化界面来实现Elasticsearch的日常管理，最常用的就是Head插件</p>
<p>步骤1：</p>
<p>下载head插件：<a href="https://github.com/mobz/elasticsearch-head" target="_blank" rel="noopener">https://github.com/mobz/elasticsearch-head</a>  </p>
<p>配套资料中已提供。 elasticsearch-head-master.zip</p>
<p>步骤2：</p>
<p>解压到任意目录，但是要和elasticsearch的安装目录区别开。</p>
<p>步骤3：</p>
<p>安装node js  ,安装cnpm  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g cnpm --registry=https://registry.npm.taobao.org</span><br></pre></td></tr></table></figure>
<p>步骤4：</p>
<p>将grunt安装为全局命令 。Grunt是基于Node.js的项目构建工具。它可以自动运行你所设定的任务</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cnpm install -g grunt-cli</span><br></pre></td></tr></table></figure>
<p> 步骤5：安装依赖</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cnpm install</span><br></pre></td></tr></table></figure>
<p>步骤6：</p>
<p>进入head目录启动head，在命令提示符下输入命令</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grunt server</span><br></pre></td></tr></table></figure>
<p>步骤7：</p>
<p>打开浏览器，输入 <a href="http://localhost:9100" target="_blank" rel="noopener">http://localhost:9100</a></p>
<p>步骤8：</p>
<p>点击连接按钮没有任何相应，按F12发现有如下错误</p>
<p>No ‘Access-Control-Allow-Origin’ header is present on the requested resource</p>
<p>这个错误是由于elasticsearch默认不允许跨域调用，而elasticsearch-head是属于前端工程，所以报错。</p>
<p>我们这时需要修改elasticsearch的配置，让其允许跨域访问。</p>
<p>修改elasticsearch配置文件：elasticsearch.yml，增加以下两句命令：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http.cors.enabled: true</span><br><span class="line">http.cors.allow-origin: "*"</span><br></pre></td></tr></table></figure>
<p>此步为允许elasticsearch跨域访问     点击连接即可看到相关信息</p>
<p><img src="image/4_1.png" alt></p>
<h2 id="3-2-Head插件操作"><a href="#3-2-Head插件操作" class="headerlink" title="3.2 Head插件操作"></a>3.2 Head插件操作</h2><h3 id="3-2-1-新建索引"><a href="#3-2-1-新建索引" class="headerlink" title="3.2.1 新建索引"></a>3.2.1 新建索引</h3><p>选择“索引”选项卡，点击“新建索引”按钮</p>
<p><img src="image\4_2.png" alt></p>
<p>输入索引名称点击OK</p>
<h3 id="3-2-2-新建或修改文档"><a href="#3-2-2-新建或修改文档" class="headerlink" title="3.2.2 新建或修改文档"></a>3.2.2 新建或修改文档</h3><p>在复合查询中提交地址，输入内容，提交方式为PUT </p>
<p><img src="image\4_3.png" alt> </p>
<p>点击数据浏览  ,点击要查询的索引名称，右侧窗格中显示文档信息</p>
<p><img src="image/4_5.png" alt></p>
<p>点击文档信息：</p>
<p><img src="image/4_6.png" alt></p>
<p>我们再次回到刚才的界面</p>
<p><img src="image/4_7.png" alt></p>
<p>修改数据后重新提交请求 , 此时因为ID已经存在，所以执行的是修改操作。</p>
<p>重新查询此记录，发现版本为2 。也就是说每次修改后版本都会增加1.</p>
<p><img src="image/4_8.png" alt></p>
<h3 id="3-2-3-搜索文档"><a href="#3-2-3-搜索文档" class="headerlink" title="3.2.3 搜索文档"></a>3.2.3 搜索文档</h3><p><img src="image\4_9.png" alt></p>
<h3 id="3-2-4-删除文档"><a href="#3-2-4-删除文档" class="headerlink" title="3.2.4 删除文档"></a>3.2.4 删除文档</h3><p><img src="image\4_10.png" alt> </p>
<h1 id="4-IK分词器"><a href="#4-IK分词器" class="headerlink" title="4 IK分词器"></a>4 IK分词器</h1><h2 id="4-1什么是IK分词器"><a href="#4-1什么是IK分词器" class="headerlink" title="4.1什么是IK分词器"></a>4.1什么是IK分词器</h2><p>我们在浏览器地址栏输入<a href="http://127.0.0.1:9200/_analyze?analyzer=chinese&amp;pretty=true&amp;text=我是程序员，浏览器显示效果如下" target="_blank" rel="noopener">http://127.0.0.1:9200/_analyze?analyzer=chinese&amp;pretty=true&amp;text=我是程序员，浏览器显示效果如下</a></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"tokens"</span> : [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"token"</span> : <span class="string">"我"</span>,</span><br><span class="line">      <span class="attr">"start_offset"</span> : <span class="number">0</span>,</span><br><span class="line">      <span class="attr">"end_offset"</span> : <span class="number">1</span>,</span><br><span class="line">      <span class="attr">"type"</span> : <span class="string">"&lt;IDEOGRAPHIC&gt;"</span>,</span><br><span class="line">      <span class="attr">"position"</span> : <span class="number">0</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"token"</span> : <span class="string">"是"</span>,</span><br><span class="line">      <span class="attr">"start_offset"</span> : <span class="number">1</span>,</span><br><span class="line">      <span class="attr">"end_offset"</span> : <span class="number">2</span>,</span><br><span class="line">      <span class="attr">"type"</span> : <span class="string">"&lt;IDEOGRAPHIC&gt;"</span>,</span><br><span class="line">      <span class="attr">"position"</span> : <span class="number">1</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"token"</span> : <span class="string">"程"</span>,</span><br><span class="line">      <span class="attr">"start_offset"</span> : <span class="number">2</span>,</span><br><span class="line">      <span class="attr">"end_offset"</span> : <span class="number">3</span>,</span><br><span class="line">      <span class="attr">"type"</span> : <span class="string">"&lt;IDEOGRAPHIC&gt;"</span>,</span><br><span class="line">      <span class="attr">"position"</span> : <span class="number">2</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"token"</span> : <span class="string">"序"</span>,</span><br><span class="line">      <span class="attr">"start_offset"</span> : <span class="number">3</span>,</span><br><span class="line">      <span class="attr">"end_offset"</span> : <span class="number">4</span>,</span><br><span class="line">      <span class="attr">"type"</span> : <span class="string">"&lt;IDEOGRAPHIC&gt;"</span>,</span><br><span class="line">      <span class="attr">"position"</span> : <span class="number">3</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"token"</span> : <span class="string">"员"</span>,</span><br><span class="line">      <span class="attr">"start_offset"</span> : <span class="number">4</span>,</span><br><span class="line">      <span class="attr">"end_offset"</span> : <span class="number">5</span>,</span><br><span class="line">      <span class="attr">"type"</span> : <span class="string">"&lt;IDEOGRAPHIC&gt;"</span>,</span><br><span class="line">      <span class="attr">"position"</span> : <span class="number">4</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>默认的中文分词是将每个字看成一个词，这显然是不符合要求的，所以我们需要安装中文分词器来解决这个问题。</p>
<p>IK分词是一款国人开发的相对简单的中文分词器。虽然开发者自2012年之后就不在维护了，但在工程应用中IK算是比较流行的一款！我们今天就介绍一下IK中文分词器的使用。</p>
<h2 id="4-2-IK分词器安装"><a href="#4-2-IK分词器安装" class="headerlink" title="4.2 IK分词器安装"></a>4.2 IK分词器安装</h2><p>下载地址：<a href="https://github.com/medcl/elasticsearch-analysis-ik/releases" target="_blank" rel="noopener">https://github.com/medcl/elasticsearch-analysis-ik/releases</a>   下载5.6.8版本  课程配套资源也提供了:   资源\配套软件\elasticsearch\elasticsearch-analysis-ik-5.6.8.zip</p>
<p>（1）先将其解压，将解压后的elasticsearch文件夹重命名文件夹为ik </p>
<p>（2）将ik文件夹拷贝到elasticsearch/plugins 目录下。</p>
<p>（3）重新启动，即可加载IK分词器</p>
<h2 id="4-3-IK分词器测试"><a href="#4-3-IK分词器测试" class="headerlink" title="4.3 IK分词器测试"></a>4.3 IK分词器测试</h2><p>IK提供了两个分词算法ik_smart 和 ik_max_word</p>
<p>其中 ik_smart 为最少切分，ik_max_word为最细粒度划分</p>
<p>我们分别来试一下</p>
<p>（1）最小切分：在浏览器地址栏输入地址</p>
<p><a href="http://127.0.0.1:9200/_analyze?analyzer=ik_smart&amp;pretty=true&amp;text=我是程序员" target="_blank" rel="noopener">http://127.0.0.1:9200/_analyze?analyzer=ik_smart&amp;pretty=true&amp;text=我是程序员</a></p>
<p>输出的结果为：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"tokens"</span> : [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"token"</span> : <span class="string">"我"</span>,</span><br><span class="line">      <span class="attr">"start_offset"</span> : <span class="number">0</span>,</span><br><span class="line">      <span class="attr">"end_offset"</span> : <span class="number">1</span>,</span><br><span class="line">      <span class="attr">"type"</span> : <span class="string">"CN_CHAR"</span>,</span><br><span class="line">      <span class="attr">"position"</span> : <span class="number">0</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"token"</span> : <span class="string">"是"</span>,</span><br><span class="line">      <span class="attr">"start_offset"</span> : <span class="number">1</span>,</span><br><span class="line">      <span class="attr">"end_offset"</span> : <span class="number">2</span>,</span><br><span class="line">      <span class="attr">"type"</span> : <span class="string">"CN_CHAR"</span>,</span><br><span class="line">      <span class="attr">"position"</span> : <span class="number">1</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"token"</span> : <span class="string">"程序员"</span>,</span><br><span class="line">      <span class="attr">"start_offset"</span> : <span class="number">2</span>,</span><br><span class="line">      <span class="attr">"end_offset"</span> : <span class="number">5</span>,</span><br><span class="line">      <span class="attr">"type"</span> : <span class="string">"CN_WORD"</span>,</span><br><span class="line">      <span class="attr">"position"</span> : <span class="number">2</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（2）最细切分：在浏览器地址栏输入地址</p>
<p><a href="http://127.0.0.1:9200/_analyze?analyzer=ik_max_word&amp;pretty=true&amp;text=我是程序员" target="_blank" rel="noopener">http://127.0.0.1:9200/_analyze?analyzer=ik_max_word&amp;pretty=true&amp;text=我是程序员</a></p>
<p>输出的结果为：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"tokens"</span> : [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"token"</span> : <span class="string">"我"</span>,</span><br><span class="line">      <span class="attr">"start_offset"</span> : <span class="number">0</span>,</span><br><span class="line">      <span class="attr">"end_offset"</span> : <span class="number">1</span>,</span><br><span class="line">      <span class="attr">"type"</span> : <span class="string">"CN_CHAR"</span>,</span><br><span class="line">      <span class="attr">"position"</span> : <span class="number">0</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"token"</span> : <span class="string">"是"</span>,</span><br><span class="line">      <span class="attr">"start_offset"</span> : <span class="number">1</span>,</span><br><span class="line">      <span class="attr">"end_offset"</span> : <span class="number">2</span>,</span><br><span class="line">      <span class="attr">"type"</span> : <span class="string">"CN_CHAR"</span>,</span><br><span class="line">      <span class="attr">"position"</span> : <span class="number">1</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"token"</span> : <span class="string">"程序员"</span>,</span><br><span class="line">      <span class="attr">"start_offset"</span> : <span class="number">2</span>,</span><br><span class="line">      <span class="attr">"end_offset"</span> : <span class="number">5</span>,</span><br><span class="line">      <span class="attr">"type"</span> : <span class="string">"CN_WORD"</span>,</span><br><span class="line">      <span class="attr">"position"</span> : <span class="number">2</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"token"</span> : <span class="string">"程序"</span>,</span><br><span class="line">      <span class="attr">"start_offset"</span> : <span class="number">2</span>,</span><br><span class="line">      <span class="attr">"end_offset"</span> : <span class="number">4</span>,</span><br><span class="line">      <span class="attr">"type"</span> : <span class="string">"CN_WORD"</span>,</span><br><span class="line">      <span class="attr">"position"</span> : <span class="number">3</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"token"</span> : <span class="string">"员"</span>,</span><br><span class="line">      <span class="attr">"start_offset"</span> : <span class="number">4</span>,</span><br><span class="line">      <span class="attr">"end_offset"</span> : <span class="number">5</span>,</span><br><span class="line">      <span class="attr">"type"</span> : <span class="string">"CN_CHAR"</span>,</span><br><span class="line">      <span class="attr">"position"</span> : <span class="number">4</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-4-自定义词库"><a href="#4-4-自定义词库" class="headerlink" title="4.4 自定义词库"></a>4.4 自定义词库</h2><p>我们现在测试”传智播客”，浏览器的测试效果如下：</p>
<p><a href="http://127.0.0.1:9200/_analyze?analyzer=ik_smart&amp;pretty=true&amp;text=传智播客" target="_blank" rel="noopener">http://127.0.0.1:9200/_analyze?analyzer=ik_smart&amp;pretty=true&amp;text=传智播客</a></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"tokens"</span> : [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"token"</span> : <span class="string">"传"</span>,</span><br><span class="line">      <span class="attr">"start_offset"</span> : <span class="number">0</span>,</span><br><span class="line">      <span class="attr">"end_offset"</span> : <span class="number">1</span>,</span><br><span class="line">      <span class="attr">"type"</span> : <span class="string">"CN_CHAR"</span>,</span><br><span class="line">      <span class="attr">"position"</span> : <span class="number">0</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"token"</span> : <span class="string">"智"</span>,</span><br><span class="line">      <span class="attr">"start_offset"</span> : <span class="number">1</span>,</span><br><span class="line">      <span class="attr">"end_offset"</span> : <span class="number">2</span>,</span><br><span class="line">      <span class="attr">"type"</span> : <span class="string">"CN_CHAR"</span>,</span><br><span class="line">      <span class="attr">"position"</span> : <span class="number">1</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"token"</span> : <span class="string">"播"</span>,</span><br><span class="line">      <span class="attr">"start_offset"</span> : <span class="number">2</span>,</span><br><span class="line">      <span class="attr">"end_offset"</span> : <span class="number">3</span>,</span><br><span class="line">      <span class="attr">"type"</span> : <span class="string">"CN_CHAR"</span>,</span><br><span class="line">      <span class="attr">"position"</span> : <span class="number">2</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"token"</span> : <span class="string">"客"</span>,</span><br><span class="line">      <span class="attr">"start_offset"</span> : <span class="number">3</span>,</span><br><span class="line">      <span class="attr">"end_offset"</span> : <span class="number">4</span>,</span><br><span class="line">      <span class="attr">"type"</span> : <span class="string">"CN_CHAR"</span>,</span><br><span class="line">      <span class="attr">"position"</span> : <span class="number">3</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>默认的分词并没有识别“传智播客”是一个词。如果我们想让系统识别“传智播客”是一个词，需要编辑自定义词库。</p>
<p>步骤：</p>
<p>（1）进入elasticsearch/plugins/ik/config目录 </p>
<p>（2）新建一个my.dic文件，编辑内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">传智播客</span><br></pre></td></tr></table></figure>
<p>修改IKAnalyzer.cfg.xml（在ik/config目录下）</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">comment</span>&gt;</span>IK Analyzer 扩展配置<span class="tag">&lt;/<span class="name">comment</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--用户可以在这里配置自己的扩展字典 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"ext_dict"</span>&gt;</span>my.dic<span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">	 <span class="comment">&lt;!--用户可以在这里配置自己的扩展停止词字典--&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"ext_stopwords"</span>&gt;</span><span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>重新启动elasticsearch,通过浏览器测试分词效果</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"tokens"</span> : [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"token"</span> : <span class="string">"传智播客"</span>,</span><br><span class="line">      <span class="attr">"start_offset"</span> : <span class="number">0</span>,</span><br><span class="line">      <span class="attr">"end_offset"</span> : <span class="number">4</span>,</span><br><span class="line">      <span class="attr">"type"</span> : <span class="string">"CN_WORD"</span>,</span><br><span class="line">      <span class="attr">"position"</span> : <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="5-搜索微服务开发"><a href="#5-搜索微服务开发" class="headerlink" title="5 搜索微服务开发"></a>5 搜索微服务开发</h1><h2 id="5-1-需求分析"><a href="#5-1-需求分析" class="headerlink" title="5.1 需求分析"></a>5.1 需求分析</h2><h2 id="5-2-代码编写"><a href="#5-2-代码编写" class="headerlink" title="5.2 代码编写"></a>5.2 代码编写</h2><h3 id="5-2-1-模块搭建"><a href="#5-2-1-模块搭建" class="headerlink" title="5.2.1 模块搭建"></a>5.2.1 模块搭建</h3><p>（1）创建模块tensquare_search ，pom.xml引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.data<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-data-elasticsearch<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.tensquare<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tensquare_common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>（2）application.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">9007</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">tensquare-search</span> <span class="comment">#指定服务名</span></span><br><span class="line"><span class="attr">  data:</span></span><br><span class="line"><span class="attr">    elasticsearch:</span></span><br><span class="line"><span class="attr">      cluster-nodes:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:9300</span></span><br></pre></td></tr></table></figure>
<p>（3）创建包com.tensquare.search ，包下创建启动类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SearchApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		SpringApplication.run(SearchApplication.class, args);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> IdWorker <span class="title">idWorkker</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> IdWorker(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">	&#125;	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-2-2-添加文章"><a href="#5-2-2-添加文章" class="headerlink" title="5.2.2 添加文章"></a>5.2.2 添加文章</h3><p>（1）创建实体类</p>
<p>创建com.tensquare.search.pojo包，包下建立类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 文章实体类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Document</span>(indexName=<span class="string">"tensquare"</span>,type=<span class="string">"article"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Article</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> String id;<span class="comment">//ID</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Field</span>(index= <span class="keyword">true</span> ,analyzer=<span class="string">"ik_max_word"</span>,searchAnalyzer=<span class="string">"ik_max_word"</span>)</span><br><span class="line">    <span class="keyword">private</span> String title;<span class="comment">//标题</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Field</span>(index= <span class="keyword">true</span> ,analyzer=<span class="string">"ik_max_word"</span>,searchAnalyzer=<span class="string">"ik_max_word"</span>)</span><br><span class="line">    <span class="keyword">private</span> String content;<span class="comment">//文章正文</span></span><br><span class="line">   </span><br><span class="line">    <span class="keyword">private</span> String state;<span class="comment">//审核状态</span></span><br><span class="line">  </span><br><span class="line">	<span class="comment">//getter and setter ......</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（2）创建数据访问接口</p>
<p>创建com.tensquare.search.dao包，包下建立接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 文章数据访问层接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ArticleSearchDao</span> <span class="keyword">extends</span> <span class="title">ElasticsearchRepository</span>&lt;<span class="title">Article</span>,<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（3）创建业务逻辑类</p>
<p>创建com.tensquare.search.service包，包下建立类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArticleSearchService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ArticleSearchDao articleSearchDao;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 增加文章</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> article</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(Article article)</span></span>&#123;</span><br><span class="line">        articleSearchDao.save(article);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（4）创建控制器类</p>
<p>创建com.tensquare.search.controller包，包下建立类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@CrossOrigin</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/article"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArticleSearchController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ArticleSearchService articleSearchService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(method= RequestMethod.POST)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">save</span><span class="params">(@RequestBody Article article)</span></span>&#123;</span><br><span class="line">        articleSearchService.add(article);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">true</span>, StatusCode.OK, <span class="string">"操作成功"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-2-3-文章搜索"><a href="#5-2-3-文章搜索" class="headerlink" title="5.2.3 文章搜索"></a>5.2.3 文章搜索</h3><p>（1）ArticleSearchRepository新增方法定义</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 检索</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Page&lt;Article&gt; <span class="title">findByTitleOrContentLike</span><span class="params">(String title, String content, Pageable pageable)</span></span>;</span><br></pre></td></tr></table></figure>
<p>（2）ArticleSearchService新增方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Page&lt;Article&gt; <span class="title">findByTitleLike</span><span class="params">(String keywords, <span class="keyword">int</span> page, <span class="keyword">int</span> size)</span></span>&#123;</span><br><span class="line">   PageRequest pageRequest = PageRequest.of(page-<span class="number">1</span>, size);</span><br><span class="line">   <span class="keyword">return</span> articleSearchDao.findByTitleOrContentLike(keywords,keywords, pageRequest);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（3）ArticleSearchController方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value=<span class="string">"/search/&#123;keywords&#125;/&#123;page&#125;/&#123;size&#125;"</span>,method= RequestMethod.GET)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">findByTitleLike</span><span class="params">(@PathVariable String keywords, @PathVariable <span class="keyword">int</span> page, @PathVariable <span class="keyword">int</span> size)</span></span>&#123;</span><br><span class="line">        Page&lt;Article&gt; articlePage = articleSearchService.findByTitleLike(keywords,page,size);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">true</span>, StatusCode.OK, <span class="string">"查询成功"</span>,</span><br><span class="line">                <span class="keyword">new</span> PageResult&lt;Article&gt;(articlePage.getTotalElements(), articlePage.getContent()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="6-elasticsearch与MySQL数据同步"><a href="#6-elasticsearch与MySQL数据同步" class="headerlink" title="6 elasticsearch与MySQL数据同步"></a>6 elasticsearch与MySQL数据同步</h1><h2 id="6-1-Logstash"><a href="#6-1-Logstash" class="headerlink" title="6.1 Logstash"></a>6.1 Logstash</h2><h3 id="6-1-1什么是Logstash"><a href="#6-1-1什么是Logstash" class="headerlink" title="6.1.1什么是Logstash"></a>6.1.1什么是Logstash</h3><p>elasticsearch:存数据</p>
<p>Logstash：处理日志以及收集日志</p>
<p>ELK:<a href="https://www.cnblogs.com/aresxin/p/8035137.html" target="_blank" rel="noopener">https://www.cnblogs.com/aresxin/p/8035137.html</a></p>
<p>Logstash是一款轻量级的日志搜集处理框架，可以方便的把分散的、多样化的日志搜集起来，并进行自定义的处理，然后传输到指定的位置，比如某个服务器或者文件。</p>
<h3 id="6-1-2-Logstash安装与测试"><a href="#6-1-2-Logstash安装与测试" class="headerlink" title="6.1.2 Logstash安装与测试"></a>6.1.2 Logstash安装与测试</h3><p>解压，进入bin目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logstash -e &apos;input &#123; stdin &#123; &#125; &#125; output &#123; stdout &#123;&#125; &#125;&apos;</span><br></pre></td></tr></table></figure>
<p>控制台输入字符，随后就有日志输出</p>
<p><img src="image/4_11.png" alt></p>
<p>stdin，表示输入流，指从键盘输入</p>
<p>stdout，表示输出流，指从显示器输出</p>
<p>命令行参数: </p>
<p>-e 执行 </p>
<p>–config 或 -f 配置文件，后跟参数类型可以是一个字符串的配置或全路径文件名或全路径路径(如：/etc/logstash.d/，logstash会自动读取/etc/logstash.d/目录下所有*.conf 的文本文件，然后在自己内存里拼接成一个完整的大配置文件再去执行)</p>
<h2 id="6-2-MySQL数据导入Elasticsearch"><a href="#6-2-MySQL数据导入Elasticsearch" class="headerlink" title="6.2 MySQL数据导入Elasticsearch"></a>6.2 MySQL数据导入Elasticsearch</h2><p>（1）在logstash-5.6.8安装目录下创建文件夹mysqletc （名称随意）</p>
<p>（2）文件夹下创建mysql.conf  （名称随意） ，内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">  jdbc &#123;</span><br><span class="line">	  # mysql jdbc connection string to our backup databse  后面的test对应mysql中的test数据库</span><br><span class="line">	  jdbc_connection_string =&gt; &quot;jdbc:mysql://127.0.0.1:3306/tensquare_article?characterEncoding=UTF8&quot;</span><br><span class="line">	  # the user we wish to excute our statement as</span><br><span class="line">	  jdbc_user =&gt; &quot;root&quot;</span><br><span class="line">	  jdbc_password =&gt; &quot;123456&quot;</span><br><span class="line">	  # the path to our downloaded jdbc driver  </span><br><span class="line">	  jdbc_driver_library =&gt; &quot;D:/logstash-5.6.8/mysqletc/mysql-connector-java-5.1.46.jar&quot;</span><br><span class="line">	  # the name of the driver class for mysql</span><br><span class="line">	  jdbc_driver_class =&gt; &quot;com.mysql.jdbc.Driver&quot;</span><br><span class="line">	  jdbc_paging_enabled =&gt; &quot;true&quot;</span><br><span class="line">	  jdbc_page_size =&gt; &quot;50000&quot;</span><br><span class="line">	  #以下对应着要执行的sql的绝对路径。</span><br><span class="line">	  statement =&gt; &quot;select id,title,content from tb_article&quot;</span><br><span class="line">	  #定时字段 各字段含义（由左至右）分、时、天、月、年，全部为*默认含义为每分钟都更新</span><br><span class="line">      schedule =&gt; &quot;* * * * *&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  elasticsearch &#123;</span><br><span class="line">	  #ESIP地址与端口</span><br><span class="line">	  hosts =&gt; &quot;localhost:9200&quot; </span><br><span class="line">	  #ES索引名称（自己定义的）</span><br><span class="line">	  index =&gt; &quot;tensquare&quot;</span><br><span class="line">	  #自增ID编号</span><br><span class="line">	  document_id =&gt; &quot;%&#123;id&#125;&quot;</span><br><span class="line">	  document_type =&gt; &quot;article&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  stdout &#123;</span><br><span class="line">      #以JSON格式输出</span><br><span class="line">      codec =&gt; json_lines</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（3）将mysql驱动包mysql-connector-java-5.1.46.jar拷贝至D:/logstash-5.6.8/mysqletc/ 下 。D:/logstash-5.6.8是你的安装目录</p>
<p>（4）命令行下执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logstash -f ../mysqletc/mysql.conf</span><br></pre></td></tr></table></figure>
<p>观察控制台输出，每间隔1分钟就执行一次sql查询。</p>
<p><img src="image/4_12.png" alt></p>
<p>再次刷新elasticsearch-head的数据显示，看是否也更新了数据。</p>
<h1 id="7-Elasticsearch-Docker环境下安装"><a href="#7-Elasticsearch-Docker环境下安装" class="headerlink" title="7 Elasticsearch Docker环境下安装"></a>7 Elasticsearch Docker环境下安装</h1><h2 id="7-1-容器的创建与远程连接"><a href="#7-1-容器的创建与远程连接" class="headerlink" title="7.1 容器的创建与远程连接"></a>7.1 容器的创建与远程连接</h2><p>（1）下载镜像（此步省略）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull elasticsearch:5.6.8</span><br></pre></td></tr></table></figure>
<p>（2）创建容器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -di --name=tensquare_elasticsearch -p 9200:9200 -p 9300:9300 elasticsearch:5.6.8</span><br></pre></td></tr></table></figure>
<p>（3）浏览器输入地址：</p>
<p><a href="http://192.168.184.134:9200/" target="_blank" rel="noopener">http://192.168.184.134:9200/</a>  即可看到如下信息</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span> : <span class="string">"WmBn0H-"</span>,</span><br><span class="line">  <span class="attr">"cluster_name"</span> : <span class="string">"elasticsearch"</span>,</span><br><span class="line">  <span class="attr">"cluster_uuid"</span> : <span class="string">"2g-VVbm9Rty7J4sksZNJEg"</span>,</span><br><span class="line">  <span class="attr">"version"</span> : &#123;</span><br><span class="line">    <span class="attr">"number"</span> : <span class="string">"5.6.8"</span>,</span><br><span class="line">    <span class="attr">"build_hash"</span> : <span class="string">"688ecce"</span>,</span><br><span class="line">    <span class="attr">"build_date"</span> : <span class="string">"2018-02-16T16:46:30.010Z"</span>,</span><br><span class="line">    <span class="attr">"build_snapshot"</span> : <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"lucene_version"</span> : <span class="string">"6.6.1"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"tagline"</span> : <span class="string">"You Know, for Search"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（4）我们修改demo的application.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr"> data:</span></span><br><span class="line"><span class="attr">   elasticsearch:</span></span><br><span class="line"><span class="attr">     cluster-nodes:</span> <span class="number">192.168</span><span class="number">.184</span><span class="number">.135</span><span class="string">:9300</span></span><br></pre></td></tr></table></figure>
<p>（5）运行测试程序，发现会报如下错误</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">NoNodeAvailableException[None of the configured nodes are available: [&#123;#transport#-1&#125;&#123;exvgJLR-RlCNMJy-hzKtnA&#125;&#123;192.168.184.135&#125;&#123;192.168.184.135:9300&#125;]</span><br><span class="line">]</span><br><span class="line">	at org.elasticsearch.client.transport.TransportClientNodesService.ensureNodesAreAvailable(TransportClientNodesService.java:347)</span><br><span class="line">	at org.elasticsearch.client.transport.TransportClientNodesService.execute(TransportClientNodesService.java:245)</span><br><span class="line">	at org.elasticsearch.client.transport.TransportProxyClient.execute(TransportProxyClient.java:59)</span><br></pre></td></tr></table></figure>
<p>这是因为elasticsearch从5版本以后默认不开启远程连接，需要修改配置文件</p>
<p>（6）我们进入容器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it tensquare_elasticsearch  /bin/bash</span><br></pre></td></tr></table></figure>
<p>此时，我们看到elasticsearch所在的目录为/usr/share/elasticsearch  ,进入config看到了配置文件</p>
<p>elasticsearch.yml</p>
<p>我们通过vi命令编辑此文件，尴尬的是容器并没有vi命令 ，咋办？我们需要以文件挂载的方式创建容器才行，这样我们就可以通过修改宿主机中的某个文件来实现对容器内配置文件的修改</p>
<p>（7）拷贝配置文件到宿主机  </p>
<p>首先退出容器，然后执行命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker cp tensquare_elasticsearch:/usr/share/elasticsearch/config/elasticsearch.yml /usr/share/elasticsearch.yml</span><br></pre></td></tr></table></figure>
<p>（8）停止和删除原来创建的容器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker stop tensquare_elasticsearch </span><br><span class="line">docker rm  tensquare_elasticsearch</span><br></pre></td></tr></table></figure>
<p>（9）重新执行创建容器命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -di --name=tensquare_elasticsearch -p 9200:9200 -p 9300:9300 -v /usr/share/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml elasticsearch:5.6.8</span><br></pre></td></tr></table></figure>
<p>（10）修改/usr/share/elasticsearch.yml   将<code>transport.host: 0.0.0.0</code>前的#去掉后保存文件退出。其作用是允许任何ip地址访问elasticsearch  .开发测试阶段可以这么做，生产环境下指定具体的IP </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">将transport.host: 0.0.0.0前的#去掉后保存文件退出</span><br></pre></td></tr></table></figure>
<p>（11）修改/usr/share/elasticsearch.yml ,添加允许跨域配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http.cors.enabled: true</span><br><span class="line">http.cors.allow-origin: &quot;*&quot;</span><br></pre></td></tr></table></figure>
<p>（12）重启启动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker restart tensquare_elasticsearch</span><br></pre></td></tr></table></figure>
<p>重启后发现重启启动失败了，这时什么原因呢？这与我们刚才修改的配置有关，因为elasticsearch在启动的时候会进行一些检查，比如最多打开的文件的个数以及虚拟内存区域数量等等，如果你放开了此配置，意味着需要打开更多的文件以及虚拟内存，所以我们还需要系统调优。</p>
<p>（13）系统调优</p>
<p>我们一共需要修改两处</p>
<p>修改/etc/security/limits.conf  ，追加内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">* soft nofile 65536</span><br><span class="line">* hard nofile 65536</span><br></pre></td></tr></table></figure>
<p>nofile是单个进程允许打开的最大文件个数     soft nofile 是软限制  hard nofile是硬限制</p>
<p>修改/etc/sysctl.conf，追加内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vm.max_map_count=655360</span><br></pre></td></tr></table></figure>
<p>限制一个进程可以拥有的VMA(虚拟内存区域)的数量</p>
<p>执行下面命令    修改内核参数马上生效</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl -p</span><br></pre></td></tr></table></figure>
<p>（14）重新启动虚拟机，再次启动容器，发现已经可以启动并远程访问</p>
<h2 id="7-2-IK分词器安装"><a href="#7-2-IK分词器安装" class="headerlink" title="7.2 IK分词器安装"></a>7.2 IK分词器安装</h2><p>（1）快捷键alt+p进入sftp , 将ik文件夹上传至宿主机</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sftp&gt; put -r d:\setup\ik</span><br></pre></td></tr></table></figure>
<p>（2）在宿主机中将ik文件夹拷贝到容器内 /usr/share/elasticsearch/plugins 目录下。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker cp ik tensquare_elasticsearch:/usr/share/elasticsearch/plugins/</span><br></pre></td></tr></table></figure>
<p>（3）重新启动，即可加载IK分词器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker restart tensquare_elasticsearch</span><br></pre></td></tr></table></figure>
<h2 id="7-3-HEAD插件安装"><a href="#7-3-HEAD插件安装" class="headerlink" title="7.3 HEAD插件安装"></a>7.3 HEAD插件安装</h2><p>（1）重新启动elasticseach容器</p>
<p>（2）下载head镜像（此步省略）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull mobz/elasticsearch‐head:5</span><br></pre></td></tr></table></figure>
<p>（3）创建head容器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker pull mobz/elasticsearch‐head:5  --拉取镜像</span><br><span class="line">docker run -di --name=myhead -p 9100:9100 镜像id --创建容器</span><br></pre></td></tr></table></figure>
<h1 id="面试问题总结"><a href="#面试问题总结" class="headerlink" title="面试问题总结"></a>面试问题总结</h1><h2 id="你在项目中如何开发搜索模块"><a href="#你在项目中如何开发搜索模块" class="headerlink" title="你在项目中如何开发搜索模块"></a>你在项目中如何开发搜索模块</h2><p>elasticsearch   Spring DataElasticsearch</p>
<h2 id="你如何实现数据库与索引库的同步？"><a href="#你如何实现数据库与索引库的同步？" class="headerlink" title="你如何实现数据库与索引库的同步？"></a>你如何实现数据库与索引库的同步？</h2><p>十次方项目ELK</p>
<h2 id="你如何实现索引库的分词"><a href="#你如何实现索引库的分词" class="headerlink" title="你如何实现索引库的分词"></a>你如何实现索引库的分词</h2><p>IK    两种算法  最少切分 最细切分</p>
<h2 id="Solr-和Elasticsearch性能区分"><a href="#Solr-和Elasticsearch性能区分" class="headerlink" title="Solr 和Elasticsearch性能区分"></a>Solr 和Elasticsearch性能区分</h2><p><a href="https://www.cnblogs.com/chowmin/articles/4629220.html" target="_blank" rel="noopener">https://www.cnblogs.com/chowmin/articles/4629220.html</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-my-work0 (3)" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/04/20/my-work0 (3)/" class="article-date">
      <time datetime="2019-04-20T14:58:54.570Z" itemprop="datePublished">2019-04-20</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="第3章-文档型数据库MongoDB"><a href="#第3章-文档型数据库MongoDB" class="headerlink" title="第3章-文档型数据库MongoDB"></a>第3章-文档型数据库MongoDB</h1><p>学习目标：</p>
<ul>
<li><p>理解MongoDb的特点和体系结构</p>
</li>
<li><p>掌握常用的MongoDB命令</p>
</li>
<li><p>能够运用Java操作MongoDB</p>
</li>
<li><p>使用SpringDataMongoDB完成吐槽微服务的开发</p>
<p>​</p>
</li>
</ul>
<h1 id="1-MongoDB简介"><a href="#1-MongoDB简介" class="headerlink" title="1 MongoDB简介"></a>1 MongoDB简介</h1><h2 id="1-1-吐槽和评论数据特点分析"><a href="#1-1-吐槽和评论数据特点分析" class="headerlink" title="1.1 吐槽和评论数据特点分析"></a>1.1 吐槽和评论数据特点分析</h2><p>吐槽和评论两项功能存在以下特点：</p>
<p>（1）数据量大</p>
<p>（2）写入操作频繁</p>
<p>（3）价值较低</p>
<p>对于这样的数据，我们更适合使用MongoDB来实现数据的存储</p>
<p>为什么速度快？存取从内存中，最终会写到磁盘中。</p>
<h2 id="1-2-什么是MongoDB"><a href="#1-2-什么是MongoDB" class="headerlink" title="1.2 什么是MongoDB"></a>1.2 什么是MongoDB</h2><p>​    MongoDB 是一个跨平台的，面向文档的数据库，是当前 NoSQL 数据库产品中最热门<br>的一种。它介于关系数据库和非关系数据库之间，是非关系数据库当中功能最丰富，最像关<br>系数据库的产品。它支持的数据结构非常松散，是类似 JSON 的 BSON 格式，因此可以存<br>储比较复杂的数据类型，没有事务、分布式数据库。<br>​    MongoDB 的官方网站地址是：<a href="http://www.mongodb.org/" target="_blank" rel="noopener">http://www.mongodb.org/</a></p>
<p><img src="image\3-1.jpg" alt>  </p>
<h2 id="1-3-MongoDB特点"><a href="#1-3-MongoDB特点" class="headerlink" title="1.3 MongoDB特点"></a>1.3 MongoDB特点</h2><p>​    MongoDB 最大的特点是他支持的查询语言非常强大，其语法有点类似于面向对象的查<br>询语言，几乎可以实现类似关系数据库单表查询的绝大部分功能，而且还支持对数据建立索<br>引。它是一个面向集合的,模式自由的文档型数据库。<br>具体特点总结如下：<br>（1）面向集合存储，易于存储对象类型的数据<br>（2）模式自由<br>（3）支持动态查询<br>（4）支持完全索引，包含内部对象<br>（5）支持复制和故障恢复<br>（6）使用高效的二进制数据存储，包括大型对象（如视频等）<br>（7）自动处理碎片，以支持云计算层次的扩展性<br>（8）支持 Python，PHP，Ruby，Java，C，C#，Javascript，Perl 及 C++语言的驱动程序，<br>社区中也提供了对 Erlang 及.NET 等平台的驱动程序<br>（9） 文件存储格式为 BSON（一种 JSON 的扩展）</p>
<h2 id="1-4-MongoDB体系结构"><a href="#1-4-MongoDB体系结构" class="headerlink" title="1.4 MongoDB体系结构"></a>1.4 MongoDB体系结构</h2><p>MongoDB 的逻辑结构是一种层次结构。主要由：<br>文档(document)、集合(collection)、数据库(database)这三部分组成的。逻辑结构是面向用户的，用户使用 MongoDB 开发应用程序使用的就是逻辑结构。<br>（1）MongoDB 的文档（document），相当于关系数据库中的一行记录。<br>（2）多个文档组成一个集合（collection），相当于关系数据库的表。<br>（3）多个集合（collection），逻辑上组织在一起，就是数据库（database）。<br>（4）一个 MongoDB 实例支持多个数据库（database）。<br>文档(document)、集合(collection)、数据库(database)的层次结构如下图:</p>
<p><img src="image\3-2.jpg" alt>  </p>
<p>下表是MongoDB与MySQL数据库逻辑结构概念的对比</p>
<table>
<thead>
<tr>
<th>MongoDb</th>
<th>关系型数据库Mysql</th>
</tr>
</thead>
<tbody>
<tr>
<td>数据库(databases)</td>
<td>数据库(databases)</td>
</tr>
<tr>
<td>集合(collections)</td>
<td>表(table)</td>
</tr>
<tr>
<td>文档(document)</td>
<td>行(row)</td>
</tr>
</tbody>
</table>
<h2 id="1-5-数据类型"><a href="#1-5-数据类型" class="headerlink" title="1.5 数据类型"></a>1.5 数据类型</h2><p>基本数据类型</p>
<p>null：用于表示空值或者不存在的字段，{“x”:null}</p>
<p>布尔型：布尔类型有两个值true和false，{“x”:true}</p>
<p>数值：shell默认使用64为浮点型数值。{“x”：3.14}或{“x”：3}。对于整型值，可以使用NumberInt（4字节符号整数）或NumberLong（8字节符号整数），{“x”:NumberInt(“3”)}{“x”:NumberLong(“3”)}</p>
<p>字符串：UTF-8字符串都可以表示为字符串类型的数据，{“x”：“呵呵”}</p>
<p>日期：日期被存储为自新纪元依赖经过的毫秒数，不存储时区，{“x”:new Date()}</p>
<p>正则表达式：查询时，使用正则表达式作为限定条件，语法与JavaScript的正则表达式相同，{“x”:/[abc]/}</p>
<p>数组：数据列表或数据集可以表示为数组，{“x”： [“a“，“b”,”c”]}</p>
<p>内嵌文档：文档可以嵌套其他文档，被嵌套的文档作为值来处理，{“x”:{“y”:3 }}</p>
<p>对象Id：对象id是一个12字节的字符串，是文档的唯一标识，{“x”: objectId() }</p>
<p>二进制数据：二进制数据是一个任意字节的字符串。它不能直接在shell中使用。如果要将非utf-字符保存到数据库中，二进制数据是唯一的方式。</p>
<p>代码：查询和文档中可以包括任何JavaScript代码，{“x”:function(){/<em>…</em>/}}</p>
<h1 id="2-走进MongoDB"><a href="#2-走进MongoDB" class="headerlink" title="2 走进MongoDB"></a>2 走进MongoDB</h1><h2 id="2-1-MongoDB安装与启动"><a href="#2-1-MongoDB安装与启动" class="headerlink" title="2.1 MongoDB安装与启动"></a>2.1 MongoDB安装与启动</h2><h3 id="2-1-1-window系统MongoDB安装"><a href="#2-1-1-window系统MongoDB安装" class="headerlink" title="2.1.1 window系统MongoDB安装"></a>2.1.1 window系统MongoDB安装</h3><p><strong>安装</strong></p>
<p>双击“资源\微服务相关\配套软件\mongodb”中的“mongodb-win32-x86_64-2008plus-ssl-3.2.10-signed.msi” 按照提示步骤安装即可。安装完成后，软件会安装在C:\Program Files\MongoDB 目录中。</p>
<p> 我们要启动的服务程序就是C:\Program Files\MongoDB\Server\3.2\bin目录下的mongod.exe，为了方便我们每次启动，我将C:\Program Files\MongoDB\Server\3.2\bin 设置到<strong>环境变量path</strong>中。</p>
<p><strong>启动</strong></p>
<p>（1）首先打开命令提示符，创建一个用于存放数据的目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">md d:\data</span><br></pre></td></tr></table></figure>
<p>（2）启动服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongod --dbpath=d:\data</span><br></pre></td></tr></table></figure>
<p>我们在启动信息中可以看到，mongoDB的默认端口是27017</p>
<p>如果我们想改变默认的启动端口，可以通过–port来指定端口 </p>
<p>在命令提示符输入以下命令即可完成登陆</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongo</span><br></pre></td></tr></table></figure>
<p>退出mongodb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exit</span><br></pre></td></tr></table></figure>
<h3 id="1-5-2-Docker-环境下MongoDB安装"><a href="#1-5-2-Docker-环境下MongoDB安装" class="headerlink" title="1.5.2 Docker 环境下MongoDB安装"></a>1.5.2 Docker 环境下MongoDB安装</h3><p>在宿主机创建mongo容器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -di --name=tensquare_mongo -p 27017:27017 mongo</span><br></pre></td></tr></table></figure>
<p>远程登陆</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongo 192.168.184.134</span><br></pre></td></tr></table></figure>
<p>以吐槽表为例讲解MongoDB常用命令</p>
<table>
<thead>
<tr>
<th>吐槽表</th>
<th>spit</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>字段名称</td>
<td>字段含义</td>
<td>字段类型</td>
<td>备注</td>
</tr>
<tr>
<td>_id</td>
<td>ID</td>
<td>文本</td>
<td></td>
</tr>
<tr>
<td>content</td>
<td>吐槽内容</td>
<td>文本</td>
<td></td>
</tr>
<tr>
<td>publishtime</td>
<td>发布日期</td>
<td>日期</td>
<td></td>
</tr>
<tr>
<td>userid</td>
<td>发布人ID</td>
<td>文本</td>
<td></td>
</tr>
<tr>
<td>nickname</td>
<td>发布人昵称</td>
<td>文本</td>
<td></td>
</tr>
<tr>
<td>visits</td>
<td>浏览量</td>
<td>整型</td>
<td></td>
</tr>
<tr>
<td>thumbup</td>
<td>点赞数</td>
<td>整型</td>
<td></td>
</tr>
<tr>
<td>share</td>
<td>分享数</td>
<td>整型</td>
<td></td>
</tr>
<tr>
<td>comment</td>
<td>回复数</td>
<td>整型</td>
<td></td>
</tr>
<tr>
<td>state</td>
<td>是否可见</td>
<td>文本</td>
<td></td>
</tr>
<tr>
<td>parentid</td>
<td>上级ID</td>
<td>文本</td>
</tr>
</tbody>
</table>
<h2 id="2-2-常用命令"><a href="#2-2-常用命令" class="headerlink" title="2.2 常用命令"></a>2.2 常用命令</h2><h3 id="2-2-1-选择和创建数据库"><a href="#2-2-1-选择和创建数据库" class="headerlink" title="2.2.1 选择和创建数据库"></a>2.2.1 选择和创建数据库</h3><p>选择和创建数据库的语法格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">use 数据库名称</span><br></pre></td></tr></table></figure>
<p>如果数据库不存在则自动创建</p>
<p>以下语句创建spit数据库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">use spitdb</span><br></pre></td></tr></table></figure>
<h3 id="2-2-2-插入与查询文档"><a href="#2-2-2-插入与查询文档" class="headerlink" title="2.2.2 插入与查询文档"></a>2.2.2 插入与查询文档</h3><p>插入文档的语法格式：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.集合名称.insert(数据);</span><br></pre></td></tr></table></figure>
<p>我们这里可以插入以下测试数据：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.spit.insert(&#123;content:"听说十次方课程很给力呀",userid:"1011",nickname:"小雅",visits:NumberInt(902)&#125;)</span><br></pre></td></tr></table></figure>
<p>查询集合的语法格式：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.集合名称.find()</span><br></pre></td></tr></table></figure>
<p>如果我们要查询spit集合的所有文档，我们输入以下命令</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.spit.find()</span><br></pre></td></tr></table></figure>
<p>这里你会发现每条文档会有一个叫_id的字段，这个相当于我们原来关系数据库中表的主键，当你在插入文档记录时没有指定该字段，MongoDB会自动创建，其类型是ObjectID类型。如果我们在插入文档记录时指定该字段也可以，其类型可以是ObjectID类型，也可以是MongoDB支持的任意类型。</p>
<p>输入以下测试语句:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.spit.insert(&#123;_id:"1",content:"我还是没有想明白到底为啥出错",userid:"1012",nickname:"小明",visits:NumberInt(2020)&#125;);</span><br><span class="line">db.spit.insert(&#123;_id:"2",content:"加班到半夜",userid:"1013",nickname:"凯撒",visits:NumberInt(1023)&#125;);</span><br><span class="line">db.spit.insert(&#123;_id:"3",content:"手机流量超了咋办？",userid:"1013",nickname:"凯撒",visits:NumberInt(111)&#125;);</span><br><span class="line">db.spit.insert(&#123;_id:"4",content:"坚持就是胜利",userid:"1014",nickname:"诺诺",visits:NumberInt(1223)&#125;);</span><br></pre></td></tr></table></figure>
<p>如果我想按一定条件来查询，比如我想查询userid为1013的记录，怎么办？很简单！只要在find()中添加参数即可，参数也是json格式，如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.spit.find(&#123;userid:'1013'&#125;)</span><br></pre></td></tr></table></figure>
<p>如果你只需要返回符合条件的第一条数据，我们可以使用findOne命令来实现</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.spit.findOne(&#123;userid:'1013'&#125;)</span><br></pre></td></tr></table></figure>
<p>如果你想返回指定条数的记录，可以在find方法后调用limit来返回结果，例如：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.spit.find().limit(3)</span><br></pre></td></tr></table></figure>
<h3 id="2-2-3-修改与删除文档"><a href="#2-2-3-修改与删除文档" class="headerlink" title="2.2.3 修改与删除文档"></a>2.2.3 修改与删除文档</h3><p>修改文档的语法结构：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.集合名称.update(条件,修改后的数据)</span><br></pre></td></tr></table></figure>
<p>如果我们想修改_id为1的记录，浏览量为1000，输入以下语句：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.spit.update(&#123;_id:"1"&#125;,&#123;visits:NumberInt(1000)&#125;)</span><br></pre></td></tr></table></figure>
<p>执行后，我们会发现，这条文档除了visits字段其它字段都不见了，为了解决这个问题，我们需要使用修改器$set来实现，命令如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.spit.update(&#123;_id:"2"&#125;,&#123;$set:&#123;visits:NumberInt(2000)&#125;&#125;)</span><br></pre></td></tr></table></figure>
<p>这样就OK啦。</p>
<p>删除文档的语法结构：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.集合名称.remove(条件)</span><br></pre></td></tr></table></figure>
<p>以下语句可以将数据全部删除，请<strong>慎用</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.spit.remove(&#123;&#125;)</span><br></pre></td></tr></table></figure>
<p>如果删除visits=1000的记录，输入以下语句</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.spit.remove(&#123;visits:1000&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="2-2-4-统计条数"><a href="#2-2-4-统计条数" class="headerlink" title="2.2.4 统计条数"></a>2.2.4 统计条数</h3><p>统计记录条件使用count()方法。以下语句统计spit集合的记录数</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.spit.count()</span><br></pre></td></tr></table></figure>
<p>如果按条件统计 ，例如：统计userid为1013的记录条数</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.spit.count(&#123;userid:"1013"&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="2-2-5-模糊查询"><a href="#2-2-5-模糊查询" class="headerlink" title="2.2.5 模糊查询"></a>2.2.5 模糊查询</h3><p>MongoDB的模糊查询是通过正则表达式的方式实现的。格式为：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/模糊查询字符串/</span><br></pre></td></tr></table></figure>
<p>例如，我要查询吐槽内容包含“流量”的所有文档，代码如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.spit.find(&#123;content:/流量/&#125;)</span><br></pre></td></tr></table></figure>
<p>如果要查询吐槽内容中以“加班”开头的，代码如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.spit.find(&#123;content:/^加班/&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="2-2-6-大于-小于-不等于"><a href="#2-2-6-大于-小于-不等于" class="headerlink" title="2.2.6 大于 小于 不等于"></a>2.2.6 大于 小于 不等于</h3><p>&lt;, &lt;=, &gt;, &gt;= 这个操作符也是很常用的，格式如下:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.集合名称.find(&#123; "field" : &#123; $gt: value &#125;&#125;) // 大于: field &gt; value</span><br><span class="line">db.集合名称.find(&#123; "field" : &#123; $lt: value &#125;&#125;) // 小于: field &lt; value</span><br><span class="line">db.集合名称.find(&#123; "field" : &#123; $gte: value &#125;&#125;) // 大于等于: field &gt;= value</span><br><span class="line">db.集合名称.find(&#123; "field" : &#123; $lte: value &#125;&#125;) // 小于等于: field &lt;= value</span><br><span class="line">db.集合名称.find(&#123; "field" : &#123; $ne: value &#125;&#125;) // 不等于: field != value</span><br></pre></td></tr></table></figure>
<p>示例：查询吐槽浏览量大于1000的记录</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.spit.find(&#123;visits:&#123;$gt:1000&#125;&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="2-2-7-包含与不包含"><a href="#2-2-7-包含与不包含" class="headerlink" title="2.2.7 包含与不包含"></a>2.2.7 包含与不包含</h3><p>包含使用$in操作符。</p>
<p>示例：查询吐槽集合中userid字段包含1013和1014的文档</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.spit.find(&#123;userid:&#123;$in:["1013","1014"]&#125;&#125;)</span><br></pre></td></tr></table></figure>
<p> 不包含使用$nin操作符。</p>
<p>示例：查询吐槽集合中userid字段不包含1013和1014的文档</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.spit.find(&#123;userid:&#123;$nin:["1013","1014"]&#125;&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="2-2-8-条件连接"><a href="#2-2-8-条件连接" class="headerlink" title="2.2.8 条件连接"></a>2.2.8 条件连接</h3><p>我们如果需要查询同时满足两个以上条件，需要使用$and操作符将条件进行关联。（相当于SQL的and）</p>
<p>格式为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$and:[ &#123;  &#125;,&#123;  &#125;,&#123; &#125; ]</span><br></pre></td></tr></table></figure>
<p>示例：查询吐槽集合中visits大于等于1000 并且小于2000的文档</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.spit.find(&#123;$and:[ &#123;visits:&#123;$gte:1000&#125;&#125; ,&#123;visits:&#123;$lt:2000&#125; &#125;]&#125;)</span><br></pre></td></tr></table></figure>
<p>如果两个以上条件之间是或者的关系，我们使用$or操作符进行关联，与前面$and的使用方式相同</p>
<p>格式为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$or:[ &#123;  &#125;,&#123;  &#125;,&#123;   &#125; ]</span><br></pre></td></tr></table></figure>
<p>示例：查询吐槽集合中userid为1013，或者浏览量小于2000的文档记录</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.spit.find(&#123;$or:[ &#123;userid:"1013"&#125; ,&#123;visits:&#123;$lt:2000&#125; &#125;]&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="2-2-9-列值增长"><a href="#2-2-9-列值增长" class="headerlink" title="2.2.9 列值增长"></a>2.2.9 列值增长</h3><p>如果我们想实现对某列值在原有值的基础上进行增加或减少，可以使用$inc运算符来实现</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.spit.update(&#123;_id:"2"&#125;,&#123;$inc:&#123;visits:NumberInt(1)&#125;&#125;  )</span><br></pre></td></tr></table></figure>
<h1 id="3-Java操作MongoDB"><a href="#3-Java操作MongoDB" class="headerlink" title="3 Java操作MongoDB"></a>3 Java操作MongoDB</h1><h2 id="3-1-mongodb-driver"><a href="#3-1-mongodb-driver" class="headerlink" title="3.1 mongodb-driver"></a>3.1 mongodb-driver</h2><p>mongodb-driver是mongo官方推出的java连接mongoDB的驱动包，相当于JDBC驱动。我们通过一个入门的案例来了解mongodb-driver的基本使用</p>
<h3 id="3-1-1-查询全部记录"><a href="#3-1-1-查询全部记录" class="headerlink" title="3.1.1 查询全部记录"></a>3.1.1 查询全部记录</h3><p>（1）创建工程 mongoDemo, 引入依赖 </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mongodb<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mongodb-driver<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.6.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>（2）创建测试类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * MongoDb入门小demo</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MongoDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        MongoClient client=<span class="keyword">new</span> MongoClient(<span class="string">"192.168.184.134"</span>);<span class="comment">//创建连接</span></span><br><span class="line">        MongoDatabase spitdb = client.getDatabase(<span class="string">"spitdb"</span>);<span class="comment">//打开数据库</span></span><br><span class="line">        MongoCollection&lt;Document&gt; spit = spitdb.getCollection(<span class="string">"spit"</span>);<span class="comment">//获取集合</span></span><br><span class="line">        FindIterable&lt;Document&gt; documents = spit.find();<span class="comment">//查询记录获取文档集合</span></span><br><span class="line">        <span class="keyword">for</span>(Document document:documents)&#123; <span class="comment">//</span></span><br><span class="line">            System.out.println(<span class="string">"内容："</span>+  document.getString(<span class="string">"content"</span>));</span><br><span class="line">            System.out.println(<span class="string">"用户ID:"</span>+document.getString(<span class="string">"userid"</span>));</span><br><span class="line">            System.out.println(<span class="string">"浏览量："</span>+document.getInteger(<span class="string">"visits"</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        client.close();<span class="comment">//关闭连接</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-1-2-条件查询"><a href="#3-1-2-条件查询" class="headerlink" title="3.1.2 条件查询"></a>3.1.2 条件查询</h3><p>BasicDBObject对象：表示一个具体的记录，BasicDBObject实现了DBObject，是key-value的数据结构，用起来和HashMap是基本一致的。</p>
<p>（1）查询userid为1013的记录</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MongoDemo1</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        MongoClient client=<span class="keyword">new</span> MongoClient(<span class="string">"192.168.184.134"</span>);<span class="comment">//创建连接</span></span><br><span class="line">        MongoDatabase spitdb = client.getDatabase(<span class="string">"spitdb"</span>);<span class="comment">//打开数据库</span></span><br><span class="line">        MongoCollection&lt;Document&gt; spit = spitdb.getCollection(<span class="string">"spit"</span>);<span class="comment">//获取集合</span></span><br><span class="line">        BasicDBObject bson=<span class="keyword">new</span> BasicDBObject(<span class="string">"userid"</span>,<span class="string">"1013"</span>);<span class="comment">// 构建查询条件</span></span><br><span class="line">        FindIterable&lt;Document&gt; documents = spit.find(bson);<span class="comment">//查询记录获取结果集合</span></span><br><span class="line">        <span class="keyword">for</span>(Document document:documents)&#123; <span class="comment">//</span></span><br><span class="line">            System.out.println(<span class="string">"内容："</span>+  document.getString(<span class="string">"content"</span>));</span><br><span class="line">            System.out.println(<span class="string">"用户ID:"</span>+document.getString(<span class="string">"userid"</span>));</span><br><span class="line">            System.out.println(<span class="string">"浏览量："</span>+document.getInteger(<span class="string">"visits"</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        client.close();<span class="comment">//关闭连接</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（2）查询浏览量大于1000的记录</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MongoDemo2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        MongoClient client=<span class="keyword">new</span> MongoClient(<span class="string">"192.168.184.134"</span>);<span class="comment">//创建连接</span></span><br><span class="line">        MongoDatabase spitdb = client.getDatabase(<span class="string">"spitdb"</span>);<span class="comment">//打开数据库</span></span><br><span class="line">        MongoCollection&lt;Document&gt; spit = spitdb.getCollection(<span class="string">"spit"</span>);<span class="comment">//获取集合</span></span><br><span class="line"></span><br><span class="line">        BasicDBObject bson=<span class="keyword">new</span> BasicDBObject(<span class="string">"visits"</span>,<span class="keyword">new</span> BasicDBObject(<span class="string">"$gt"</span>,<span class="number">1000</span>) );<span class="comment">// 构建查询条件</span></span><br><span class="line">        </span><br><span class="line">        FindIterable&lt;Document&gt; documents = spit.find(bson);<span class="comment">//查询记录获取结果集合</span></span><br><span class="line">        <span class="keyword">for</span>(Document document:documents)&#123; <span class="comment">//</span></span><br><span class="line">            System.out.println(<span class="string">"内容："</span>+  document.getString(<span class="string">"content"</span>));</span><br><span class="line">            System.out.println(<span class="string">"用户ID:"</span>+document.getString(<span class="string">"userid"</span>));</span><br><span class="line">            System.out.println(<span class="string">"浏览量："</span>+document.getInteger(<span class="string">"visits"</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        client.close();<span class="comment">//关闭连接</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-1-3-插入数据"><a href="#3-1-3-插入数据" class="headerlink" title="3.1.3 插入数据"></a>3.1.3 插入数据</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MongoDemo3</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        MongoClient client=<span class="keyword">new</span> MongoClient(<span class="string">"192.168.184.134"</span>);<span class="comment">//创建连接</span></span><br><span class="line">        MongoDatabase spitdb = client.getDatabase(<span class="string">"spitdb"</span>);<span class="comment">//打开数据库</span></span><br><span class="line">        MongoCollection&lt;Document&gt; spit = spitdb.getCollection(<span class="string">"spit"</span>);<span class="comment">//获取集合</span></span><br><span class="line"></span><br><span class="line">        Map&lt;String,Object&gt; map=<span class="keyword">new</span> HashMap();</span><br><span class="line">        map.put(<span class="string">"content"</span>,<span class="string">"我要吐槽"</span>);</span><br><span class="line">        map.put(<span class="string">"userid"</span>,<span class="string">"9999"</span>);</span><br><span class="line">        map.put(<span class="string">"visits"</span>,<span class="number">123</span>);</span><br><span class="line">        map.put(<span class="string">"publishtime"</span>,<span class="keyword">new</span> Date());</span><br><span class="line">        Document document=<span class="keyword">new</span> Document(map);</span><br><span class="line"></span><br><span class="line">        spit.insertOne(document);<span class="comment">//插入数据</span></span><br><span class="line">        client.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-2-SpringDataMongoDB"><a href="#3-2-SpringDataMongoDB" class="headerlink" title="3.2 SpringDataMongoDB"></a>3.2 SpringDataMongoDB</h2><p>SpringData家族成员之一，用于操作MongoDb的持久层框架，封装了底层的mongodb-driver。</p>
<p>官网主页： <a href="https://projects.spring.io/spring-data-mongodb/" target="_blank" rel="noopener">https://projects.spring.io/spring-data-mongodb/</a></p>
<p>我们十次方项目的吐槽微服务就采用SpringDataMongoDB框架</p>
<h1 id="4-吐槽微服务"><a href="#4-吐槽微服务" class="headerlink" title="4 吐槽微服务"></a>4 吐槽微服务</h1><h2 id="4-1-需求分析"><a href="#4-1-需求分析" class="headerlink" title="4.1 需求分析"></a>4.1 需求分析</h2><p>采用SpringDataMongoDB框架实现吐槽微服务的持久层。</p>
<p>实现功能：</p>
<p>（1）基本增删改查API</p>
<p>（2）根据上级ID查询吐槽列表</p>
<p>（3）吐槽点赞</p>
<p>（4）发布吐槽</p>
<h2 id="4-2-代码编写"><a href="#4-2-代码编写" class="headerlink" title="4.2 代码编写"></a>4.2 代码编写</h2><h3 id="4-2-1-模块搭建"><a href="#4-2-1-模块搭建" class="headerlink" title="4.2.1 模块搭建"></a>4.2.1 模块搭建</h3><p>（1）搭建子模块 tensquare_spit  </p>
<p>（2）pom.xml引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-mongodb<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>		</span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.tensquare<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tensquare_common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>（3）创建application.yml </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span> </span><br><span class="line"><span class="attr">  port:</span> <span class="number">9006</span></span><br><span class="line"><span class="attr">spring:</span> </span><br><span class="line"><span class="attr">  application:</span>  </span><br><span class="line"><span class="attr">    name:</span> <span class="string">tensquare-spit</span> <span class="comment">#指定服务名</span></span><br><span class="line"><span class="attr">  data:</span></span><br><span class="line"><span class="attr">    mongodb:</span></span><br><span class="line"><span class="attr">      host:</span> <span class="number">192.168</span><span class="number">.184</span><span class="number">.134</span></span><br><span class="line"><span class="attr">      database:</span> <span class="string">spitdb</span></span><br></pre></td></tr></table></figure>
<p>（4）创建启动类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpitApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		SpringApplication.run(SpitApplication.class, args);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> IdWorker <span class="title">idWorkker</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> IdWorker(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">	&#125;	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-2-2基本增删改查API实现"><a href="#4-2-2基本增删改查API实现" class="headerlink" title="4.2.2基本增删改查API实现"></a>4.2.2基本增删改查API实现</h3><p>（1）创建实体类</p>
<p>创建包com.tensquare.spit，包下建包pojo 用于存放实体类，创建实体类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 吐槽</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Administrator</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Spit</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> String _id;</span><br><span class="line">    <span class="keyword">private</span> String content;</span><br><span class="line">    <span class="keyword">private</span> Date publishtime;</span><br><span class="line">    <span class="keyword">private</span> String userid;</span><br><span class="line">    <span class="keyword">private</span> String nickname;</span><br><span class="line">    <span class="keyword">private</span> Integer visits;</span><br><span class="line">    <span class="keyword">private</span> Integer thumbup;</span><br><span class="line">    <span class="keyword">private</span> Integer share;</span><br><span class="line">    <span class="keyword">private</span> Integer comment;</span><br><span class="line">    <span class="keyword">private</span> String state;</span><br><span class="line">    <span class="keyword">private</span> String parentid;</span><br><span class="line">	<span class="comment">// getter and setter .....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（2）创建数据访问接口</p>
<p>com.tensquare.spit包下创建dao包，包下创建接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 吐槽数据访问层</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Administrator</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SpitDao</span> <span class="keyword">extends</span> <span class="title">MongoRepository</span>&lt;<span class="title">Spit</span>, <span class="title">String</span>&gt;</span>&#123;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（3）创建业务逻辑类</p>
<p>com.tensquare.spit包下创建service包，包下创建类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpitService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> SpitDao spitDao;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> IdWorker idWorker;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 查询全部记录</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> List&lt;Spit&gt; <span class="title">findAll</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> spitDao.findAll();		</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 根据主键查询实体</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Spit <span class="title">findById</span><span class="params">(String id)</span></span>&#123;</span><br><span class="line">		Spit spit = spitDao.findById(id).get();</span><br><span class="line">		<span class="keyword">return</span> spit;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 增加</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> spit</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(Spit spit)</span> </span>&#123;</span><br><span class="line">		spit.set_id(idWorker.nextId()+<span class="string">""</span>); <span class="comment">//主键值</span></span><br><span class="line">		spitDao.save(spit);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 修改</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> spit</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(Spit spit)</span> </span>&#123;</span><br><span class="line">		spitDao.save(spit);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 删除</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteById</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">		spitDao.deleteById(id);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（4）com.tensquare.spit包下创建controller类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@CrossOrigin</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/spit"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpitController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SpitService spitService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询全部数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(method= RequestMethod.GET)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">findAll</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">true</span>, StatusCode.OK,<span class="string">"查询成功"</span>,spitService.findAll());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据ID查询</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value=<span class="string">"/&#123;id&#125;"</span>,method=RequestMethod.GET)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">findOne</span><span class="params">(@PathVariable String id)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">true</span>,StatusCode.OK,<span class="string">"查询成功"</span>,spitService.findById(id));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 增加</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> spit</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(method=RequestMethod.POST)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">add</span><span class="params">(@RequestBody Spit spit  )</span></span>&#123;</span><br><span class="line">        spitService.add(spit);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">true</span>,StatusCode.OK,<span class="string">"增加成功"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修改</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> spit</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value=<span class="string">"/&#123;id&#125;"</span>,method=RequestMethod.PUT)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">update</span><span class="params">(@RequestBody Spit spit,@PathVariable String id )</span></span>&#123;</span><br><span class="line">        spit.set_id(id);</span><br><span class="line">        spitService.update(spit);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">true</span>,StatusCode.OK,<span class="string">"修改成功"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value=<span class="string">"/&#123;id&#125;"</span>,method=RequestMethod.DELETE)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">deleteById</span><span class="params">(@PathVariable String id )</span></span>&#123;</span><br><span class="line">        spitService.deleteById(id);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">true</span>,StatusCode.OK,<span class="string">"删除成功"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-2-3-根据上级ID查询吐槽列表"><a href="#4-2-3-根据上级ID查询吐槽列表" class="headerlink" title="4.2.3 根据上级ID查询吐槽列表"></a>4.2.3 根据上级ID查询吐槽列表</h3><p>（1）SpitDao新增方法定义</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据上级ID查询吐槽列表（分页）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> parentid</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> pageable</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Page&lt;Spit&gt; <span class="title">findByParentid</span><span class="params">(String parentid,Pageable pageable)</span></span>;</span><br></pre></td></tr></table></figure>
<p>（2）SpitService新增方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 根据上级ID查询吐槽列表</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> parentid</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> page</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> size</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Page&lt;Spit&gt; <span class="title">findByParentid</span><span class="params">(String parentid,<span class="keyword">int</span> page, <span class="keyword">int</span> size)</span></span>&#123;</span><br><span class="line">      PageRequest pageRequest = PageRequest.of(page-<span class="number">1</span>, size);</span><br><span class="line">      <span class="keyword">return</span> spitDao.findByParentid(parentid, pageRequest);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>（3）SpitController新增方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据上级ID查询吐槽分页数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> page</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> size</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(value=<span class="string">"/comment/&#123;parentId&#125;/&#123;page&#125;/&#123;size&#125;"</span>,method=RequestMethod.GET)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">findByParentid</span><span class="params">(@PathVariable String parentId,  @PathVariable <span class="keyword">int</span> page,@PathVariable <span class="keyword">int</span> size)</span></span>&#123;</span><br><span class="line">    Page&lt;Spit&gt; pageList = spitService.findByParentid(parentId,page, size);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">true</span>,StatusCode.OK,<span class="string">"查询成功"</span>,<span class="keyword">new</span> PageResult&lt;Spit&gt;(pageList.getTotalElements(), pageList.getContent() ) );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-2-4-吐槽点赞"><a href="#4-2-4-吐槽点赞" class="headerlink" title="4.2.4 吐槽点赞"></a>4.2.4 吐槽点赞</h3><p>我们看一下以下点赞的代码：  SpitService 新增updateThumbup方法  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 点赞</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateThumbup</span><span class="params">(String id)</span></span>&#123;</span><br><span class="line">    Spit spit = spitDao.findById(id).get();</span><br><span class="line">    spit.setThumbup(spit.getThumbup()+<span class="number">1</span>);</span><br><span class="line">    spitDao.save(spit);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上方法虽然实现起来比较简单，但是执行效率并不高，因为我只需要将点赞数加1就可以了，没必要查询出所有字段修改后再更新所有字段。</p>
<p>我们可以使用MongoTemplate类来实现对某列的操作。 </p>
<p>（1）修改SpitService </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> MongoTemplate mongoTemplate;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 点赞</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateThumbup</span><span class="params">(String id)</span></span>&#123;</span><br><span class="line">    Query query=<span class="keyword">new</span> Query();</span><br><span class="line">    query.addCriteria(Criteria.where(<span class="string">"_id"</span>).is(id));</span><br><span class="line">    Update update=<span class="keyword">new</span> Update();</span><br><span class="line">    update.inc(<span class="string">"thumbup"</span>,<span class="number">1</span>);</span><br><span class="line">    mongoTemplate.updateFirst(query,update,<span class="string">"spit"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（2）SpitController新增方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 点赞</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(value=<span class="string">"/thumbup/&#123;id&#125;"</span>,method=RequestMethod.PUT)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">updateThumbup</span><span class="params">(@PathVariable String id)</span></span>&#123;      </span><br><span class="line">    spitService.updateThumbup(id);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">true</span>,StatusCode.OK,<span class="string">"点赞成功"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-2-5-控制不能重复点赞"><a href="#4-2-5-控制不能重复点赞" class="headerlink" title="4.2.5 控制不能重复点赞"></a>4.2.5 控制不能重复点赞</h3><p>我们可以通过redis控制用户不能重复点赞 </p>
<p>（1）首先引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>（2）修改application.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">redis:</span></span><br><span class="line"><span class="attr">  host:</span> <span class="number">192.168</span><span class="number">.184</span><span class="number">.135</span></span><br></pre></td></tr></table></figure>
<p>（3）修改SpitController代码逻辑</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 吐槽点赞</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/thumbup/&#123;id&#125;"</span>, method = RequestMethod.PUT)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">updateThumbup</span><span class="params">(@PathVariable String id)</span></span>&#123;</span><br><span class="line">    <span class="comment">//判断用户是否点过赞</span></span><br><span class="line">    String userid=<span class="string">"2023"</span>;<span class="comment">// 后边我们会修改为当前登陆的用户</span></span><br><span class="line">    <span class="keyword">if</span>(redisTemplate.opsForValue().get(<span class="string">"thumbup_"</span>+userid+<span class="string">"_"</span>+ id)!=<span class="keyword">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">false</span>,StatusCode.REPERROR,<span class="string">"你已经点过赞了"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    spitService.updateThumbup(id);</span><br><span class="line">    redisTemplate.opsForValue().set( <span class="string">"thumbup_"</span>+userid+<span class="string">"_"</span>+ id,<span class="string">"1"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">true</span>,StatusCode.OK,<span class="string">"点赞成功"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-2-6-发布吐槽"><a href="#4-2-6-发布吐槽" class="headerlink" title="4.2.6 发布吐槽"></a>4.2.6 发布吐槽</h3><p>修改SpitService的add方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 发布吐槽（或吐槽评论）</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> spit</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(Spit spit)</span></span>&#123;</span><br><span class="line">     spit.set_id( idWorker.nextId()+<span class="string">""</span> );</span><br><span class="line">     spit.setPublishtime(<span class="keyword">new</span> Date());<span class="comment">//发布日期</span></span><br><span class="line">     spit.setVisits(<span class="number">0</span>);<span class="comment">//浏览量</span></span><br><span class="line">     spit.setShare(<span class="number">0</span>);<span class="comment">//分享数</span></span><br><span class="line">     spit.setThumbup(<span class="number">0</span>);<span class="comment">//点赞数</span></span><br><span class="line">     spit.setComment(<span class="number">0</span>);<span class="comment">//回复数</span></span><br><span class="line">     spit.setState(<span class="string">"1"</span>);<span class="comment">//状态</span></span><br><span class="line">     <span class="keyword">if</span>(spit.getParentid()!=<span class="keyword">null</span> &amp;&amp; !<span class="string">""</span>.equals(spit.getParentid()))&#123;<span class="comment">//如果存在上级ID,评论</span></span><br><span class="line">         Query query=<span class="keyword">new</span> Query();</span><br><span class="line">         query.addCriteria(Criteria.where(<span class="string">"_id"</span>).is(spit.getParentid()));</span><br><span class="line">         Update update=<span class="keyword">new</span> Update();</span><br><span class="line">         update.inc(<span class="string">"comment"</span>,<span class="number">1</span>);</span><br><span class="line">         mongoTemplate.updateFirst(query,update,<span class="string">"spit"</span>);</span><br><span class="line">     &#125;</span><br><span class="line">     spitDao.save(spit);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-2-7-增加浏览量与分享数"><a href="#4-2-7-增加浏览量与分享数" class="headerlink" title="4.2.7 增加浏览量与分享数"></a>4.2.7 增加浏览量与分享数</h3><p>学员实现</p>
<h1 id="5-文章评论功能开发"><a href="#5-文章评论功能开发" class="headerlink" title="5 文章评论功能开发"></a>5 文章评论功能开发</h1><h2 id="5-1-表结构分析"><a href="#5-1-表结构分析" class="headerlink" title="5.1 表结构分析"></a>5.1 表结构分析</h2><p>集合结构：</p>
<table>
<thead>
<tr>
<th>专栏文章评论</th>
<th>comment</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>字段名称</td>
<td>字段含义</td>
<td>字段类型</td>
<td>备注</td>
</tr>
<tr>
<td>_id</td>
<td>ID</td>
<td>文本</td>
<td></td>
</tr>
<tr>
<td>articleid</td>
<td>文章ID</td>
<td>文本</td>
<td></td>
</tr>
<tr>
<td>content</td>
<td>评论内容</td>
<td>文本</td>
<td></td>
</tr>
<tr>
<td>userid</td>
<td>评论人ID</td>
<td>文本</td>
<td></td>
</tr>
<tr>
<td>parentid</td>
<td>评论ID</td>
<td>文本</td>
<td>如果为0表示文章的顶级评论</td>
</tr>
<tr>
<td>publishdate</td>
<td>评论日期</td>
<td>日期</td>
</tr>
</tbody>
</table>
<h2 id="5-2-代码编写"><a href="#5-2-代码编写" class="headerlink" title="5.2 代码编写"></a>5.2 代码编写</h2><p>以下功能学员实现</p>
<h3 id="4-2-1-新增评论"><a href="#4-2-1-新增评论" class="headerlink" title="4.2.1 新增评论"></a>4.2.1 新增评论</h3><p>（1）修改tensquare_article工程的pom.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-mongodb<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>（2）修改application.yml ,在spring节点下新增配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">data:</span></span><br><span class="line"><span class="attr">  mongodb:</span></span><br><span class="line"><span class="attr">    host:</span> <span class="number">192.168</span><span class="number">.184</span><span class="number">.134</span></span><br><span class="line"><span class="attr">    database:</span> <span class="string">recruitdb</span></span><br></pre></td></tr></table></figure>
<p>（3）创建实体类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 文章评论（mongoDB）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Administrator</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Comment</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Id</span></span><br><span class="line">	<span class="keyword">private</span> String _id;</span><br><span class="line">	<span class="keyword">private</span> String articleid;</span><br><span class="line">	<span class="keyword">private</span> String content;</span><br><span class="line">	<span class="keyword">private</span> String userid;</span><br><span class="line">	<span class="keyword">private</span> String parentid;</span><br><span class="line">	<span class="keyword">private</span> Date publishdate;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//getter and setter....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（4）创建数据访问接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 评论Dao</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Administrator</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CommentDao</span> <span class="keyword">extends</span> <span class="title">MongoRepository</span>&lt;<span class="title">Comment</span>, <span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（5）创建业务逻辑类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommentService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> CommentDao commentDao;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> IdWorker idWorker;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(Comment comment)</span></span>&#123;</span><br><span class="line">		comment.setId( idWorker.nextId()+<span class="string">""</span>  );</span><br><span class="line">		commentDao.save(comment);		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（6）创建控制器类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@CrossOrigin</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/comment"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommentController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> CommentService commentService;</span><br><span class="line">		</span><br><span class="line">	<span class="meta">@RequestMapping</span>(method= RequestMethod.POST)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Result <span class="title">save</span><span class="params">(@RequestBody Comment comment)</span></span>&#123;</span><br><span class="line">		commentService.add(comment);</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">true</span>, StatusCode.OK, <span class="string">"提交成功 "</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-2-2-根据文章ID查询评论列表"><a href="#4-2-2-根据文章ID查询评论列表" class="headerlink" title="4.2.2 根据文章ID查询评论列表"></a>4.2.2 根据文章ID查询评论列表</h3><p>（1）CommentDao新增方法定义</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据文章ID查询评论列表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> articleid</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Comment&gt; <span class="title">findByArticleid</span><span class="params">(String articleid)</span></span>;</span><br></pre></td></tr></table></figure>
<p>（2）CommentService新增方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Comment&gt; <span class="title">findByArticleid</span><span class="params">(String articleid)</span></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> commentDao.findByArticleid(articleid);		</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（3）CommentController新增方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value=<span class="string">"/article/&#123;articleid&#125;"</span>,method= RequestMethod.GET)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">findByArticleid</span><span class="params">(@PathVariable String articleid)</span></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">true</span>, StatusCode.OK, <span class="string">"查询成功"</span>,  commentService.findByArticleid(articleid));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-2-3-删除评论"><a href="#4-2-3-删除评论" class="headerlink" title="4.2.3 删除评论"></a>4.2.3 删除评论</h3><p>代码略</p>
<h1 id="面试问题总结"><a href="#面试问题总结" class="headerlink" title="面试问题总结"></a>面试问题总结</h1><h2 id="你在项目中有没有使用到mongodb"><a href="#你在项目中有没有使用到mongodb" class="headerlink" title="你在项目中有没有使用到mongodb?"></a>你在项目中有没有使用到mongodb?</h2><h2 id="你的工程是如何操作MongoDB的？"><a href="#你的工程是如何操作MongoDB的？" class="headerlink" title="你的工程是如何操作MongoDB的？"></a>你的工程是如何操作MongoDB的？</h2><p>spring data mongodb</p>
<h2 id="在项目的哪些场景下使用MongoDB"><a href="#在项目的哪些场景下使用MongoDB" class="headerlink" title="在项目的哪些场景下使用MongoDB ?"></a>在项目的哪些场景下使用MongoDB ?</h2><p>吐槽 、文章评论、日志</p>
<h2 id="为什么在吐槽和文章评论中使用Mongodb而不使用mysql"><a href="#为什么在吐槽和文章评论中使用Mongodb而不使用mysql" class="headerlink" title="为什么在吐槽和文章评论中使用Mongodb而不使用mysql?"></a>为什么在吐槽和文章评论中使用Mongodb而不使用mysql?</h2><p>吐槽和评论都是数据量较大且价值较低的数据，为了减轻mysql的压力，我们使用mongodb</p>
<h2 id="MongoDB优点缺点？不支持事务。"><a href="#MongoDB优点缺点？不支持事务。" class="headerlink" title="MongoDB优点缺点？不支持事务。"></a>MongoDB优点缺点？不支持事务。</h2>
      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-my-work0 (2)" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/04/20/my-work0 (2)/" class="article-date">
      <time datetime="2019-04-20T14:58:54.534Z" itemprop="datePublished">2019-04-20</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="第2章-查询与缓存"><a href="#第2章-查询与缓存" class="headerlink" title="第2章-查询与缓存"></a>第2章-查询与缓存</h1><p>学习目标：</p>
<ul>
<li><p>基础微服务-Specification条件查询</p>
</li>
<li><p>招聘微服务开发-方法名称规则查询</p>
</li>
<li>问答微服务开发-自定义语句查询</li>
<li>文章微服务开发-通过@Query注解完成修改操作</li>
<li>缓存处理：spring data redis</li>
</ul>
<h1 id="1-基础微服务-条件查询"><a href="#1-基础微服务-条件查询" class="headerlink" title="1 基础微服务-条件查询"></a>1 基础微服务-条件查询</h1><h2 id="1-1-标签-条件查询"><a href="#1-1-标签-条件查询" class="headerlink" title="1.1 标签-条件查询"></a>1.1 标签-条件查询</h2><p>POST  /label/search  根据条件查询标签列表</p>
<p>（1）修改LabelService ,增加方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 构建查询条件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> searchMap</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Specification&lt;Label&gt; <span class="title">createSpecification</span><span class="params">(Map searchMap)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Specification&lt;Label&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Predicate <span class="title">toPredicate</span><span class="params">(Root&lt;Label&gt; root, CriteriaQuery&lt;?&gt; criteriaQuery, CriteriaBuilder cb)</span> </span>&#123;</span><br><span class="line">            List&lt;Predicate&gt; predicateList=<span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            <span class="keyword">if</span>(searchMap.get(<span class="string">"labelname"</span>)!=<span class="keyword">null</span> &amp;&amp; !<span class="string">""</span>.equals(searchMap.get(<span class="string">"labelname"</span>)))&#123;</span><br><span class="line">                predicateList.add(cb.like( root.get(<span class="string">"labelname"</span>).as(String.class), <span class="string">"%"</span>+(String)searchMap.get(<span class="string">"labelname"</span>)+<span class="string">"%"</span>  ) );</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(searchMap.get(<span class="string">"state"</span>)!=<span class="keyword">null</span> &amp;&amp; !<span class="string">""</span>.equals(searchMap.get(<span class="string">"state"</span>)))&#123;</span><br><span class="line">                predicateList.add(cb.equal( root.get(<span class="string">"state"</span>).as(String.class), (String)searchMap.get(<span class="string">"state"</span>) ) );</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(searchMap.get(<span class="string">"recommend"</span>)!=<span class="keyword">null</span> &amp;&amp; !<span class="string">""</span>.equals(searchMap.get(<span class="string">"recommend"</span>)))&#123;</span><br><span class="line">                predicateList.add(cb.equal( root.get(<span class="string">"recommend"</span>).as(String.class), (String)searchMap.get(<span class="string">"recommend"</span>) ) );</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> cb.and( predicateList.toArray( <span class="keyword">new</span> Predicate[predicateList.size()]) );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 条件查询</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> searchMap</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Label&gt; <span class="title">findSearch</span><span class="params">(Map searchMap)</span></span>&#123;</span><br><span class="line">    Specification specification= createSpecification(searchMap);</span><br><span class="line">    <span class="keyword">return</span> labelDao.findAll( specification);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（2）修改LabelController,增加方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据条件查询</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> searchMap</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(value=<span class="string">"/search"</span>,method = RequestMethod.POST)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Result&lt;List&gt; <span class="title">findSearch</span><span class="params">( @RequestBody Map searchMap)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Result&lt;&gt;(<span class="keyword">true</span>,StatusCode.OK,<span class="string">"查询成功"</span>,labelService.findSearch(searchMap));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="1-2-带分页的条件查询"><a href="#1-2-带分页的条件查询" class="headerlink" title="1.2 带分页的条件查询"></a>1.2 带分页的条件查询</h2><p>（1）修改LabelService，增加方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 分页条件查询</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> searchMap</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> page</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> size</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Page&lt;Label&gt; <span class="title">findSearch</span><span class="params">(Map searchMap,<span class="keyword">int</span> page,<span class="keyword">int</span> size)</span></span>&#123;</span><br><span class="line">    Specification specification= createSpecification(searchMap);</span><br><span class="line">    PageRequest pageRequest=PageRequest.of(page-<span class="number">1</span>,size);</span><br><span class="line">    <span class="keyword">return</span> labelDao.findAll( specification ,pageRequest);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（2）修改LabelController，增加方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  条件+分页查询</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> searchMap</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> page</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> size</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(value=<span class="string">"/search/&#123;page&#125;/&#123;size&#125;"</span>,method = RequestMethod.POST)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Result&lt;List&gt; <span class="title">findSearch</span><span class="params">( @RequestBody Map searchMap ,@PathVariable <span class="keyword">int</span> page,@PathVariable <span class="keyword">int</span> size )</span></span>&#123;</span><br><span class="line">    Page pageList= labelService.findSearch(searchMap,page,size);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">true</span>,StatusCode.OK,<span class="string">"查询成功"</span>,<span class="keyword">new</span> PageResult&lt;&gt;(pageList.getTotalElements(),pageList.getContent()  ));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="2-招聘微服务开发"><a href="#2-招聘微服务开发" class="headerlink" title="2 招聘微服务开发"></a>2 招聘微服务开发</h1><h2 id="2-1-表结构分析"><a href="#2-1-表结构分析" class="headerlink" title="2.1 表结构分析"></a>2.1 表结构分析</h2><p>招聘微服务主要有两块：企业信息和招聘信息</p>
<table>
<thead>
<tr>
<th>企业表</th>
<th>tb_enterprise</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>字段名称</td>
<td>字段含义</td>
<td>字段类型</td>
<td>备注</td>
</tr>
<tr>
<td>id</td>
<td>ID</td>
<td>文本</td>
<td></td>
</tr>
<tr>
<td>name</td>
<td>企业名称</td>
<td>文本</td>
<td></td>
</tr>
<tr>
<td>summary</td>
<td>企业简介</td>
<td>文本</td>
<td></td>
</tr>
<tr>
<td>address</td>
<td>企业地址</td>
<td>文本</td>
<td></td>
</tr>
<tr>
<td>labels</td>
<td>标签列表</td>
<td>文本</td>
<td>用逗号分隔</td>
</tr>
<tr>
<td>coordinate</td>
<td>企业位置坐标</td>
<td>文本</td>
<td>经度，纬度</td>
</tr>
<tr>
<td>ishot</td>
<td>是否热门</td>
<td>文本</td>
<td>0：非热门 1：热门</td>
</tr>
<tr>
<td>logo</td>
<td>LOGO</td>
<td>文本</td>
<td></td>
</tr>
<tr>
<td>jobcount</td>
<td>职位数</td>
<td>数字</td>
<td></td>
</tr>
<tr>
<td>url</td>
<td>URL</td>
<td>文本</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>招聘信息表</th>
<th>tb_recruit</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>字段名称</td>
<td>字段含义</td>
<td>字段类型</td>
<td>备注</td>
</tr>
<tr>
<td>id</td>
<td>ID</td>
<td>文本</td>
<td></td>
</tr>
<tr>
<td>jobname</td>
<td>招聘职位</td>
<td>文本</td>
<td></td>
</tr>
<tr>
<td>salary</td>
<td>薪资范围</td>
<td>文本</td>
<td></td>
</tr>
<tr>
<td>condition</td>
<td>经验要求</td>
<td>文本</td>
<td></td>
</tr>
<tr>
<td>education</td>
<td>学历要求</td>
<td>文本</td>
<td></td>
</tr>
<tr>
<td>type</td>
<td>任职方式</td>
<td>文本</td>
<td></td>
</tr>
<tr>
<td>address</td>
<td>办公地址</td>
<td>文本</td>
<td></td>
</tr>
<tr>
<td>eid</td>
<td>企业ID</td>
<td>文本</td>
<td></td>
</tr>
<tr>
<td>createtime</td>
<td>发布日期</td>
<td>日期</td>
<td></td>
</tr>
<tr>
<td>state</td>
<td>状态</td>
<td>文本</td>
<td>0：关闭 1:开启  2：推荐</td>
</tr>
<tr>
<td>url</td>
<td>原网址</td>
<td>文本</td>
<td></td>
</tr>
<tr>
<td>label</td>
<td>标签</td>
<td>文本</td>
<td></td>
</tr>
<tr>
<td>content1</td>
<td>职位描述</td>
<td>文本</td>
<td></td>
</tr>
<tr>
<td>content2</td>
<td>职位要求</td>
<td>文本</td>
</tr>
</tbody>
</table>
<h2 id="2-2-代码生成"><a href="#2-2-代码生成" class="headerlink" title="2.2 代码生成"></a>2.2 代码生成</h2><p>我们使用开源代码生成器codeutil 来完成代码的生成  </p>
<p>开源网址： <a href="https://gitee.com/chuanzhiliubei/codeutil" target="_blank" rel="noopener">https://gitee.com/chuanzhiliubei/codeutil</a></p>
<p>（1）使用代码生成器生成招聘微服务代码 tensquare_recruit</p>
<p>（2）拷贝到当前工程，并在父工程引入。</p>
<p>（3）修改Application类名称为RecruitApplication</p>
<p>（4）修改application.yml 中的端口为9002  ,url 为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jdbc:mysql://192.168.184.134:3306/tensquare_recruit?characterEncoding=UTF8</span><br></pre></td></tr></table></figure>
<p>（5）进行浏览器测试</p>
<h2 id="2-3-代码编写"><a href="#2-3-代码编写" class="headerlink" title="2.3 代码编写"></a>2.3 代码编写</h2><h3 id="2-3-1-热门企业列表"><a href="#2-3-1-热门企业列表" class="headerlink" title="2.3.1 热门企业列表"></a>2.3.1 热门企业列表</h3><p>需求：查询企业表ishot字段为1的记录</p>
<p>（1）EnterpriseDao新增方法定义</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据热门状态获取企业列表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ishot</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Enterprise&gt; <span class="title">findByIshot</span><span class="params">(String ishot)</span></span>;</span><br></pre></td></tr></table></figure>
<p>（2）EnterpriseService新增方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 热门企业列表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Enterprise&gt; <span class="title">hotlist</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> enterpriseDao.findByIshot(<span class="string">"1"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（3）EnterpriseController新增方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询热门企业</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(value=<span class="string">"/search/hotlist"</span>,method=RequestMethod.GET)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">hotlist</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">true</span>, StatusCode.OK, <span class="string">"查询成功"</span>, enterpriseService.hotlist());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（4）测试  <a href="http://localhost:9002/enterprise/search/hotlist" target="_blank" rel="noopener">http://localhost:9002/enterprise/search/hotlist</a>   </p>
<h3 id="2-3-2-推荐职位列表"><a href="#2-3-2-推荐职位列表" class="headerlink" title="2.3.2 推荐职位列表"></a>2.3.2 推荐职位列表</h3><p>需求分析：查询状态为2并以创建日期降序排序，查询前4条记录</p>
<p>（1）在RecruitDao新增方法定义</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 查询最新职位列表(按创建日期降序排序)</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Recruit&gt; <span class="title">findTop4ByStateOrderByCreatetimeDesc</span><span class="params">(String state)</span></span>;</span><br></pre></td></tr></table></figure>
<p>（2）RecruitService新增方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据状态查询</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> state</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Recruit&gt; <span class="title">findTop4ByStateOrderByCreatetimeDesc</span><span class="params">(String state)</span></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> recruitDao.findTop4ByStateOrderByCreatetimeDesc(state);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（3）RecruitController新增方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value=<span class="string">"/search/recommend"</span>,method= RequestMethod.GET)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">recommend</span><span class="params">()</span></span>&#123;</span><br><span class="line">	List&lt;Recruit&gt; list = recruitService.findTop4ByStateOrderByCreatetimeDesc(<span class="string">"2"</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">true</span>,StatusCode.OK,<span class="string">"查询成功"</span>,list);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（4）测试： <a href="http://localhost:9002/recruit/search/recommend" target="_blank" rel="noopener">http://localhost:9002/recruit/search/recommend</a> </p>
<h3 id="2-3-3-最新职位列表"><a href="#2-3-3-最新职位列表" class="headerlink" title="2.3.3 最新职位列表"></a>2.3.3 最新职位列表</h3><p>需求分析：查询状态不为0并以创建日期降序排序，查询前12条记录</p>
<p>（1）在RecruitDao新增方法定义</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 最新职位列表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> state</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Recruit&gt; <span class="title">findTop12ByStateNotOrderByCreatetimeDesc</span><span class="params">(String state)</span></span>;</span><br></pre></td></tr></table></figure>
<p>（2）RecruitService新增方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 最新职位列表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Recruit&gt; <span class="title">newlist</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> recruitDao.findTop12ByStateNotOrderByCreatetimeDesc(<span class="string">"0"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（3）RecruitController新增方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 最新职位列表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(value=<span class="string">"/search/newlist"</span>,method= RequestMethod.GET)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">newlist</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">true</span>,StatusCode.OK,<span class="string">"查询成功"</span>,recruitService.newlist());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（4）测试：<a href="http://localhost:9002/recruit/search/newlist" target="_blank" rel="noopener">http://localhost:9002/recruit/search/newlist</a></p>
<h1 id="3-问答微服务开发"><a href="#3-问答微服务开发" class="headerlink" title="3 问答微服务开发"></a>3 问答微服务开发</h1><h2 id="3-1-表结构分析"><a href="#3-1-表结构分析" class="headerlink" title="3.1 表结构分析"></a>3.1 表结构分析</h2><table>
<thead>
<tr>
<th>问题表</th>
<th>tb_problem</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>字段名称</td>
<td>字段含义</td>
<td>字段类型</td>
<td>备注</td>
</tr>
<tr>
<td>id</td>
<td>ID</td>
<td>文本</td>
<td></td>
</tr>
<tr>
<td>title</td>
<td>问题标题</td>
<td>文本</td>
<td></td>
</tr>
<tr>
<td>content</td>
<td>问题内容</td>
<td>文本</td>
<td></td>
</tr>
<tr>
<td>createtime</td>
<td>发布日期</td>
<td>日期</td>
<td></td>
</tr>
<tr>
<td>updatetime</td>
<td>更新日期</td>
<td>日期</td>
<td></td>
</tr>
<tr>
<td>userid</td>
<td>发布人ID</td>
<td>文本</td>
<td></td>
</tr>
<tr>
<td>nickname</td>
<td>发布人昵称</td>
<td>文本</td>
<td></td>
</tr>
<tr>
<td>visits</td>
<td>浏览量</td>
<td>整型</td>
<td></td>
</tr>
<tr>
<td>thumbup</td>
<td>点赞数</td>
<td>整型</td>
<td></td>
</tr>
<tr>
<td>reply</td>
<td>回复数</td>
<td>整型</td>
<td></td>
</tr>
<tr>
<td>solve</td>
<td>是否解决</td>
<td>文本</td>
<td></td>
</tr>
<tr>
<td>replyname</td>
<td>最新回复人</td>
<td>文本</td>
<td></td>
</tr>
<tr>
<td>replytime</td>
<td>最新回复时间</td>
<td>日期</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>回答表</th>
<th>tb_reply</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>字段名称</td>
<td>字段含义</td>
<td>字段类型</td>
<td>备注</td>
</tr>
<tr>
<td>id</td>
<td>ID</td>
<td>文本</td>
<td></td>
</tr>
<tr>
<td>problemid</td>
<td>问题ID</td>
<td>文本</td>
<td></td>
</tr>
<tr>
<td>content</td>
<td>回答内容</td>
<td>文本</td>
<td></td>
</tr>
<tr>
<td>createtime</td>
<td>回答日期</td>
<td>日期</td>
<td></td>
</tr>
<tr>
<td>updatetime</td>
<td>更新日期</td>
<td>日期</td>
<td></td>
</tr>
<tr>
<td>userid</td>
<td>回答人ID</td>
<td>文本</td>
<td></td>
</tr>
<tr>
<td>nickname</td>
<td>回答人昵称</td>
<td>文本</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>问答标签中间表</th>
<th>tb_pl</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>字段名称</td>
<td>字段含义</td>
<td>字段类型</td>
<td>备注</td>
</tr>
<tr>
<td>problemid</td>
<td>问题ID</td>
<td>文本</td>
<td></td>
</tr>
<tr>
<td>labelid</td>
<td>标签ID</td>
<td>文本</td>
</tr>
</tbody>
</table>
<h2 id="3-2-代码生成"><a href="#3-2-代码生成" class="headerlink" title="3.2 代码生成"></a>3.2 代码生成</h2><p>（1）使用代码生成器生成招聘微服务代码 tensquare_qa</p>
<p>（2）拷贝到当前工程，并在父工程引入。</p>
<p>（3）修改Application类名称为QaApplication</p>
<p>（4）修改application.yml 中的端口为9003  ,url 为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jdbc:mysql://192.168.184.134:3306/tensquare_qa?characterEncoding=UTF8</span><br></pre></td></tr></table></figure>
<p>（5）进行浏览器测试</p>
<h2 id="3-3-代码编写"><a href="#3-3-代码编写" class="headerlink" title="3.3 代码编写"></a>3.3 代码编写</h2><h3 id="3-3-1-最新回答列表"><a href="#3-3-1-最新回答列表" class="headerlink" title="3.3.1 最新回答列表"></a>3.3.1 最新回答列表</h3><p>需求分析：最新回复的问题显示在上方， 按回复时间降序排序。</p>
<p>（1）创建中间表pl的实体类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.tensquare.qa.pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.Entity;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.Id;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.Table;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 中间表 tb_pl 问题和标签中间表</span></span><br><span class="line"><span class="comment"> * problemid + lableid ==&gt;联合主键</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table</span>(name = <span class="string">"tb_pl"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Pl</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> String problemid;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> String labelid;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getLabelid</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> labelid;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLabelid</span><span class="params">(String labelid)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.labelid = labelid;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getProblemid</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> problemid;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setProblemid</span><span class="params">(String problemid)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.problemid = problemid;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（2）ProblemDao新增方法定义</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据标签ID查询最新问题列表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> labelId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> pageable</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Query</span>(<span class="string">"select p from Problem p where id in( select problemid from Pl where labelid=?1 ) order by replytime desc"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Page&lt;Problem&gt; <span class="title">findNewListByLabelId</span><span class="params">(String labelId, Pageable pageable)</span></span>;</span><br></pre></td></tr></table></figure>
<p>（3）ProblemService新增方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据标签ID查询问题列表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> lableId 标签ID</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> page 页码</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> size 页大小</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Page&lt;Problem&gt; <span class="title">findNewListByLabelId</span><span class="params">(String lableId,<span class="keyword">int</span> page, <span class="keyword">int</span> size)</span> </span>&#123;</span><br><span class="line">	PageRequest pageRequest = PageRequest.of(page-<span class="number">1</span>, size);</span><br><span class="line">	<span class="keyword">return</span>  problemDao.findNewListByLabelId(lableId,pageRequest);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（4）ProblemController新增方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据标签ID查询最新问题列表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> labelid</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(value=<span class="string">"/newlist/&#123;labelid&#125;/&#123;page&#125;/&#123;size&#125;"</span>,method=RequestMethod.GET)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">findNewListByLabelId</span><span class="params">(@PathVariable String labelid,@PathVariable <span class="keyword">int</span> page,@PathVariable <span class="keyword">int</span> size )</span></span>&#123;</span><br><span class="line">	Page&lt;Problem&gt; pageList = problemService.findNewListByLabelId(labelid, page, size);</span><br><span class="line">	PageResult&lt;Problem&gt; pageResult = <span class="keyword">new</span> PageResult&lt;&gt;(pageList.getTotalElements(), pageList.getContent());</span><br><span class="line">	<span class="keyword">return</span>  <span class="keyword">new</span> Result(<span class="keyword">true</span>, StatusCode.OK, <span class="string">"查询成功"</span>,pageResult);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-3-2-热门问答列表"><a href="#3-3-2-热门问答列表" class="headerlink" title="3.3.2 热门问答列表"></a>3.3.2 热门问答列表</h3><p> 需求分析：按回复数降序排序</p>
<p>（1）ProblemDao新增方法定义</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据标签ID查询热门问题列表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> labelId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> pageable</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Query</span>(<span class="string">"select p from Problem p where id in( select problemid from Pl where labelid=?1 ) order by reply desc"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Page&lt;Problem&gt; <span class="title">findHotListByLabelId</span><span class="params">(String labelId, Pageable pageable)</span></span>;</span><br></pre></td></tr></table></figure>
<p>（2）ProblemService新增方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据标签ID查询热门问题列表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> lableId 标签ID</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> page 页码</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> size 页大小</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Page&lt;Problem&gt; <span class="title">findHotListByLabelId</span><span class="params">(String lableId,<span class="keyword">int</span> page, <span class="keyword">int</span> size)</span> </span>&#123;</span><br><span class="line">	PageRequest pageRequest = PageRequest.of(page-<span class="number">1</span>, size);</span><br><span class="line">	<span class="keyword">return</span>  problemDao.findHotListByLabelId(lableId,pageRequest);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（3）ProblemController新增方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据标签ID查询热门问题列表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> labelid</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(value=<span class="string">"/hotlist/&#123;labelid&#125;/&#123;page&#125;/&#123;size&#125;"</span>,method=RequestMethod.GET)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">findHotListByLabelId</span><span class="params">(@PathVariable String labelid,@PathVariable <span class="keyword">int</span> page,@PathVariable <span class="keyword">int</span> size )</span></span>&#123;</span><br><span class="line">	Page&lt;Problem&gt; pageList = problemService.findHotListByLabelId(labelid, page, size);</span><br><span class="line">	PageResult&lt;Problem&gt; pageResult = <span class="keyword">new</span> PageResult&lt;&gt;(pageList.getTotalElements(), pageList.getContent());</span><br><span class="line">	<span class="keyword">return</span>  <span class="keyword">new</span> Result(<span class="keyword">true</span>, StatusCode.OK, <span class="string">"查询成功"</span>,pageResult);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-3-3-等待回答列表"><a href="#3-3-3-等待回答列表" class="headerlink" title="3.3.3 等待回答列表"></a>3.3.3 等待回答列表</h3><p>（1）ProblemDao新增方法定义</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据标签ID查询等待回答列表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> labelId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> pageable</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Query</span>(<span class="string">"select p from Problem p where id in( select problemid from Pl where labelid=?1 ) and reply=0 order by createtime desc"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Page&lt;Problem&gt; <span class="title">findWaitListByLabelId</span><span class="params">(String labelId, Pageable pageable)</span></span>;</span><br></pre></td></tr></table></figure>
<p>（2）ProblemService新增方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据标签ID查询等待回答列表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> lableId 标签ID</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> page 页码</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> size 页大小</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Page&lt;Problem&gt; <span class="title">findWaitListByLabelId</span><span class="params">(String lableId,<span class="keyword">int</span> page, <span class="keyword">int</span> size)</span> </span>&#123;</span><br><span class="line">	PageRequest pageRequest = PageRequest.of(page-<span class="number">1</span>, size);</span><br><span class="line">	<span class="keyword">return</span>  problemDao.findWaitListByLabelId(lableId,pageRequest);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（3）ProblemController新增方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据标签ID查询等待回答列表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> labelid</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(value=<span class="string">"/waitlist/&#123;labelid&#125;/&#123;page&#125;/&#123;size&#125;"</span>,method=RequestMethod.GET)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">findWaitListByLabelId</span><span class="params">(@PathVariable String labelid,@PathVariable <span class="keyword">int</span> page,@PathVariable <span class="keyword">int</span> size )</span></span>&#123;</span><br><span class="line">	Page&lt;Problem&gt; pageList = problemService.findWaitListByLabelId(labelid, page, size);</span><br><span class="line">	PageResult&lt;Problem&gt; pageResult = <span class="keyword">new</span> PageResult&lt;&gt;(pageList.getTotalElements(), pageList.getContent());</span><br><span class="line">	<span class="keyword">return</span>  <span class="keyword">new</span> Result(<span class="keyword">true</span>, StatusCode.OK, <span class="string">"查询成功"</span>,pageResult);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="4-文章微服务开发"><a href="#4-文章微服务开发" class="headerlink" title="4 文章微服务开发"></a>4 文章微服务开发</h1><h2 id="4-1-表结构分析"><a href="#4-1-表结构分析" class="headerlink" title="4.1 表结构分析"></a>4.1 表结构分析</h2><table>
<thead>
<tr>
<th>文章表</th>
<th>tb_article</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>字段名称</td>
<td>字段含义</td>
<td>字段类型</td>
<td>备注</td>
</tr>
<tr>
<td>id</td>
<td>ID</td>
<td>文本</td>
<td></td>
</tr>
<tr>
<td>columnid</td>
<td>专栏ID</td>
<td>文本</td>
<td></td>
</tr>
<tr>
<td>userid</td>
<td>用户ID</td>
<td>文本</td>
<td></td>
</tr>
<tr>
<td>title</td>
<td>文章标题</td>
<td>文本</td>
<td></td>
</tr>
<tr>
<td>content</td>
<td>文章内容</td>
<td>文本</td>
<td></td>
</tr>
<tr>
<td>image</td>
<td>文章封面</td>
<td>文本</td>
<td></td>
</tr>
<tr>
<td>createtime</td>
<td>发表日期</td>
<td>日期</td>
<td></td>
</tr>
<tr>
<td>updatetime</td>
<td>修改日期</td>
<td>日期</td>
<td></td>
</tr>
<tr>
<td>ispublic</td>
<td>是否公开</td>
<td>文本</td>
<td>0：不公开 1：公开</td>
</tr>
<tr>
<td>istop</td>
<td>是否置顶</td>
<td>文本</td>
<td>0：不置顶 1：置顶</td>
</tr>
<tr>
<td>visits</td>
<td>浏览量</td>
<td>整型</td>
<td></td>
</tr>
<tr>
<td>thumbup</td>
<td>点赞数</td>
<td>整型</td>
<td></td>
</tr>
<tr>
<td>comment</td>
<td>评论数</td>
<td>整型</td>
<td></td>
</tr>
<tr>
<td>state</td>
<td>审核状态</td>
<td>文本</td>
<td>0：未审核  1：已审核</td>
</tr>
<tr>
<td>channelid</td>
<td>所属频道</td>
<td>整型</td>
<td>关联频道表ID</td>
</tr>
<tr>
<td>url</td>
<td>URL地址</td>
<td>文本</td>
<td></td>
</tr>
<tr>
<td>type</td>
<td>文章类型</td>
<td>文本</td>
<td>0：分享 1：专栏</td>
</tr>
</tbody>
</table>
<h2 id="4-2-代码生成"><a href="#4-2-代码生成" class="headerlink" title="4.2 代码生成"></a>4.2 代码生成</h2><p>（1）使用代码生成器生成招聘微服务代码  tensquare_article</p>
<p>（2）拷贝到当前工程，并在父工程引入。</p>
<p>（3）修改Application类名称为ArticleApplication</p>
<p>（4）修改application.yml 中的端口为9004  ,url 为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jdbc:mysql://192.168.184.134:3306/tensquare_article?characterEncoding=UTF8</span><br></pre></td></tr></table></figure>
<p>（5）进行浏览器测试</p>
<h2 id="4-3-代码编写"><a href="#4-3-代码编写" class="headerlink" title="4.3 代码编写"></a>4.3 代码编写</h2><h3 id="4-3-1-文章审核"><a href="#4-3-1-文章审核" class="headerlink" title="4.3.1 文章审核"></a>4.3.1 文章审核</h3><p>（1）ArticleDao新增方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 审核</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Modifying</span></span><br><span class="line"><span class="meta">@Query</span>(<span class="string">"update Article set state='1' where id=?1"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">examine</span><span class="params">(String id)</span></span>;</span><br></pre></td></tr></table></figure>
<p>（2）ArticleService新增方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 文章审核</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">examine</span><span class="params">(String id)</span></span>&#123;</span><br><span class="line">	articleDao.examine(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（3）ArticleController新增方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> 	<span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 审核</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(value=<span class="string">"/examine/&#123;id&#125;"</span>,method=RequestMethod.PUT)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">examine</span><span class="params">(@PathVariable String id)</span></span>&#123;</span><br><span class="line">	articleService.examine(id);</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">true</span>, StatusCode.OK, <span class="string">"审核成功！"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-3-2-文章点赞"><a href="#4-3-2-文章点赞" class="headerlink" title="4.3.2 文章点赞"></a>4.3.2 文章点赞</h3><p>（1）ArticleDao新增方法定义</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 点赞</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Modifying</span></span><br><span class="line"><span class="meta">@Query</span>(<span class="string">"update Article a set thumbup=thumbup+1 where id=?1"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">updateThumbup</span><span class="params">(String id)</span></span>;</span><br></pre></td></tr></table></figure>
<p>（2）ArticleService新增方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 点赞</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id 文章ID</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">updateThumbup</span><span class="params">(String id)</span></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> articleDao.updateThumbup(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（3）ArticleController新增方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 点赞</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(value=<span class="string">"/thumbup/&#123;id&#125;"</span>,method=RequestMethod.PUT)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">updateThumbup</span><span class="params">(@PathVariable String id)</span></span>&#123;</span><br><span class="line">	articleService.updateThumbup(id);</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">true</span>, StatusCode.OK,<span class="string">"点赞成功"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="5-缓存处理"><a href="#5-缓存处理" class="headerlink" title="5 缓存处理"></a>5 缓存处理</h1><p>为了提高查询的性能，我们通常采用Redis缓存解决。</p>
<h2 id="5-1-Redis环境搭建"><a href="#5-1-Redis环境搭建" class="headerlink" title="5.1 Redis环境搭建"></a>5.1 Redis环境搭建</h2><p>我们以docker的形式搭建Redis 服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -di --name=tensquare_redis -p 6379:6379 redis</span><br></pre></td></tr></table></figure>
<h2 id="5-2-SpringDataRedis"><a href="#5-2-SpringDataRedis" class="headerlink" title="5.2 SpringDataRedis"></a>5.2 SpringDataRedis</h2><p>Spring-data-redis是spring data大家族的一部分，提供了在spring应用中通过简单的配置访问redis服务，对reids底层开发包(Jedis,  JRedis, and RJC)进行了高度封装，RedisTemplate提供了redis各种操作。</p>
<h2 id="5-3-实现文章的缓存处理"><a href="#5-3-实现文章的缓存处理" class="headerlink" title="5.3 实现文章的缓存处理"></a>5.3 实现文章的缓存处理</h2><h3 id="5-3-1-查询文章操作缓存"><a href="#5-3-1-查询文章操作缓存" class="headerlink" title="5.3.1 查询文章操作缓存"></a>5.3.1 查询文章操作缓存</h3><p>（1）在tensquare_article 的pom.xml引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>（2）修改application.yml  ,在spring节点下添加配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis:</span><br><span class="line">  host: 192.168.184.134</span><br></pre></td></tr></table></figure>
<p>（3）修改ArticleService 引入RedisTemplate，并修改findById方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据ID查询实体</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Article <span class="title">findById</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//从缓存中提取</span></span><br><span class="line">	Article article=(Article)redisTemplate.opsForValue().get(<span class="string">"article_"</span>+id);</span><br><span class="line">	<span class="comment">// 如果缓存没有则到数据库查询并放入缓存</span></span><br><span class="line">	<span class="keyword">if</span>(article==<span class="keyword">null</span>) &#123;</span><br><span class="line">		article = articleDao.findById(id).get();</span><br><span class="line">		redisTemplate.opsForValue().set(<span class="string">"article_"</span> + id, article);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> article;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样在查询的时候，就会自动将文章放入缓存</p>
<h3 id="5-3-2-修改或删除后清除缓存"><a href="#5-3-2-修改或删除后清除缓存" class="headerlink" title="5.3.2 修改或删除后清除缓存"></a>5.3.2 修改或删除后清除缓存</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 修改</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> article</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(Article article)</span> </span>&#123;</span><br><span class="line">	redisTemplate.delete( <span class="string">"article_"</span> + article.getId() );<span class="comment">//删除缓存</span></span><br><span class="line">	articleDao.save(article);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 删除</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteById</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">	redisTemplate.delete( <span class="string">"article_"</span> + id );<span class="comment">//删除缓存</span></span><br><span class="line">	articleDao.deleteById(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-3-3-缓存过期处理"><a href="#5-3-3-缓存过期处理" class="headerlink" title="5.3.3 缓存过期处理"></a>5.3.3 缓存过期处理</h3><p>修改findById方法  ，设置1天的过期时间</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redisTemplate.opsForValue().set(<span class="string">"article_"</span> + id, article,<span class="number">1</span>, TimeUnit.DAYS);</span><br></pre></td></tr></table></figure>
<p>为了方便测试，我们可以把过期时间改为10秒，然后观察控制台输出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redisTemplate.opsForValue().set(<span class="string">"article_"</span> + id, article,<span class="number">10</span>, TimeUnit.SECONDS);</span><br></pre></td></tr></table></figure>
<h2 id="5-4-Spring-Cache"><a href="#5-4-Spring-Cache" class="headerlink" title="5.4 Spring Cache"></a>5.4 Spring Cache</h2><p>Spring Cache使用方法与Spring对事务管理的配置相似。Spring Cache的核心就是对某个方法进行缓存，其实质就是缓存该方法的返回结果，并把方法参数和结果用键值对的方式存放到缓存中，当再次调用该方法使用相应的参数时，就会直接从缓存里面取出指定的结果进行返回。</p>
<p>常用注解：</p>
<p>@Cacheable——-使用这个注解的方法在执行后会缓存其返回结果。</p>
<p>@CacheEvict——–使用这个注解的方法在其执行前或执行后移除Spring Cache中的某些元素。</p>
<h2 id="5-5-活动信息的缓存"><a href="#5-5-活动信息的缓存" class="headerlink" title="5.5 活动信息的缓存"></a>5.5 活动信息的缓存</h2><h3 id="5-5-1-活动微服务代码生成"><a href="#5-5-1-活动微服务代码生成" class="headerlink" title="5.5.1 活动微服务代码生成"></a>5.5.1 活动微服务代码生成</h3><p>（1）使用代码生成器生成活动微服务代码 tensquare_gathering</p>
<p>（2）拷贝到当前工程，并在父工程引入。</p>
<p>（3）修改Application类名称为GatheringApplication</p>
<p>（4）修改application.yml 中的端口为9005  ,url 为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jdbc:mysql://192.168.184.134:3306/tensquare_gathering?characterEncoding=UTF8</span><br></pre></td></tr></table></figure>
<p>（5）进行浏览器测试</p>
<h3 id="5-5-2-活动详情的缓存实现"><a href="#5-5-2-活动详情的缓存实现" class="headerlink" title="5.5.2 活动详情的缓存实现"></a>5.5.2 活动详情的缓存实现</h3><p>步骤：</p>
<p>（1）我们在tensquare_gathering的pom.xml中引入SpringDataRedis</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>（2）修改application.yml , 在spring节点下添加redis 配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">redis:</span></span><br><span class="line"><span class="attr">  host:</span> <span class="number">192.168</span><span class="number">.184</span><span class="number">.134</span></span><br></pre></td></tr></table></figure>
<p>（3）为GatheringApplication添加@EnableCaching开启缓存支持</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableCaching</span></span><br></pre></td></tr></table></figure>
<p>（4）在GatheringService的findById方法添加缓存注解，这样当此方法第一次运行，在缓存中没有找到对应的value和key，则将查询结果放入缓存。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据ID查询实体</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Cacheable</span>(value=<span class="string">"gathering"</span>,key=<span class="string">"#id"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Gathering <span class="title">findById</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> gatheringDao.findById(id).get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（5）当我们对数据进行删改的时候，需要更新缓存。其实更新缓存也就是清除缓存，因为清除缓存后，用户再次调用查询方法无法提取缓存会重新查找数据库中的记录并放入缓存。</p>
<p>在GatheringService的update、deleteById方法上添加清除缓存的注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 修改</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> gathering</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@CacheEvict</span>(value=<span class="string">"gathering"</span>,key=<span class="string">"#gathering.id"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(Gathering gathering)</span> </span>&#123;</span><br><span class="line">	gatheringDao.save(gathering);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 删除</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@CacheEvict</span>(value=<span class="string">"gathering"</span>,key=<span class="string">"#id"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteById</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">	gatheringDao.deleteById(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="面试问题总结"><a href="#面试问题总结" class="headerlink" title="面试问题总结"></a>面试问题总结</h1><h2 id="在项目中哪部分业务用到缓存"><a href="#在项目中哪部分业务用到缓存" class="headerlink" title="在项目中哪部分业务用到缓存"></a>在项目中哪部分业务用到缓存</h2><p>文章 活动</p>
<h2 id="你说一下项目中是如何使用缓存的"><a href="#你说一下项目中是如何使用缓存的" class="headerlink" title="你说一下项目中是如何使用缓存的"></a>你说一下项目中是如何使用缓存的</h2><h2 id="说一下如何设置缓存过期时间"><a href="#说一下如何设置缓存过期时间" class="headerlink" title="说一下如何设置缓存过期时间"></a>说一下如何设置缓存过期时间</h2>
      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-hello-world" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/04/20/hello-world/" class="article-date">
      <time datetime="2019-04-20T12:03:12.912Z" itemprop="datePublished">2019-04-20</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/04/20/hello-world/">Hello World</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
  
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                <i class="fa fa-copyright"></i> 
                2016-2019 Single Dog
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank" title="快速、简洁且高效的博客框架">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="简而不减 Hexo 双栏博客主题  v3.5">Yelee</a> by MOxFIVE <i class="fa fa-heart animated infinite pulse"></i>
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style="display:none">
                        <span id="site-visit" title="本站到访数"><i class="fa fa-user" aria-hidden="true"></i><span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>| </span>
                
                
                    <span id="busuanzi_container_page_pv" style="display:none">
                        <span id="page-visit" title="本页阅读量"><i class="fa fa-eye animated infinite pulse" aria-hidden="true"></i><span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>
    </div>
    
<script data-main="/js/main.js" src="//cdn.bootcss.com/require.js/2.2.0/require.min.js"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 5;
                var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>





<div class="scroll" id="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" onclick="load$hide();" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    // Open in New Window
    
        var oOpenInNew = {
            
            
            
            
            
            
             archives: ".archive-article-title", 
             miniArchives: "a.post-list-link", 
            
             friends: "#js-friends a", 
             socail: ".social a" 
        }
        for (var x in oOpenInNew) {
            $(oOpenInNew[x]).attr("target", "_blank");
        }
    
</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>